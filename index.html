<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Select + Do</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-up { animation: fadeIn 0.25s ease-out forwards; }
    .pill-selected { background-color: rgb(2 132 199) !important; color: white !important; }
    .btn { @apply rounded-lg font-semibold transition shadow; }
    @media (max-width: 640px){
      .sidebar { width: 100%; max-height: 40vh; }
    }
  </style>
</head>
<body class="h-screen bg-slate-50 text-slate-800 flex flex-col sm:flex-row">

  <!-- Sidebar -->
  <aside class="sidebar sm:w-72 bg-white p-4 sm:p-6 border-b sm:border-b-0 sm:border-r border-slate-200 flex flex-col overflow-y-auto hide-scrollbar shadow-sm">
    <div class="flex items-center justify-between">
      <img src="selectdologo.jpg" alt="Select + Do Logo" class="w-24 sm:w-28 rounded-md mb-3" onerror="this.style.display='none'">
      <!-- Mobile collapse (optional simple toggle) -->
    </div>
    <div class="text-xs text-slate-400">Local session</div>

    <div class="mt-3 grid grid-cols-2 gap-2">
      <button id="openModalBtn" class="bg-sky-600 hover:bg-sky-700 text-white btn py-2.5 px-3 col-span-2 sm:col-span-2">+ Add Task</button>
      <button id="exportBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-800 text-sm py-2 btn">Export</button>
      <label class="bg-slate-100 hover:bg-slate-200 text-slate-800 text-sm py-2 btn cursor-pointer flex items-center justify-center">
        Import
        <input id="importInput" type="file" accept=".json" class="hidden">
      </label>
    </div>

    <!-- Task List -->
    <div id="taskList" class="mt-4 sm:mt-6 flex-grow space-y-4">
      <p class="text-slate-400 text-sm italic text-center">
        Add tasks to see projects here.
      </p>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 max-w-screen-md mx-auto p-4 sm:p-8 overflow-y-auto hide-scrollbar w-full">

    <!-- Last task prompt -->
    <div id="lastTaskBar" class="hidden bg-emerald-50 border border-emerald-200 text-emerald-800 text-sm px-4 py-3 rounded-lg flex items-center justify-between animate-fade-in-up">
      <div>
        Last time you worked on: <span class="font-semibold" id="lastTaskName"></span>.
        <span class="text-emerald-700">Continue?</span>
      </div>
      <div class="flex gap-2">
        <button id="continueLastTaskBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold text-xs px-3 py-1.5 rounded-md">Start</button>
        <button id="dismissLastTaskBtn" class="text-emerald-700 hover:text-emerald-900 text-xs">Dismiss</button>
      </div>
    </div>

    <!-- Filters -->
    <section class="space-y-3 mt-4">
      <h2 class="text-lg sm:text-2xl font-semibold text-slate-800 tracking-tight">How much time do you have?</h2>
      <div id="timeButtons" class="flex flex-wrap gap-2">
        <!-- injected -->
      </div>
    </section>

    <section class="space-y-3">
      <h2 class="text-lg sm:text-2xl font-semibold text-slate-800 tracking-tight">Select a category (Tags)</h2>
      <div id="tagCloud" class="flex flex-wrap gap-2">
        <!-- injected -->
      </div>
    </section>

    <section class="space-y-3">
      <h2 class="text-lg sm:text-2xl font-semibold text-slate-800 tracking-tight">Choose a context</h2>
      <div id="contextButtons" class="flex flex-wrap gap-2">
        <!-- injected -->
      </div>
    </section>

    <!-- Selected Filters Summary -->
    <div id="selectedFiltersSummary" class="bg-sky-50 p-4 rounded-lg shadow text-sm text-sky-900 hidden">
      <p class="font-semibold mb-2">Current Filters</p>
      <div id="summaryContent" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- Actions -->
    <div class="sticky bottom-0 sm:static bg-slate-50 pt-3 sm:pt-0">
      <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
        <button id="suggestTask" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 rounded-lg shadow transition">Suggest a Task</button>
        <button id="surpriseMeBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow transition">Surprise Me!</button>
        <button id="clearFiltersBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-medium py-3 px-6 rounded-lg transition">Clear Filters</button>
      </div>
    </div>

    <!-- Suggestions -->
    <div id="suggestedTasks" class="space-y-4 mt-4">
      <p class="text-slate-500 text-center py-4">
        No tasks found matching your criteria. Try adjusting filters or adding new tasks!
      </p>
    </div>
  </main>

  <!-- Focus Mode (Full screen) -->
  <div id="focusMode" class="hidden fixed inset-0 bg-white z-50 flex flex-col items-center justify-center text-center p-6">
    <h1 id="focusTaskName" class="text-2xl sm:text-3xl font-bold text-slate-800 mb-4"></h1>
    <div id="focusCountdown" class="text-6xl font-extrabold text-sky-600 mb-6">00:00</div>
    <div class="flex gap-3">
      <button id="pauseBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-6 rounded-lg shadow">Pause</button>
      <button id="stopBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow">Stop</button>
    </div>
  </div>

  <!-- Add/Edit Task Modal -->
  <div id="taskModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-[60] hidden p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md relative animate-fade-in-up">
      <button id="closeModalBtn" class="absolute top-3 right-3 text-slate-400 hover:text-slate-700 text-2xl leading-none">&times;</button>
      <h3 id="modalTitle" class="text-2xl font-bold text-slate-800 mb-4">Add Task</h3>

      <form id="taskForm" class="space-y-5">
        <input type="text" id="project" placeholder="Project (e.g., Work, Home)" required class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">

        <input type="text" id="task" placeholder="Task name (e.g., Clear inbox)" required class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">

        <div>
          <h4 class="text-sm font-semibold text-slate-700 mb-2">Time (minutes)</h4>
          <div id="modalTimeButtons" class="flex flex-wrap gap-2"></div>
        </div>

        <div>
          <h4 class="text-sm font-semibold text-slate-700 mb-2">Tags</h4>
          <div id="modalTags" class="flex flex-wrap gap-2 mb-2"></div>
          <div class="flex gap-2">
            <input type="text" id="newTagInput" placeholder="Add new tag" class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
            <button type="button" id="addTagBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-800 font-medium px-4 rounded-lg">Add</button>
          </div>
        </div>

        <div>
          <h4 class="text-sm font-semibold text-slate-700 mb-2">Priority</h4>
          <select id="priority" required class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white">
            <option value="">Select Priority</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
          </select>
        </div>

        <div>
          <h4 class="text-sm font-semibold text-slate-700 mb-2">Contexts</h4>
          <div id="modalContexts" class="flex flex-wrap gap-2"></div>
        </div>

        <button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-bold w-full py-3 rounded-lg shadow transition">
          Save Task
        </button>
      </form>
    </div>
  </div>

  <script>
    // ========= State =========
    const STORAGE_KEY = 'sdo_tasks_v1';
    const LAST_KEY = 'sdo_last_v1';
    const DEFAULT_CONTEXTS = ['Workday','Evening','Weekend'];
    const TIME_OPTIONS = [5,10,15,20,25,30,45,60];

    const state = {
      tasks: [],                // {id, project, task, time, tag[], priority, context[], createdAt ISO, completedAt ISO|null}
      selectedTime: null,
      selectedTags: [],
      selectedContexts: [],
      selectedModalTime: null,
      selectedModalTags: new Set(),
      selectedModalContexts: new Set(),
      editingTaskId: null,
      countdownInterval: null,
      countdownTime: 0,
      paused: false,
      lastTask: null            // {name, minutes}
    };

    // ========= DOM Refs =========
    const els = {
      // Sidebar
      taskList: document.getElementById('taskList'),
      exportBtn: document.getElementById('exportBtn'),
      importInput: document.getElementById('importInput'),
      openModalBtn: document.getElementById('openModalBtn'),

      // Main
      timeButtonsWrap: document.getElementById('timeButtons'),
      tagCloud: document.getElementById('tagCloud'),
      contextButtonsWrap: document.getElementById('contextButtons'),
      selectedFiltersSummary: document.getElementById('selectedFiltersSummary'),
      summaryContent: document.getElementById('summaryContent'),
      suggestTaskBtn: document.getElementById('suggestTask'),
      surpriseMeBtn: document.getElementById('surpriseMeBtn'),
      clearFiltersBtn: document.getElementById('clearFiltersBtn'),
      suggestedTasks: document.getElementById('suggestedTasks'),

      // Last task bar
      lastTaskBar: document.getElementById('lastTaskBar'),
      lastTaskName: document.getElementById('lastTaskName'),
      continueLastTaskBtn: document.getElementById('continueLastTaskBtn'),
      dismissLastTaskBtn: document.getElementById('dismissLastTaskBtn'),

      // Focus
      focusMode: document.getElementById('focusMode'),
      focusTaskName: document.getElementById('focusTaskName'),
      focusCountdown: document.getElementById('focusCountdown'),
      pauseBtn: document.getElementById('pauseBtn'),
      stopBtn: document.getElementById('stopBtn'),

      // Modal
      taskModal: document.getElementById('taskModal'),
      modalTitle: document.getElementById('modalTitle'),
      closeModalBtn: document.getElementById('closeModalBtn'),
      taskForm: document.getElementById('taskForm'),
      projectInput: document.getElementById('project'),
      taskInput: document.getElementById('task'),
      modalTimeButtons: document.getElementById('modalTimeButtons'),
      modalTags: document.getElementById('modalTags'),
      newTagInput: document.getElementById('newTagInput'),
      addTagBtn: document.getElementById('addTagBtn'),
      prioritySelect: document.getElementById('priority'),
      modalContexts: document.getElementById('modalContexts'),
    };

    // ========= Utils =========
    const uid = () => (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));

    const saveTasks = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state.tasks));
    const loadTasks = () => {
      try { state.tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch { state.tasks = []; }
    };

    const saveLast = (name, minutes) => localStorage.setItem(LAST_KEY, JSON.stringify({name, minutes}));
    const loadLast = () => {
      try { state.lastTask = JSON.parse(localStorage.getItem(LAST_KEY) || 'null'); }
      catch { state.lastTask = null; }
    };

    const pill = (label, selected=false) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = `bg-sky-100 hover:bg-sky-200 text-sky-800 font-medium py-1.5 px-4 rounded-full transition ${selected ? 'pill-selected' : ''}`;
      b.textContent = label;
      return b;
    };

    function groupByProject(tasks) {
      const map = {};
      tasks.forEach(t => {
        const key = t.project || 'General';
        map[key] = map[key] || [];
        map[key].push(t);
      });
      return map;
    }

    // ========= Rendering =========
    function renderTimeButtons() {
      els.timeButtonsWrap.innerHTML = '';
      TIME_OPTIONS.forEach(min => {
        const b = pill(`${min} min`, state.selectedTime === min);
        b.dataset.time = min;
        b.addEventListener('click', () => {
          state.selectedTime = min;
          renderTimeButtons();
          updateFilterSummary();
        });
        els.timeButtonsWrap.appendChild(b);
      });
    }

    function allTagsFromTasks() {
      const set = new Set();
      state.tasks.forEach(t => (t.tag || []).forEach(x => set.add(x)));
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }

    function renderTagCloud() {
      els.tagCloud.innerHTML = '';
      const tags = allTagsFromTasks();
      if (tags.length === 0) {
        const d = document.createElement('div');
        d.className = 'text-slate-400 text-sm italic';
        d.textContent = 'Tags appear here after you add tasks.';
        els.tagCloud.appendChild(d);
        return;
      }
      tags.forEach(tag => {
        const selected = state.selectedTags.includes(tag);
        const b = pill(tag, selected);
        b.addEventListener('click', () => {
          if (selected) state.selectedTags = state.selectedTags.filter(t => t !== tag);
          else state.selectedTags.push(tag);
          renderTagCloud();
          updateFilterSummary();
        });
        els.tagCloud.appendChild(b);
      });
    }

    function renderContextButtons() {
      els.contextButtonsWrap.innerHTML = '';
      DEFAULT_CONTEXTS.forEach(ctx => {
        const selected = state.selectedContexts.includes(ctx);
        const b = pill(ctx, selected);
        b.addEventListener('click', () => {
          if (selected) state.selectedContexts = state.selectedContexts.filter(c => c !== ctx);
          else state.selectedContexts.push(ctx);
          renderContextButtons();
          updateFilterSummary();
        });
        els.contextButtonsWrap.appendChild(b);
      });
    }

    function updateFilterSummary() {
      els.summaryContent.innerHTML = '';
      let any = false;
      if (state.selectedTime) { addSummaryChip(`Time: ${state.selectedTime} min`); any = true; }
      state.selectedTags.forEach(t => { addSummaryChip(`Tag: ${t}`); any = true; });
      state.selectedContexts.forEach(c => { addSummaryChip(`Context: ${c}`); any = true; });
      els.selectedFiltersSummary.classList.toggle('hidden', !any);
    }

    function addSummaryChip(text) {
      const span = document.createElement('span');
      span.className = "bg-sky-200 text-sky-900 text-xs px-3 py-1 rounded-full";
      span.textContent = text;
      els.summaryContent.appendChild(span);
    }

    function renderTasks() {
      const container = els.taskList;
      container.innerHTML = '';

      if (state.tasks.length === 0) {
        container.innerHTML = `<p class="text-slate-400 text-sm italic text-center">No tasks yet. Click “+ Add Task”.</p>`;
        return;
      }

      const projects = groupByProject(state.tasks);
      const projectNames = Object.keys(projects).sort((a,b)=>a.localeCompare(b));

      projectNames.forEach(project => {
        const section = document.createElement('div');
        section.className = 'bg-white border border-slate-200 rounded-lg shadow-sm';

        const header = document.createElement('button');
        header.className = 'w-full text-left px-4 py-3 font-semibold text-slate-800 flex items-center justify-between';
        header.innerHTML = `<span>${project}</span><span class="text-slate-400">▾</span>`;

        const body = document.createElement('div');
        body.className = 'px-4 pb-3 space-y-2';

        // Separate active vs completed
        const active = projects[project].filter(t => !t.completedAt);
        const completed = projects[project].filter(t => t.completedAt);

        // Active first, newest first
        active.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
        // Completed, newest completed first
        completed.sort((a,b)=>new Date(b.completedAt)-new Date(a.completedAt));

        active.forEach(t => body.appendChild(taskCard(t)));

        if (completed.length > 0) {
          const compWrap = document.createElement('div');
          compWrap.className = 'mt-2';
          const compHeader = document.createElement('button');
          compHeader.className = 'text-slate-600 text-sm underline';
          compHeader.textContent = `Completed (${completed.length})`;
          const compList = document.createElement('div');
          compList.className = 'hidden mt-2 space-y-2';
          completed.forEach(t => compList.appendChild(taskCard(t, true)));
          compHeader.addEventListener('click', ()=> compList.classList.toggle('hidden'));
          compWrap.appendChild(compHeader);
          compWrap.appendChild(compList);
          body.appendChild(compWrap);
        }

        header.addEventListener('click', () => body.classList.toggle('hidden'));

        section.appendChild(header);
        section.appendChild(body);
        container.appendChild(section);
      });
    }

    function taskCard(task, isCompleted=false) {
      const li = document.createElement('div');
      li.className = 'bg-slate-50 p-3 rounded-lg text-sm shadow-sm';

      const top = document.createElement('div');
      top.className = 'flex items-start justify-between gap-2';
      top.innerHTML = `
        <div>
          <div class="font-bold text-slate-900">${task.task}</div>
          <div class="text-xs text-slate-600">${task.time} min • 
            <span class="inline-flex items-center gap-1">
              <span class="w-2 h-2 rounded-full ${prioDot(task.priority)}"></span> ${task.priority}
            </span>
          </div>
          <div class="flex flex-wrap gap-1 mt-2">
            ${(task.tag||[]).map(t => `<span class="bg-slate-200 text-slate-700 text-[11px] px-2 py-0.5 rounded-full">${t}</span>`).join('')}
            ${(task.context||[]).map(c => `<span class="bg-slate-200 text-slate-700 text-[11px] px-2 py-0.5 rounded-full">${c}</span>`).join('')}
          </div>
        </div>
      `;
      const btnGroup = document.createElement('div');
      btnGroup.className = 'flex flex-wrap gap-2';

      const startBtn = document.createElement('button');
      startBtn.className = 'bg-sky-600 hover:bg-sky-700 text-white text-xs py-1.5 px-3 rounded-md';
      startBtn.textContent = 'Start';
      startBtn.onclick = () => startFocusTask(task.task, task.time);

      const doneBtn = document.createElement('button');
      doneBtn.className = 'bg-emerald-600 hover:bg-emerald-700 text-white text-xs py-1.5 px-3 rounded-md';
      doneBtn.textContent = isCompleted ? 'Restore' : 'Done';
      doneBtn.onclick = () => toggleComplete(task.id, !isCompleted);

      const editBtn = document.createElement('button');
      editBtn.className = 'bg-slate-200 hover:bg-slate-300 text-slate-800 text-xs py-1.5 px-3 rounded-md';
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => openEdit(task.id);

      const delBtn = document.createElement('button');
      delBtn.className = 'bg-red-500 hover:bg-red-600 text-white text-xs py-1.5 px-3 rounded-md';
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => deleteTask(task.id);

      btnGroup.append(startBtn, doneBtn, editBtn, delBtn);
      top.appendChild(btnGroup);

      li.appendChild(top);
      return li;
    }

    function prioDot(p) {
      return p === 'High' ? 'bg-red-500' : (p === 'Medium' ? 'bg-yellow-500' : 'bg-slate-400');
    }

    // ========= Filters + Suggestions =========
    function clearFilters() {
      state.selectedTime = null;
      state.selectedTags = [];
      state.selectedContexts = [];
      renderTimeButtons();
      renderTagCloud();
      renderContextButtons();
      updateFilterSummary();
      els.suggestedTasks.innerHTML = `<p class="text-slate-500 text-center py-4">No tasks found matching your criteria. Try adjusting filters or adding new tasks!</p>`;
    }

    function filteredTasksForSuggestion() {
      let filtered = [...state.tasks].filter(t => !t.completedAt);
      if (state.selectedContexts.length > 0) {
        filtered = filtered.filter(t => state.selectedContexts.some(ctx => (t.context||[]).includes(ctx)));
      }
      if (state.selectedTags.length > 0) {
        filtered = filtered.filter(t => state.selectedTags.some(tag => (t.tag||[]).map(x=>x.toLowerCase()).includes(tag.toLowerCase())));
      }
      if (state.selectedTime != null) {
        const buffer = 10;
        filtered = filtered.filter(t => t.time >= (state.selectedTime - buffer) && t.time <= (state.selectedTime + buffer));
      }
      // Rank: High > Med > Low, then closest to time, then newest
      const prioRank = { High: 1, Medium: 2, Low: 3 };
      filtered = filtered.map(t => ({...t, timeDiff: state.selectedTime != null ? Math.abs(t.time - state.selectedTime) : 0}));
      filtered.sort((a,b) => {
        if (prioRank[a.priority] !== prioRank[b.priority]) return prioRank[a.priority] - prioRank[b.priority];
        if (state.selectedTime != null && a.timeDiff !== b.timeDiff) return a.timeDiff - b.timeDiff;
        return new Date(b.createdAt) - new Date(a.createdAt);
      });
      return filtered;
    }

    function renderSuggestions() {
      const cand = filteredTasksForSuggestion();
      els.suggestedTasks.innerHTML = '';
      if (cand.length === 0) {
        els.suggestedTasks.innerHTML = `<p class="text-slate-500 text-center py-4">No tasks found matching your criteria. Try adjusting filters or adding new tasks!</p>`;
        return;
      }
      cand.slice(0,3).forEach(task => {
        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition';
        div.innerHTML = `
          <strong class="text-lg text-slate-900">${task.task}</strong>
          <p class="text-sm text-slate-500">${task.project} • ${task.time} min • <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full ${prioDot(task.priority)}"></span>${task.priority}</span></p>
          <div class="flex flex-wrap gap-2 mt-2">
            ${(task.tag||[]).map(t => `<span class="bg-slate-200 text-slate-700 text-xs px-2 py-0.5 rounded-full">${t}</span>`).join('')}
            ${(task.context||[]).map(c => `<span class="bg-slate-200 text-slate-700 text-xs px-2 py-0.5 rounded-full">${c}</span>`).join('')}
          </div>
        `;
        div.onclick = () => startFocusTask(task.task, task.time);
        els.suggestedTasks.appendChild(div);
      });
    }

    // ========= Focus Mode Timer =========
    function startFocusTask(name, minutes) {
      els.focusTaskName.textContent = name;
      state.countdownTime = Math.max(1, Number(minutes) || 1) * 60;
      saveLast(name, minutes);
      showFocus(true);
      state.paused = false;
      els.pauseBtn.textContent = 'Pause';
      if (state.countdownInterval) clearInterval(state.countdownInterval);
      tick(); // draw immediately
      state.countdownInterval = setInterval(() => {
        if (!state.paused) {
          state.countdownTime--;
          tick();
          if (state.countdownTime <= 0) {
            clearInterval(state.countdownInterval);
            alert(`Nice work! "${name}" complete.`);
            showFocus(false);
          }
        }
      }, 1000);
    }

    function tick() {
      const min = Math.floor(state.countdownTime / 60);
      const sec = state.countdownTime % 60;
      els.focusCountdown.textContent = `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    function showFocus(on) {
      els.focusMode.classList.toggle('hidden', !on);
      // Hide background scroll on mobile for immersive focus
      document.documentElement.style.overflow = on ? 'hidden' : '';
      document.body.style.overflow = on ? 'hidden' : '';
    }

    // ========= Modal: Add/Edit =========
    function openAdd() {
      state.editingTaskId = null;
      els.modalTitle.textContent = 'Add Task';
      els.taskForm.reset();
      state.selectedModalTime = null;
      state.selectedModalTags = new Set();
      state.selectedModalContexts = new Set();
      renderModalTimeButtons();
      renderModalTags();
      renderModalContexts();
      els.taskModal.classList.remove('hidden');
    }

    function openEdit(taskId) {
      const t = state.tasks.find(x => x.id === taskId);
      if (!t) return;
      state.editingTaskId = taskId;
      els.modalTitle.textContent = 'Edit Task';
      els.taskModal.classList.remove('hidden');

      els.projectInput.value = t.project || '';
      els.taskInput.value = t.task || '';
      els.prioritySelect.value = t.priority || '';

      state.selectedModalTime = t.time || null;
      state.selectedModalTags = new Set(t.tag || []);
      state.selectedModalContexts = new Set(t.context || []);

      renderModalTimeButtons();
      renderModalTags();
      renderModalContexts();
    }

    function closeModal() {
      els.taskModal.classList.add('hidden');
    }

    function renderModalTimeButtons() {
      els.modalTimeButtons.innerHTML = '';
      TIME_OPTIONS.forEach(min => {
        const b = pill(`${min} min`, state.selectedModalTime === min);
        b.addEventListener('click', () => {
          state.selectedModalTime = min;
          renderModalTimeButtons();
        });
        els.modalTimeButtons.appendChild(b);
      });
    }

    function renderModalTags() {
      els.modalTags.innerHTML = '';
      const tags = Array.from(new Set([...allTagsFromTasks(), ...state.selectedModalTags]));
      tags.sort((a,b)=>a.localeCompare(b));
      tags.forEach(tag => {
        const selected = state.selectedModalTags.has(tag);
        const b = pill(tag, selected);
        b.addEventListener('click', () => {
          if (selected) state.selectedModalTags.delete(tag);
          else state.selectedModalTags.add(tag);
          renderModalTags();
        });
        els.modalTags.appendChild(b);
      });
    }

    function renderModalContexts() {
      els.modalContexts.innerHTML = '';
      DEFAULT_CONTEXTS.forEach(ctx => {
        const selected = state.selectedModalContexts.has(ctx);
        const b = pill(ctx, selected);
        b.addEventListener('click', () => {
          if (selected) state.selectedModalContexts.delete(ctx);
          else state.selectedModalContexts.add(ctx);
          renderModalContexts();
        });
        els.modalContexts.appendChild(b);
      });
    }

    // ========= CRUD =========
    function saveTaskFromForm(e) {
      e.preventDefault();
      const project = els.projectInput.value.trim();
      const taskName = els.taskInput.value.trim();
      const priority = els.prioritySelect.value;
      if (!project) return alert('Please enter a project.');
      if (!taskName) return alert('Please enter a task name.');
      if (!state.selectedModalTime) return alert('Please choose a time.');
      if (state.selectedModalTags.size === 0) return alert('Please select at least one tag.');
      if (!priority) return alert('Please select a priority.');
      if (state.selectedModalContexts.size === 0) return alert('Please select at least one context.');

      const data = {
        project,
        task: taskName,
        time: state.selectedModalTime,
        tag: Array.from(state.selectedModalTags),
        priority,
        context: Array.from(state.selectedModalContexts),
      };

      if (state.editingTaskId) {
        // Update
        const idx = state.tasks.findIndex(x => x.id === state.editingTaskId);
        if (idx >= 0) {
          state.tasks[idx] = { ...state.tasks[idx], ...data };
        }
      } else {
        // Create
        state.tasks.push({
          id: uid(),
          ...data,
          createdAt: new Date().toISOString(),
          completedAt: null
        });
      }

      saveTasks();
      closeModal();
      renderTasks();
      renderTagCloud();
      updateFilterSummary();
    }

    function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      state.tasks = state.tasks.filter(t => t.id !== id);
      saveTasks();
      renderTasks();
      renderTagCloud();
    }

    function toggleComplete(id, toComplete=true) {
      const t = state.tasks.find(x => x.id === id);
      if (!t) return;
      t.completedAt = toComplete ? new Date().toISOString() : null;
      saveTasks();
      renderTasks();
    }

    // ========= Export / Import =========
    function exportJSON() {
      const data = JSON.stringify(state.tasks, null, 2);
      const blob = new Blob([data], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `select-do-tasks-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importJSON(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const parsed = JSON.parse(e.target.result);
          if (!Array.isArray(parsed)) throw new Error('Invalid file format');
          state.tasks = parsed;
          saveTasks();
          renderTasks();
          renderTagCloud();
          renderTimeButtons();
          renderContextButtons();
          updateFilterSummary();
          alert('Import successful.');
        } catch (err) {
          alert('Import failed: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // ========= Actions =========
    els.suggestTaskBtn.addEventListener('click', renderSuggestions);
    els.surpriseMeBtn.addEventListener('click', () => {
      // Random from ALL active tasks
      const active = state.tasks.filter(t => !t.completedAt);
      if (active.length === 0) {
        els.suggestedTasks.innerHTML = `<p class="text-slate-500 text-center py-4">No tasks to surprise you with. Add some first!</p>`;
        return;
      }
      const r = active[Math.floor(Math.random() * active.length)];
      els.suggestedTasks.innerHTML = '';
      const div = document.createElement('div');
      div.className = 'bg-white p-4 rounded-lg shadow cursor-pointer hover:shadow-md transition';
      div.innerHTML = `
        <strong class="text-lg text-slate-900">Surprise Task: ${r.task}</strong>
        <p class="text-sm text-slate-500">${r.project} • ${r.time} min • <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full ${prioDot(r.priority)}"></span>${r.priority}</span></p>
      `;
      div.onclick = () => startFocusTask(r.task, r.time);
      els.suggestedTasks.appendChild(div);
      // Clear filters to reduce friction for next pick
      clearFilters();
    });

    els.clearFiltersBtn.addEventListener('click', clearFilters);

    // Focus controls
    els.pauseBtn.addEventListener('click', () => {
      state.paused = !state.paused;
      els.pauseBtn.textContent = state.paused ? 'Resume' : 'Pause';
    });
    els.stopBtn.addEventListener('click', () => {
      if (state.countdownInterval) clearInterval(state.countdownInterval);
      showFocus(false);
    });

    // Modal controls
    els.openModalBtn.addEventListener('click', openAdd);
    els.closeModalBtn.addEventListener('click', closeModal);
    els.taskForm.addEventListener('submit', saveTaskFromForm);
    els.addTagBtn.addEventListener('click', () => {
      const t = els.newTagInput.value.trim();
      if (!t) return;
      state.selectedModalTags.add(t);
      els.newTagInput.value = '';
      renderModalTags();
    });

    // Export / Import
    els.exportBtn.addEventListener('click', exportJSON);
    els.importInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) importJSON(file);
      e.target.value = '';
    });

    // Last task bar
    els.continueLastTaskBtn.addEventListener('click', () => {
      if (!state.lastTask) return;
      startFocusTask(state.lastTask.name, state.lastTask.minutes);
      els.lastTaskBar.classList.add('hidden');
    });
    els.dismissLastTaskBtn.addEventListener('click', () => {
      els.lastTaskBar.classList.add('hidden');
    });

    // ========= Init =========
    function init() {
      loadTasks();
      loadLast();
      renderTimeButtons();
      renderContextButtons();
      renderTagCloud();
      updateFilterSummary();
      renderTasks();

      if (state.lastTask?.name && state.lastTask?.minutes) {
        els.lastTaskName.textContent = `${state.lastTask.name} (${state.lastTask.minutes} min)`;
        els.lastTaskBar.classList.remove('hidden');
      }
    }

    init();
  </script>
</body>
</html>