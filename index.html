<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Select + Do</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
  
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Select Do">
  <link rel="apple-touch-icon" href="/selectdologo.png">
  <link rel="icon" type="image/png" href="/selectdologo.png">
  <style>
    :root { font-family: 'Inter', sans-serif; }
    @supports (font-variation-settings: normal) {
      :root { font-family: 'Inter var', sans-serif; }
    }
    /* Simple fade-in animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
    /* Task completion animation */
    @keyframes fadeOutShrink {
      from {
        opacity: 1;
        transform: scale(1);
        height: 44px; /* Approximate height of a task item */
        margin-bottom: 0.25rem; /* from space-y-1 */
        padding: 0.5rem; /* from p-2 */
      }
      to {
        opacity: 0;
        transform: scale(0.9);
        height: 0;
        margin-bottom: 0;
        padding: 0;
        overflow: hidden;
      }
    }
    .task-completing {
      animation: fadeOutShrink 0.3s ease-out forwards;
    }
    /* Ensure the body doesn't scroll when an overlay is open */
    body.overflow-hidden {
      overflow: hidden;
    }
          /* Project collapse/expand animations */
      .project-content {
        transition: all 0.3s ease-in-out;
        overflow: hidden;
      }
      .project-content.collapsed {
        max-height: 0;
        opacity: 0;
        margin: 0;
        padding: 0;
      }
      .project-content.expanded {
        max-height: 1000px;
        opacity: 1;
      }
      .collapse-icon {
        transition: transform 0.3s ease-in-out;
      }
      .collapse-icon.collapsed {
        transform: rotate(-90deg);
      }
            .collapse-icon.expanded {
       transform: rotate(0deg);
     }
    /* Task Review section collapse/expand animations */
    .task-review-content {
      transition: all 0.3s ease-in-out;
      overflow: hidden;
    }
    .task-review-content.collapsed {
      max-height: 0;
      opacity: 0;
      margin: 0;
      padding: 0;
    }
    .task-review-content.expanded {
      max-height: 1000px;
      opacity: 1;
    }
    .task-review-collapse-icon {
      transition: transform 0.3s ease-in-out;
    }
    .task-review-collapse-icon.collapsed {
      transform: rotate(-90deg);
    }
    .task-review-collapse-icon.expanded {
      transform: rotate(0deg);
    }
    
    /* Mobile-specific improvements */
    @media (max-width: 768px) {
      /* Better touch targets */
      button, input, select {
        min-height: 44px;
      }
      
      /* Improved spacing for mobile */
      .space-y-4 > * + * {
        margin-top: 1rem;
      }
      
      /* Better modal positioning on mobile */
      #modalOverlay {
        padding: 1rem;
        align-items: flex-start;
        padding-top: 2rem;
      }
      
      /* Mobile-friendly focus states */
      button:focus-visible {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
      }
      
      /* Ensure modals appear above fixed header */
      #modalOverlay, #statsModalOverlay, #projectDeleteModalOverlay, #stopFocusModalOverlay, #startTaskModalOverlay, #completeTaskModalOverlay {
        z-index: 60;
      }
      
      /* Modal content positioning for mobile */
      #modalOverlay > div {
        margin-top: 1rem;
      }
    }
    
    /* Touch-friendly improvements */
    .touch-manipulation {
      touch-action: manipulation;
    }
    
    /* Prevent text selection on buttons */
    button {
      user-select: none;
      -webkit-user-select: none;
    }
    
    /* Essential: Hidden class for sidebar and modal functionality */
    .hidden {
      display: none !important;
    }
    
    /* Ensure full height for proper sidebar background */
    html, body {
      height: 100%;
    }

    /* Dark mode styles */
    .dark {
      color-scheme: dark;
    }

    .dark body {
      background-color: #0f172a;
      color: #e2e8f0;
    }

    .dark .bg-white {
      background-color: #1e293b !important;
    }

    .dark .bg-slate-50 {
      background-color: #334155 !important;
    }

    .dark .bg-slate-100 {
      background-color: #475569 !important;
    }

    .dark .text-slate-900 {
      color: #f1f5f9 !important;
    }

    .dark .text-slate-800 {
      color: #e2e8f0 !important;
    }

    .dark .text-slate-700 {
      color: #cbd5e1 !important;
    }

    .dark .text-slate-600 {
      color: #94a3b8 !important;
    }

    .dark .text-slate-500 {
      color: #64748b !important;
    }

    .dark .text-slate-400 {
      color: #94a3b8 !important;
    }

    .dark .border-slate-200 {
      border-color: #475569 !important;
    }

    .dark .border-slate-300 {
      border-color: #64748b !important;
    }

    .dark .bg-slate-200 {
      background-color: #475569 !important;
    }

    .dark .hover\:bg-slate-100:hover {
      background-color: #475569 !important;
    }

    .dark .hover\:bg-slate-200:hover {
      background-color: #64748b !important;
    }

    .dark .focus\:ring-blue-400:focus {
      --tw-ring-color: #3b82f6 !important;
    }

    .dark .focus\:border-blue-400:focus {
      border-color: #3b82f6 !important;
    }

    .dark .bg-blue-50 {
      background-color: #1e3a8a !important;
    }

    .dark .text-blue-700 {
      color: #93c5fd !important;
    }

    .dark .bg-green-50 {
      background-color: #14532d !important;
    }

    .dark .text-green-700 {
      color: #86efac !important;
    }

    .dark .bg-red-50 {
      background-color: #7f1d1d !important;
    }

    .dark .text-red-700 {
      color: #fca5a5 !important;
    }

    .dark .bg-amber-50 {
      background-color: #78350f !important;
    }

    .dark .text-amber-800 {
      color: #fcd34d !important;
    }

    .dark .bg-amber-200 {
      background-color: #92400e !important;
    }

    .dark .bg-purple-50 {
      background-color: #581c87 !important;
    }

    .dark .text-purple-700 {
      color: #c4b5fd !important;
    }

    .dark .bg-purple-100 {
      background-color: #6b21a8 !important;
    }

    /* Font size classes */
    .text-small-size {
      font-size: 0.75rem; /* 12px */
    }

    .text-small-size h1, .text-small-size h2, .text-small-size h3, .text-small-size h4, .text-small-size h5, .text-small-size h6 {
      font-size: 0.875rem; /* 14px */
    }

    .text-medium-size {
      font-size: 0.875rem; /* 14px - default */
    }

    .text-large-size {
      font-size: 1rem; /* 16px */
    }

    .text-large-size h1, .text-large-size h2, .text-large-size h3, .text-large-size h4, .text-large-size h5, .text-large-size h6 {
      font-size: 1.125rem; /* 18px */
    }

    .text-extra-large-size {
      font-size: 1.125rem; /* 18px */
    }

    .text-extra-large-size h1, .text-extra-large-size h2, .text-extra-large-size h3, .text-extra-large-size h4, .text-extra-large-size h5, .text-extra-large-size h6 {
      font-size: 1.25rem; /* 20px */
    }

    /* Override specific section headers to maintain consistent sizing */
    .text-small-size .section-header,
    .text-medium-size .section-header,
    .text-large-size .section-header,
    .text-extra-large-size .section-header {
      font-size: 1rem !important; /* 16px - consistent across all font sizes */
    }

    .text-small-size .sidebar-header,
    .text-medium-size .sidebar-header,
    .text-large-size .sidebar-header,
    .text-extra-large-size .sidebar-header {
      font-size: 0.875rem !important; /* 14px - consistent across all font sizes */
    }

    /* Reduced motion */
    .reduce-motion * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans overflow-x-hidden">

  <div id="loginScreen" class="flex h-screen w-screen items-center justify-center">
    <div class="text-center p-8 bg-white rounded-xl shadow-md border border-slate-200 max-w-md w-full mx-4">
        <img src="selectdologo.png" alt="Select + Do Logo" class="w-48 h-auto mb-6 mx-auto">
        <h1 class="text-2xl font-bold text-slate-800 mb-2">Welcome to Select + Do</h1>
        <p class="text-slate-500 mb-8">Sign in to continue to your personalized dashboard.</p>
        
        <!-- Email/Password Form -->
        <div id="emailPasswordForm" class="mb-6">
            <div class="mb-4">
                <input type="email" id="emailInput" placeholder="Email address" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="mb-4">
                <input type="password" id="passwordInput" placeholder="Password" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="flex gap-2 mb-4">
                <button id="signInBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Sign In
                </button>
                <button id="signUpBtn" class="flex-1 bg-slate-500 hover:bg-slate-600 text-white py-3 px-4 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                    Sign Up
                </button>
            </div>
            <div id="authError" class="text-red-500 text-sm mb-4 hidden"></div>
        </div>
        
        <!-- Divider -->
        <div class="flex items-center mb-6">
            <div class="flex-1 border-t border-slate-300"></div>
            <span class="px-4 text-slate-500 text-sm">or</span>
            <div class="flex-1 border-t border-slate-300"></div>
        </div>
        
        <!-- Google Sign In -->
        <button id="googleLoginBtn" class="w-full flex items-center justify-center bg-white hover:bg-slate-50 text-slate-700 py-3 px-6 rounded-lg transition-colors text-base font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 border border-slate-300">
            <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
            Sign in with Google
        </button>
        
        <!-- Continue as Guest -->
        <div class="mt-4 text-center">
            <button id="guestLoginBtn" class="text-slate-400 hover:text-blue-500 p-1.5 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                Continue as Guest
        </button>
        </div>
    </div>
  </div>

  <div id="mainApp" class="hidden flex-col md:flex-row h-screen md:h-screen">
    
    <div id="mobileHeader" class="md:hidden flex justify-between items-center p-4 bg-white border-b border-slate-200 fixed top-0 left-0 right-0 z-50">
        <img src="selectdologo.png" alt="Select + Do Logo" class="w-32 h-auto">
        <div class="flex items-center gap-2">
          <button id="settingsBtn" class="text-slate-600 hover:text-blue-500 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 touch-manipulation active:bg-slate-100 transition-colors">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 1v6m0 0L9 4m3 3l3-3M5 21v-6m0 0l3 3m-3-3l-3 3M19 21v-6m0 0l-3 3m3-3l3 3M12 7v10m-5-5h10" /></svg>
          </button>
          <button id="menuBtn" class="text-slate-600 hover:text-blue-500 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 touch-manipulation active:bg-slate-100 transition-colors">
            <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
          </button>
        </div>
    </div>

    <div id="sidebar" class="w-full md:w-1/3 md:max-w-sm p-3 sm:p-4 bg-white border-r border-slate-200 flex flex-col shrink-0 shadow-sm 
        md:relative md:flex fixed inset-0 z-50 hidden md:!block md:!flex min-h-full h-full md:h-full
        transform transition-transform duration-300 ease-in-out md:transform-none">
        <button id="closeMenuBtn" class="md:hidden absolute top-4 right-4 text-slate-500 hover:text-slate-800 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 touch-manipulation active:bg-slate-100 transition-colors">
            <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>

      <div class="flex justify-between items-center mb-2">
        <img src="selectdologo.png" alt="Select + Do Logo" class="w-32 h-auto">
        <button id="desktopSettingsBtn" class="text-slate-500 hover:text-slate-700 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" title="Accessibility Settings">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" /></svg>
        </button>
      </div>

      <button id="addTaskBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2.5 px-4 rounded-lg transition-colors text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 touch-manipulation active:bg-blue-700 mt-6 md:mt-0">
        + Add New Task
      </button>

      
       <div class="mb-3 mt-4 relative">
        <svg class="w-5 h-5 text-slate-400 absolute top-1/2 left-3 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
        <input id="unifiedCommandInput" type="text" placeholder="Search or create new. Fix sink @standard #personal" class="w-full border border-slate-200 p-2 pl-10 rounded-lg text-xs placeholder:text-slate-400 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none" />
        <div id="commandSuggestions" class="absolute top-full left-0 right-0 mt-1 bg-white border border-slate-200 rounded-lg shadow-lg z-50 hidden max-h-60 overflow-y-auto"></div>
       </div>

      <div id="projectsContainer" class="space-y-3 overflow-y-auto flex-grow -mx-2 px-2">
        <div id="todayProjectContainer"></div>
       </div>
      
        <div class="mt-3 pt-2 border-t border-slate-100 relative">
          <div class="flex items-center justify-end mb-2">
            <button id="collapseAllProjectsBtn" class="text-xs text-slate-600 hover:text-slate-700 font-medium transition-colors">
              Collapse All
            </button>
          </div>
         <input id="newProjectInput" type="text" placeholder="+ New Project" class="w-full border border-slate-200 p-2 rounded-lg text-xs placeholder:text-slate-400 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none" />
          <div id="projectAutocomplete" class="absolute top-full left-0 right-0 bg-white border border-slate-200 rounded-lg shadow-lg mt-1 max-h-32 overflow-y-auto hidden z-10">
            </div>
       </div>

      <!-- Bottom Section -->
      <div class="bg-white border border-slate-200 mt-3 -mx-3 sm:-mx-4" style="border-radius: 0 0 0.75rem 0;">



      </div>
      
      <!-- Bottom Spacing -->
      <div class="h-2"></div>
    </div>

    <div class="flex-1 p-4 md:p-8 md:overflow-y-auto max-w-4xl pt-20 md:pt-8 bg-slate-50">
      <!-- Guest Mode Notice -->
      <div id="guestModeNotice" class="hidden mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 p-4 rounded-xl">
        <div class="flex items-center justify-center space-x-3 text-blue-600">
          <div class="flex items-center space-x-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-sm font-medium">Interactive Demo</span>
          </div>
          <span class="text-sm text-blue-500">• Try task management, time tracking, and insights with sample data</span>
          <button id="guestSignUpBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1.5 rounded-lg text-sm font-medium transition-colors shadow-sm">
            Sign up to save
          </button>
        </div>
      </div>
      
      
      <!-- Simplified Task Selection -->
      <div class="mb-6 bg-white p-5 rounded-xl border border-slate-200">
        <h2 class="font-semibold text-slate-900 mb-4 text-base">Find a task</h2>
        
        <!-- Step 1: Context Selection -->
        <div class="mb-6">
          <h3 class="font-medium text-slate-600 mb-3 text-sm section-header">1. What mode are you in?</h3>
          <div class="inline-flex bg-slate-100 rounded-lg p-1 border border-slate-200">
            <button id="workModeBtn" class="context-mode-btn flex items-center justify-center gap-3 px-4 py-2 rounded-md transition-all text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1" data-context="Work">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
                <path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z" />
              </svg>
              Work
            </button>
            <button id="personalModeBtn" class="context-mode-btn flex items-center justify-center gap-3 px-4 py-2 rounded-md transition-all text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1" data-context="Personal">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" />
              </svg>
              Personal
            </button>
          </div>
        </div>

        <!-- Step 2: Time Selection -->
        <div class="mb-6">
          <h3 class="font-medium text-slate-600 mb-3 text-sm section-header">2. How much time do you have?</h3>
          <div class="flex flex-wrap gap-2">
                <div id="timeFilters" class="flex flex-wrap gap-2"></div>
            <div class="flex items-center gap-2 ml-2">
              <span class="text-sm text-slate-500">or</span>
              <input id="customTimeFilterInput" type="number" placeholder="Custom" min="1" max="999" class="w-24 px-2 py-1 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none" />
              <span class="text-sm text-slate-500">min</span>
            </div>
            </div>
        </div>

        <!-- Step 3: Task Suggestions -->
        <div id="taskSuggestionsSection" class="hidden mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-medium text-slate-600 text-sm">3. Pick a task</h3>
            <button id="reshuffleBtn" class="text-xs text-blue-600 hover:text-blue-700 font-medium flex items-center">
              <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Reshuffle
            </button>
          </div>
          <div id="taskSuggestions" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Task suggestions will be populated here -->
          </div>
        </div>

        <!-- Advanced Filters (Collapsible) -->
        <div class="mb-4">
          <button id="toggleAdvancedFilters" class="text-xs text-slate-600 hover:text-slate-700 font-medium mb-3 flex items-center">
            <span id="advancedFiltersIcon" class="mr-1">▼</span>
            Advanced Filters
          </button>
          <div id="advancedFilters" class="hidden space-y-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
            <div>
              <h4 class="font-medium text-slate-600 mb-2 text-sm">Energy Level</h4>
                <div id="energyFilters" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
              <div class="flex items-center mb-2 group">
                <h4 class="font-medium text-slate-600 cursor-pointer text-sm" id="projectsHeader">Projects</h4>
                <button id="manageProjectsBtn" class="ml-2 text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:text-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 rounded px-1 py-0.5">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
              </div>
              <div id="projectFilters" class="flex flex-wrap gap-2">
                <!-- Project filters will be populated here -->
              </div>
            </div>
            <div>
              <div class="flex items-center mb-2 group">
                <h4 class="font-medium text-slate-600 cursor-pointer text-sm" id="tagsHeader">Tags</h4>
                <button id="editTagsBtn" class="ml-2 text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:text-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 rounded px-1 py-0.5">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                </button>
              </div>
              <div id="tagCloud" class="flex flex-wrap gap-2">
                <!-- Popular tags will be populated here -->
              </div>
            </div>
            <div>
              <h4 class="font-medium text-slate-600 mb-2 text-sm">⭐️ Priority Only</h4>
              <div class="flex items-center">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input id="priorityOnlyToggle" type="checkbox" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
                <span class="ml-3 text-sm text-slate-600">Show only priority tasks</span>
              </div>
            </div>
            </div>
            
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 sm:gap-2 border-t border-slate-100 pt-4">
          <button id="clearFiltersBtn" class="w-full sm:w-auto bg-slate-100 hover:bg-slate-200 text-slate-700 px-6 py-3 sm:py-2 rounded-lg transition-colors text-xs font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 touch-manipulation active:bg-slate-300 border border-slate-200">Clear All</button>
        </div>
      </div>
      
      <!-- Content Area -->
      <div id="contentArea" class="mb-6">
        

        </div>
        
      <div id="filteredTaskList" class="space-y-4">
            </div>
      
      <!-- Task Review Section -->
      <div class="mt-8 bg-white p-5 rounded-xl border border-slate-200">
        <div class="flex items-center justify-between cursor-pointer hover:bg-slate-50 p-2 rounded-lg transition-colors -m-2" id="taskReviewHeader">
          <h2 class="font-semibold text-slate-900 text-sm section-header">📊 Task Review</h2>
          <button class="text-slate-400 hover:text-slate-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg class="w-5 h-5 task-review-collapse-icon expanded" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
            </div>
        <div id="taskReviewContent" class="task-review-content expanded mt-2">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
            <!-- Completed Today Column -->
            <div>
              <h3 class="font-semibold text-slate-800 mb-3 text-sm flex items-center">
                <span class="text-sm mr-2">✅</span>
                Completed Today
              </h3>
              <div id="completedTaskList" class="space-y-1 overflow-y-auto max-h-[40vh]">
              </div>
            </div>
            
            <!-- Weekly Review Column -->
            <div>
              <h3 class="font-semibold text-slate-800 mb-3 text-sm flex items-center">
                <span class="text-sm mr-2">📈</span>
                <span class="section-header">Weekly Insights</span>
              </h3>
              <div id="weeklyReviewContent" class="space-y-4 text-sm">
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- User Profile Section -->
      <div class="mt-6 bg-white p-5 rounded-xl border border-slate-200">
        <div id="userDisplay">
        </div>
      </div>
    </div>
  </div>

  <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start md:items-center hidden z-[60] p-4 pt-20 md:pt-4" inert aria-hidden="true">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md relative max-h-[90vh] flex flex-col">
      <div class="p-6 overflow-y-auto flex-1">
      <div class="flex items-center justify-between mb-4">
        <h2 id="modalTitle" class="text-base font-bold text-slate-900">Add New Task</h2>
        <button id="closeModalBtn" class="text-red-600 hover:text-red-800 hover:bg-red-100 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors border-2 border-red-300 bg-white">
          <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <input id="taskName" type="text" placeholder="Task Name (e.g., 'Draft project proposal')" class="w-full mb-4 border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none text-sm"/>
      
      <label class="block mb-2 font-medium text-slate-700 text-sm">Project</label>
      <div class="relative mb-4">
        <select id="projectSelect" class="w-full border border-slate-300 p-2 rounded-lg bg-white focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none pr-8 text-sm">
          <option value="new-project">+ New Project</option>
        </select>
        <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>
      
      <!-- New Project Input (hidden by default) -->
      <div id="newProjectInputContainer" class="hidden mb-4">
        <label class="block mb-2 font-medium text-slate-700">New Project Name</label>
        <div class="flex space-x-2">
          <input id="newProjectNameInput" type="text" placeholder="Enter project name..." class="flex-1 border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none"/>
          <button id="createProjectBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
            Create
          </button>
          <button id="cancelNewProjectBtn" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition-colors text-sm font-medium focus:outline-none focus:ring-2 focus:ring-slate-500">
            Cancel
          </button>
        </div>
      </div>

      <label class="block mb-2 font-medium text-slate-700 text-sm">Task Type</label>
      <div class="bg-slate-50 p-3 rounded-lg mb-4">
        <div class="grid grid-cols-2 gap-3">
          <button id="atomicTaskBtn" class="px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 bg-white text-slate-700 shadow-sm border border-slate-200 hover:shadow-md">
            <div class="flex items-center justify-center mb-1">
              <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Atomic
            </div>
            <div class="text-xs text-slate-500 text-center">One session task</div>
          </button>
          <button id="progressTaskBtn" class="px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-slate-600 hover:text-slate-700 border border-slate-200 hover:bg-slate-50">
            <div class="flex items-center justify-center mb-1">
              <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Progress
            </div>
            <div class="text-xs text-slate-500 text-center">Multi-session task</div>
          </button>
        </div>
        <input id="taskDivisible" type="checkbox" class="hidden">
      </div>

      <div id="atomicTimeSection" class="transition-all duration-200 ease-in-out min-h-[60px]">
        <label class="block mb-2 font-medium text-slate-700 text-sm">Time Required</label>
        <div class="flex flex-wrap gap-2 mb-4">
          <div id="modalTimeButtons" class="flex flex-wrap gap-2"></div>
        </div>
      </div>

      <div id="progressTimeSection" class="hidden transition-all duration-200 ease-in-out min-h-[60px]">
        <label class="block mb-2 font-medium text-slate-700 text-sm">Typical session time?</label>
        <div class="flex flex-wrap gap-2 mb-4">
          <div id="modalSessionTimeButtons" class="flex flex-wrap gap-2"></div>
              </div>
            </div>
      
      <label class="block mb-2 font-medium text-slate-700 text-sm">Context</label>
      <p class="text-xs text-slate-500 mb-2">Select one or both contexts for this task</p>
      <div id="modalContextButtons" class="flex flex-wrap gap-2 mb-4"></div>

      <div class="bg-slate-50 p-3 rounded-lg flex items-center justify-between mb-4">
        <label for="taskRecurring" class="font-medium text-slate-700 text-sm">Recurring Task</label>
        <input id="taskRecurring" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
          </div>

      <div class="bg-slate-50 p-3 rounded-lg flex items-center justify-between mb-4">
        <div class="flex items-center">
          <label for="taskActive" class="font-medium text-slate-700 text-sm mr-3">Task Status</label>
          <div class="flex items-center">
            <span class="text-xs text-slate-500 mr-2">Inactive</span>
            <label class="relative inline-flex items-center cursor-pointer">
              <input id="taskActive" type="checkbox" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
            <span class="text-xs text-slate-500 ml-2">Active</span>
          </div>
        </div>
      </div>

      <!-- Advanced Options Toggle -->
      <button id="toggleAdvancedTaskOptions" class="text-xs text-slate-600 hover:text-slate-700 font-medium mb-3 flex items-center">
        <span id="advancedTaskOptionsIcon" class="mr-1">▼</span>
        Advanced Options
      </button>
      
      <!-- Advanced Options (Collapsible) -->
      <div id="advancedTaskOptions" class="hidden space-y-4 p-4 bg-slate-50 rounded-lg border border-slate-200 mb-4">
          <div>
          <label class="block mb-2 font-medium text-slate-700 text-sm">Energy Level</label>
          <div id="modalEnergyButtons" class="flex flex-wrap gap-2"></div>
              </div>
        
        <div>
          <label class="block mb-2 font-medium text-slate-700 text-sm">Tags</label>
          <input id="taskTags" type="text" placeholder="Type a tag and hit Enter" class="w-full mb-2 border border-slate-300 p-2 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none text-sm"/>
          <div id="tagPreview" class="flex flex-wrap gap-2 min-h-[28px]"></div>
            </div>
          </div>
      
      </div>
      <div class="p-6 pt-0 border-t border-slate-200">
        <div class="flex justify-end space-x-2">
          <button id="cancelTaskBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors font-semibold text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Cancel</button>
          <button id="saveTaskBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors font-semibold text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600">Save Task</button>
        </div>
      </div>
    </div>
  </div>
      
  <!-- Tag Manager Modal -->
  <div id="tagManagerModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[65] p-4" inert aria-hidden="true">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-slate-900">🏷️ Tag Manager</h2>
        <button id="closeTagManagerBtn" class="text-slate-400 hover:text-slate-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      
      <!-- Add New Tag Section -->
      <div class="mb-4 p-3 bg-slate-50 rounded-lg">
        <h3 class="font-medium text-slate-700 mb-2 text-sm">Add New Tag</h3>
        <div class="flex gap-2">
          <input id="newTagInput" type="text" placeholder="Enter tag name" class="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none text-sm" />
          <button id="addTagBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg transition-colors font-medium text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Add
          </button>
        </div>
      </div>
      
      <!-- Tags Cloud -->
      <div class="mb-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-medium text-slate-700 text-sm">All Tags</h3>
          <span class="text-xs text-slate-500">Click to edit • Hover for delete</span>
        </div>
        <div id="tagManagerCloud" class="flex flex-wrap gap-2">
          <!-- Tags will be populated here as a cloud -->
        </div>
      </div>
      
      <!-- Actions -->
      <div class="flex justify-end pt-3 border-t border-slate-200">
        <button id="closeTagManagerBtn2" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors font-medium text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Close</button>
      </div>
    </div>
  </div>


    <div id="statsModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[60] p-4" inert aria-hidden="true">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-slate-900">📊 Weekly Review</h2>
        <button id="closeStatsBtn" class="text-slate-400 hover:text-slate-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div id="statsContent" class="space-y-6">
        </div>
    </div>
  </div>

  <!-- Sign Up Modal -->
  <div id="signUpModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[70] p-4" inert aria-hidden="true">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
      <button id="closeSignUpModalBtn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
      
      <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-slate-800 mb-2">Join Select + Do</h2>
        <p class="text-slate-600">Save your progress and sync across devices</p>
      </div>

      <!-- Email/Password Form -->
      <div id="signUpEmailPasswordForm" class="mb-6">
        <div class="mb-4">
          <input type="email" id="signUpEmailInput" placeholder="Email address" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div class="mb-4">
          <input type="password" id="signUpPasswordInput" placeholder="Password" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div class="mb-4">
          <button id="signUpModalBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Create Account
          </button>
        </div>
        <div id="signUpAuthError" class="text-red-500 text-sm mb-4 hidden"></div>
      </div>
      
      <!-- Divider -->
      <div class="flex items-center mb-6">
        <div class="flex-1 border-t border-slate-300"></div>
        <span class="px-4 text-slate-500 text-sm">or</span>
        <div class="flex-1 border-t border-slate-300"></div>
      </div>
      
      <!-- Google Sign In -->
      <button id="signUpGoogleLoginBtn" class="w-full flex items-center justify-center bg-white hover:bg-slate-50 text-slate-700 py-3 px-6 rounded-lg transition-colors text-base font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 border border-slate-300">
        <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
        Sign up with Google
      </button>

      <div class="mt-6 text-center">
        <p class="text-sm text-slate-500">
          Already have an account? 
          <button id="showLoginModalBtn" class="text-blue-500 hover:text-blue-600 font-medium">Sign in</button>
        </p>
      </div>
    </div>
  </div>

  <!-- Sign In Modal -->
  <div id="signInModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[70] p-4" inert aria-hidden="true">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg relative">
      <button id="closeSignInModalBtn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
      
      <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-slate-800 mb-2">Welcome Back</h2>
        <p class="text-slate-600">Sign in to your account</p>
      </div>

      <!-- Email/Password Form -->
      <div id="signInEmailPasswordForm" class="mb-6">
        <div class="mb-4">
          <input type="email" id="signInEmailInput" placeholder="Email address" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div class="mb-4">
          <input type="password" id="signInPasswordInput" placeholder="Password" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div class="mb-4">
          <button id="signInModalBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Sign In
          </button>
        </div>
        <div id="signInAuthError" class="text-red-500 text-sm mb-4 hidden"></div>
      </div>
      
      <!-- Divider -->
      <div class="flex items-center mb-6">
        <div class="flex-1 border-t border-slate-300"></div>
        <span class="px-4 text-slate-500 text-sm">or</span>
        <div class="flex-1 border-t border-slate-300"></div>
      </div>
      
      <!-- Google Sign In -->
      <button id="signInGoogleLoginBtn" class="w-full flex items-center justify-center bg-white hover:bg-slate-50 text-slate-700 py-3 px-6 rounded-lg transition-colors text-base font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 border border-slate-300">
        <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
        Sign in with Google
      </button>

      <div class="mt-6 text-center">
        <p class="text-sm text-slate-500">
          Don't have an account? 
          <button id="showSignUpModalBtn" class="text-blue-500 hover:text-blue-600 font-medium">Sign up</button>
        </p>
      </div>
    </div>
  </div>

  <!-- Project Management Modal -->
  <div id="projectManagementModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[70] p-4" inert aria-hidden="true">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl max-h-[80vh] overflow-hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-slate-900">Manage Projects</h2>
        <button id="closeProjectManagementModalBtn" class="text-slate-400 hover:text-slate-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      
      <div class="mb-4">
        <div class="flex items-center justify-between mb-3">
          <span class="text-sm text-slate-600">All Projects</span>
          <button id="deleteEmptyProjectsBtn" class="text-xs text-red-600 hover:text-red-700 font-medium transition-colors">
            Delete Empty Projects
          </button>
        </div>
        <div id="projectManagementList" class="space-y-2 max-h-96 overflow-y-auto">
          <!-- Projects will be populated here -->
        </div>
      </div>
      
      <div class="flex justify-end space-x-3 pt-4 border-t border-slate-200">
        <button id="closeProjectManagementModalBtn2" class="px-4 py-2 text-slate-600 hover:text-slate-700 font-medium transition-colors">
          Close
        </button>
      </div>
    </div>
  </div>

    <div id="projectDeleteModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[80] p-4" inert aria-hidden="true">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
      <div class="flex items-center mb-4">
        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
          <svg class="w-6 h-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
      </div>
        <h2 class="text-lg font-bold text-slate-900">Delete Project</h2>
      </div>
      
      <div id="projectDeleteContent" class="mb-6">
        </div>
      
      <div class="flex justify-end space-x-3">
        <button id="cancelProjectDeleteBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Cancel</button>
        <button id="confirmProjectDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Delete Project</button>
      </div>
    </div>
  </div>

  <div id="stopFocusModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[150] p-4" inert aria-hidden="true">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
      <div class="flex items-center mb-4">
        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
          <svg class="w-6 h-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
        </div>
        <h2 class="text-lg font-bold text-slate-900">Stop Focus Session</h2>
      </div>
      
      <div class="mb-6">
        <p class="text-slate-600">Are you sure you want to stop the current focus session?</p>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button id="cancelStopFocusBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Cancel</button>
        <button id="confirmStopFocusBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Stop Session</button>
      </div>
    </div>
  </div>

  <div id="startTaskModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[150] p-4" inert aria-hidden="true">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
      <div class="flex items-center mb-4">
        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
          <svg class="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.647c1.295.748 1.295 2.538 0 3.286L8.029 20.99c-1.25.72-2.779-.217-2.779-1.643V5.653z" />
          </svg>
        </div>
        <h2 class="text-lg font-bold text-slate-900">Start Task</h2>
      </div>
      
      <div class="mb-6">
        <p class="text-slate-600">Are you ready to start working on this task?</p>
        <div class="mt-3 p-3 bg-slate-50 rounded-lg">
          <div class="font-medium text-slate-800" id="startTaskName"></div>
          <div class="text-sm text-slate-500 mt-1" id="startTaskDetails"></div>
        </div>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button id="cancelStartTaskBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Cancel</button>
        <button id="confirmStartTaskBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Start Task</button>
      </div>
    </div>
  </div>

  <div id="completeTaskModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[150] p-4" inert aria-hidden="true">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
      <div class="flex items-center mb-4">
        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
          <svg class="w-6 h-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h2 class="text-lg font-bold text-slate-900">Complete Task</h2>
      </div>
      
      <div class="mb-6">
        <p class="text-slate-600">Are you sure you want to mark this task as complete?</p>
        <div class="mt-3 p-3 bg-slate-50 rounded-lg">
          <div class="font-medium text-slate-800" id="completeTaskName"></div>
          <div class="text-sm text-slate-500 mt-1" id="completeTaskDetails"></div>
        </div>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button id="cancelCompleteTaskBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Cancel</button>
        <button id="confirmCompleteTaskBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Mark as Complete</button>
      </div>
    </div>
  </div>

  <!-- Inactive Tasks Review Modal -->
  <div id="inactiveTasksModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[60] p-4" inert aria-hidden="true">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-hidden">
      <div class="p-6">
        <div class="flex items-center mb-4">
          <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center mr-3">
            <svg class="w-6 h-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
            </svg>
          </div>
          <h2 class="text-lg font-bold text-slate-900">Review Inactive Tasks</h2>
        </div>
        
        <p class="text-slate-600 mb-4">These tasks are currently inactive. Click to reactivate them or leave them inactive.</p>
        
        <div id="inactiveTasksList" class="space-y-2 max-h-96 overflow-y-auto">
          <!-- Inactive tasks will be populated here -->
        </div>
        
        <div class="flex justify-end mt-6">
          <button id="closeInactiveTasksModalBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div id="focusOverlay" class="fixed inset-0 z-[100] flex flex-col justify-center items-center hidden p-4" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
    <!-- Subtle geometric pattern background -->
    <div class="absolute inset-0 opacity-5" style="background-image: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23000000" fill-opacity="0.1"><path d="M30 0l15 15-15 15-15-15z"/></g></g></svg>'); background-size: 60px 60px;"></div>
    
    <div class="relative bg-white rounded-3xl shadow-2xl border border-slate-200 w-full max-w-lg p-8 backdrop-blur-sm">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 id="focusTaskName" class="text-2xl font-bold text-slate-800 mb-3"></h1>
        <div id="focusTimeBracket" class="text-sm text-slate-500 bg-slate-100 inline-block px-4 py-2 rounded-full font-medium"></div>
      </div>
      
      <!-- Timer Display -->
      <div class="text-center mb-8">
        <div id="focusTimerDisplay" class="text-4xl font-bold text-slate-700 mb-2 tracking-tight"></div>
        <div class="text-sm text-slate-400 font-medium">Elapsed Time</div>
      </div>
      
      <!-- Control Buttons -->
      <div class="flex flex-col sm:flex-row gap-3 justify-center mb-6">
        <button id="focusPauseBtn" class="flex items-center justify-center bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-3 px-6 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hover:shadow-md">
          <svg id="pauseIcon" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg>
          <svg id="playIcon" class="w-5 h-5 mr-2 hidden" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.647c1.295.748 1.295 2.538 0 3.286L8.029 20.99c-1.25.72-2.779-.217-2.779-1.643V5.653z" /></svg>
            <span id="focusPauseText">Pause</span>
        </button>
        <button id="focusStopBtn" class="flex items-center justify-center bg-red-50 hover:bg-red-100 text-red-600 font-medium py-3 px-6 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 hover:shadow-md">
          <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" /></svg>
          <span>Stop & Discard</span>
        </button>
    </div>
      
      <!-- Action Buttons -->
      <div id="focusActionButtons" class="flex flex-col sm:flex-row gap-3 justify-center">
        <button id="focusSaveProgressBtn" class="hidden flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 hover:shadow-lg">
          <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12" /></svg>
          <span>Save Progress</span>
        </button>
        <button id="focusCompleteBtn" class="flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-6 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 hover:shadow-lg">
          <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
        <span>Mark as Complete</span>
    </button>
      </div>
    </div>
  </div>
  
  <input type="file" id="importFile" class="hidden" accept=".json">

  <script type="module">
    // Version: 2024-01-15-v2 - Force cache refresh
    console.log('🚀 NEW VERSION LOADED - ATOMIC VS PROGRESS TASKS ENABLED!');

    // Global variables for quick selection (early initialization)
    window.quickTimeSelection = 'Quick';
    window.quickContextSelection = 'Personal';
    console.log('🔍 Quick selection initialized:', window.quickTimeSelection, window.quickContextSelection);
    
    // --- Firebase SDKs ---
    console.log('🔄 Loading Firebase scripts...');
    
    try {
        console.log('🔄 Importing Firebase App...');
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
        console.log('✅ Firebase App loaded');
        
        console.log('🔄 Importing Firebase Auth...');
        const { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
        console.log('✅ Firebase Auth loaded');
        
        console.log('🔄 Importing Firebase Firestore...');
        const { getFirestore, doc, onSnapshot, setDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
        console.log('✅ Firebase Firestore loaded');
        
        // Make functions available globally
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.setDoc = setDoc;
        
    } catch (error) {
        console.error('❌ Firebase loading failed:', error);
        console.error('❌ Error details:', error.message);
    }

    // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
    const firebaseConfig = {
      apiKey: "AIzaSyBOo5JsKHQ2ypvHuHpIiRR8sNFJutfMZVU",
      authDomain: "select-do.firebaseapp.com",
      projectId: "select-do",
      storageBucket: "select-do.firebasestorage.app",
      messagingSenderId: "800573168205",
      appId: "1:800573168205:web:40b27a550f9ba2e2b55a04"
    };

    // --- Initialize Firebase ---
    console.log('🔄 Initializing Firebase...');
    console.log('🔄 Firebase functions available:', {
        initializeApp: typeof window.initializeApp,
        getAuth: typeof window.getAuth,
        getFirestore: typeof window.getFirestore
    });
    
    const app = window.initializeApp(firebaseConfig);
    const auth = window.getAuth(app);
    const db = window.getFirestore(app);
    console.log('✅ Firebase initialized successfully');
    console.log('✅ Auth object:', auth);
    console.log('✅ DB object:', db);

    // --- GLOBAL STATE & CONSTANTS ---
    let projects = [];
    let tasks = [];
    let completedTasks = [];
    let streakData = { currentStreak: 0, lastCompletedDate: null };
    let modalTagList = [];
    let modalSelectedTime = null;
    let modalSelectedTotalTime = null;
    let modalSelectedMinSessionTime = null;
    let modalSelectedContexts = [];
    let modalSelectedEnergy = null;
    let editingTaskId = null;
    let selectedTimeFilter = null;
    let selectedContextFilters = [];
    let selectedEnergyFilters = [];
    let selectedProjectFilters = [];
    let selectedTagFilters = [];
    
    // Simplified context mode
    let selectedMode = null; // 'Work' or 'Personal'
    let advancedFiltersOpen = false;
    let originalCollapsedProjects = new Set(); // Track original collapsed state before search
    const energyLevels = ['Low 🧠', 'Medium 💪', 'High 🔥'];
    let timerInterval = null;
    let elapsedSeconds = 0;
    let isPaused = false;
    let currentFocusTaskId = null;
    let currentTask = null;
    let sessionLength = null; // Track session length for Find a task selections
    let targetTimeBracket = null;
    const originalTitle = document.title;
    let currentUser = null;
    let lastLoginDate = null; // Add this
    let userSettings = { // Add this whole object
        showDailyPlanner: true
    };
    let unsubscribeFromData = null; 
    const emptyCompletedSVG = `<svg class="w-16 h-16 mx-auto text-slate-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
    const emptyFilterSVG = `<svg class="w-16 h-16 mx-auto text-slate-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>`;
    let collapsedProjects = new Set(); // Track which projects are collapsed
    let taskReviewCollapsed = false; // Track if task review section is collapsed
    let allProjectsCollapsed = false; // Track if all projects are collapsed
    let worklogs = []; // Track individual work sessions
    let currentWorklogId = null; // Track current active work session
    let filterByPriorityOnly = false; // Track if filtering by priority tasks only

    // --- DOM ELEMENTS ---
    const loginScreen = document.getElementById('loginScreen');
    const mainApp = document.getElementById('mainApp');
    const sidebar = document.getElementById('sidebar');
    const projectsContainer = document.getElementById('projectsContainer');
    const completedTaskList = document.getElementById('completedTaskList');
    const filteredList = document.getElementById('filteredTaskList');
    const modalOverlay = document.getElementById('modalOverlay');
    const statsModalOverlay = document.getElementById('statsModalOverlay');
    const projectDeleteModalOverlay = document.getElementById('projectDeleteModalOverlay');
    const projectDeleteContent = document.getElementById('projectDeleteContent');
    const stopFocusModalOverlay = document.getElementById('stopFocusModalOverlay');
    const startTaskModalOverlay = document.getElementById('startTaskModalOverlay');
    const completeTaskModalOverlay = document.getElementById('completeTaskModalOverlay');
    const inactiveTasksModalOverlay = document.getElementById('inactiveTasksModalOverlay');
    const focusOverlay = document.getElementById('focusOverlay');
    const focusTaskName = document.getElementById('focusTaskName');
    const focusTimerDisplay = document.getElementById('focusTimerDisplay');
    const focusPauseBtn = document.getElementById('focusPauseBtn');
    const focusStopBtn = document.getElementById('focusStopBtn');
    const focusCompleteBtn = document.getElementById('focusCompleteBtn');
    const focusSaveProgressBtn = document.getElementById('focusSaveProgressBtn');
    const menuBtn = document.getElementById('menuBtn');
    const closeMenuBtn = document.getElementById('closeMenuBtn');
    const mobileHeader = document.getElementById('mobileHeader');
    const unifiedCommandInput = document.getElementById('unifiedCommandInput');
    const commandSuggestions = document.getElementById('commandSuggestions');

    // --- CORE FUNCTIONS ---
    const saveDataToFirestore = async () => {
        if (!currentUser) {
            console.log('💾 Guest mode: Data not saved (no user authenticated)');
            return;
        }
        const userDocRef = window.doc(db, 'users', currentUser.uid);
        try {
            await window.setDoc(userDocRef, { projects, tasks, completedTasks, worklogs, streakData, collapsedProjects: Array.from(collapsedProjects), taskReviewCollapsed });
        } catch (error) {
            console.error("Error saving data: ", error);
        }
    };

    const renderAll = () => {
        console.log('🎨 renderAll called - projects:', projects.length, 'tasks:', tasks.length);
        loadUserPreferences(); // Load user preferences first
        renderTasksAndProjects();
        renderCompletedTasks();
        renderWeeklyReview();
        initializeStreak();
        renderProjectFilters();
        renderTagCloud();
        setupLazyLoading(); // Setup lazy loading for performance
        console.log('🎨 renderAll completed');
    };
      
    const handleGoogleLogin = () => {
        console.log('🔐 handleGoogleLogin function called!');
        console.log('🔐 Google login clicked');
        const provider = new window.GoogleAuthProvider();
        window.signInWithPopup(auth, provider).catch(error => {
            console.error("Google login failed: ", error);
            showAuthError("Google login failed. Please try again.");
        });
    };

    const handleEmailSignUp = async () => {
        const email = document.getElementById('emailInput').value.trim();
        const password = document.getElementById('passwordInput').value;
        
        if (!email || !password) {
            showAuthError("Please enter both email and password.");
            return;
        }
        
        if (password.length < 6) {
            showAuthError("Password must be at least 6 characters long.");
            return;
        }
        
        try {
            await window.createUserWithEmailAndPassword(auth, email, password);
            // Success handled by onAuthStateChanged
        } catch (error) {
            console.error("Sign up failed: ", error);
            console.error("Error code: ", error.code);
            console.error("Error message: ", error.message);
            showAuthError(getAuthErrorMessage(error.code));
        }
    };

    const handleEmailSignIn = async () => {
        console.log('🔐 handleEmailSignIn function called!');
        const email = document.getElementById('emailInput').value.trim();
        const password = document.getElementById('passwordInput').value;
        
        if (!email || !password) {
            showAuthError("Please enter both email and password.");
            return;
        }
        
        try {
            await window.signInWithEmailAndPassword(auth, email, password);
            // Success handled by onAuthStateChanged
        } catch (error) {
            console.error("Sign in failed: ", error);
            showAuthError(getAuthErrorMessage(error.code));
        }
    };

    const showAuthError = (message) => {
        const errorDiv = document.getElementById('authError');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        setTimeout(() => {
            errorDiv.classList.add('hidden');
        }, 5000);
    };

    const getAuthErrorMessage = (errorCode) => {
        switch (errorCode) {
            case 'auth/email-already-in-use':
                return 'This email is already registered. Try signing in instead.';
            case 'auth/weak-password':
                return 'Password is too weak. Please choose a stronger password.';
            case 'auth/invalid-email':
                return 'Please enter a valid email address.';
            case 'auth/user-not-found':
                return 'No account found with this email. Try signing up instead.';
            case 'auth/wrong-password':
                return 'Incorrect password. Please try again.';
            case 'auth/too-many-requests':
                return 'Too many failed attempts. Please try again later.';
            case 'auth/operation-not-allowed':
                return 'Email/password authentication is not enabled. Please contact support or use Google sign-in.';
            case 'auth/network-request-failed':
                return 'Network error. Please check your internet connection and try again.';
            default:
                return `Authentication failed: ${errorCode}. Please try again or use Google sign-in.`;
        }
    };

    const handleLogout = () => {
        window.signOut(auth);
    };

    const showGuestMode = () => {
        console.log('🎭 showGuestMode function called!');
        console.log('🎭 Showing guest mode with example data');
        loginScreen.classList.add('hidden');
        mainApp.classList.remove('hidden');
        mainApp.classList.add('flex');
        
        // Show guest mode notice
        document.getElementById('guestModeNotice').classList.remove('hidden');
        
        // Set up guest user display
        document.getElementById('userDisplay').innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <img src="https://ui-avatars.com/api/?name=Guest&background=6b7280&color=ffffff&size=32" alt="Guest User" class="w-8 h-8 rounded-full">
                    <div>
                        <div class="font-semibold text-sm text-slate-800">Demo User</div>
                        <div class="text-xs text-slate-500">Interactive Preview</div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="guestSignUpBtn2" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-md text-xs font-medium transition-colors shadow-sm">
                        Sign up to save
                    </button>
                    <button id="guestLoginBtn" class="text-slate-400 hover:text-blue-500 p-1.5 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>
        `;
        
        // Add event listeners for guest mode buttons
        document.getElementById('guestLoginBtn').onclick = () => {
            showSignInModal();
        };
        document.getElementById('guestSignUpBtn').onclick = () => {
            showSignUpModal();
        };
        document.getElementById('guestSignUpBtn2').onclick = () => {
            showSignUpModal();
        };
        
        // Load example data
        loadExampleData();
        renderAll();
        applySmartDefaults();
        updateContentArea();
    };

    const showLoginScreen = () => {
        loginScreen.classList.remove('hidden');
        mainApp.classList.add('hidden');
        mainApp.classList.remove('flex');
    };





    const updateContentArea = () => {
        const welcomeContent = document.getElementById('welcomeContent');
        
        // Check if welcomeContent element exists
        if (!welcomeContent) {
            console.log('welcomeContent element not found, skipping updateContentArea');
            return;
        }
        
        // Check if user has any activity (completed tasks, used filters, etc.)
        const hasActivity = completedTasks.length > 0 ||
                            Boolean(selectedTimeFilter) ||
                            selectedContextFilters.length > 0 ||
                            selectedEnergyFilters.length > 0;
        
        if (hasActivity) {
            // Hide welcome content when user has activity
            welcomeContent.classList.add('hidden');
            } else {
            // Show welcome content when no activity
            welcomeContent.classList.remove('hidden');
        }
    };

    const loadExampleData = () => {
        console.log('📚 Loading example data for guest mode');
        
        // Example projects
        projects = [
            { id: 'inbox', name: 'Inbox' },
            { id: 'work', name: 'Work Projects' },
            { id: 'personal', name: 'Personal' },
            { id: 'learning', name: 'Learning' }
        ];
        
        // Example tasks - mix of Atomic and Progress
        tasks = [
            // Atomic Tasks
            {
                id: 'task_1',
                name: 'Send project update email',
                timeBracket: 'Quick',
                isDivisible: false,
                contexts: ['Work'],
                energy: 'Low 🧠',
                tags: ['communication'],
                projectId: 'work',
                isRecurring: false,
                isActive: true,
                isPriority: false
            },
            {
                id: 'task_2',
                name: 'Review meeting notes',
                timeBracket: 'Quick',
                isDivisible: false,
                contexts: ['Work'],
                energy: 'Medium 💪',
                tags: ['review'],
                projectId: 'work',
                isRecurring: false,
                isActive: true,
                isPriority: false
            },
            {
                id: 'task_3',
                name: 'Quick workout',
                timeBracket: 'Quick',
                isDivisible: false,
                contexts: ['Personal'],
                energy: 'High 🔥',
                tags: ['fitness'],
                projectId: 'personal',
                isRecurring: true,
                isActive: true,
                isPriority: false
            },
            
            // Progress Tasks
            {
                id: 'task_4',
                name: 'Read industry article',
                totalTimeBracket: 'Quick',
                sessionTimeBracket: 'Quick',
                timeSpent: 15,
                isDivisible: true,
                contexts: ['Work', 'Personal'],
                energy: 'Low 🧠',
                tags: ['learning', 'research'],
                projectId: 'learning',
                isRecurring: false,
                isActive: true,
                isPriority: false
            },
            {
                id: 'task_5',
                name: 'Draft project proposal',
                totalTimeBracket: 'Standard',
                sessionTimeBracket: 'Standard',
                timeSpent: 0,
                isDivisible: true,
                contexts: ['Work'],
                energy: 'Medium 💪',
                tags: ['writing', 'planning'],
                projectId: 'work',
                isRecurring: false,
                isActive: true,
                isPriority: false
            },
            {
                id: 'task_6',
                name: 'Learn new programming concept',
                totalTimeBracket: 'Standard',
                sessionTimeBracket: 'Standard',
                timeSpent: 45,
                isDivisible: true,
                contexts: ['Personal'],
                energy: 'High 🔥',
                tags: ['programming', 'learning'],
                projectId: 'learning',
                isRecurring: false,
                isActive: true,
                isPriority: false
            },
            {
                id: 'task_7',
                name: 'Organize home office',
                totalTimeBracket: 'Quick',
                sessionTimeBracket: 'Quick',
                timeSpent: 30,
                isDivisible: true,
                contexts: ['Personal'],
                energy: 'Medium 💪',
                tags: ['organization'],
                projectId: 'personal',
                isRecurring: false,
                isActive: true,
                isPriority: false
            }
        ];
        
        // Example completed tasks
        completedTasks = [
            {
                id: 'completed_1',
                name: 'Check emails',
                time: 5,
                isDivisible: false,
                contexts: ['Workday'],
                energy: 'Low 🧠',
                tags: ['communication'],
                projectId: 'work',
                isRecurring: true,
                completedAt: new Date().toISOString()
            },
            {
                id: 'completed_2',
                name: 'Morning meditation',
                time: 10,
                isDivisible: false,
                contexts: ['Workday', 'Evening'],
                energy: 'Low 🧠',
                tags: ['wellness'],
                projectId: 'personal',
                isRecurring: true,
                completedAt: new Date().toISOString()
            }
        ];
        
        // Example streak data
        streakData = {
            currentStreak: 3,
            lastCompletedDate: new Date().toISOString().slice(0, 10)
        };
        
        // Reset UI state
        collapsedProjects = new Set();
        taskReviewCollapsed = true;
        
        console.log('✅ Example data loaded:', { projects: projects.length, tasks: tasks.length, completedTasks: completedTasks.length });
    };

    const renderProjectFilters = () => {
        const projectFilters = document.getElementById('projectFilters');
        if (!projectFilters) {
            console.log('❌ Project filters container not found');
            return;
        }
        
        console.log('🔧 renderProjectFilters called - tasks:', tasks.length, 'projects:', projects.length);
        
        // Get all projects from tasks, excluding Inbox
        const allProjectIds = [];
        tasks.forEach(task => {
            console.log('🔍 Task:', task.name, 'projectId:', task.projectId);
            if (task.projectId && task.projectId !== 'inbox' && !allProjectIds.includes(task.projectId)) {
                allProjectIds.push(task.projectId);
            }
        });
        
        console.log('🔧 Found project IDs:', allProjectIds);
        
        if (allProjectIds.length === 0) {
            projectFilters.innerHTML = '<div class="text-sm text-slate-400 italic">No projects yet</div>';
            return;
        }
        
        // Get project names from project IDs
        const projectNames = allProjectIds.map(projectId => {
            const project = projects.find(p => p.id === projectId);
            console.log('🔍 Project ID:', projectId, 'found project:', project);
            return project ? project.name : projectId;
        });
        
        console.log('🔧 Project names:', projectNames);
        
        // Create project buttons
        projectFilters.innerHTML = projectNames.map((projectName, index) => `
            <button data-project="${allProjectIds[index]}" class="project-filter bg-slate-100 border border-slate-200 text-slate-600 hover:bg-slate-200 px-2.5 py-1 rounded-full transition-colors text-xs font-medium focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500">
                ${projectName}
            </button>
        `).join('');
    };

    const renderTagCloud = () => {
        const tagCloud = document.getElementById('tagCloud');
        if (!tagCloud) return;
        
        // Get all tags from tasks
        const allTags = [];
        tasks.forEach(task => {
            if (task.tags && Array.isArray(task.tags)) {
                task.tags.forEach(tag => allTags.push(tag));
            }
        });
        
        // Count tag frequency
        const tagCounts = {};
        allTags.forEach(tag => {
            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
        });
        
        // Get top 6 most used tags
        const popularTags = Object.entries(tagCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 6)
            .map(([tag]) => tag);
        
        if (popularTags.length === 0) {
            tagCloud.innerHTML = '<div class="text-sm text-slate-400 italic">No tags yet</div>';
            return;
        }
        
        // Create tag buttons
        tagCloud.innerHTML = popularTags.map(tag => `
            <button data-tag="${tag}" class="tag-filter bg-slate-100 border border-slate-200 text-slate-600 hover:bg-slate-200 px-2.5 py-1 rounded-full transition-colors text-xs font-medium focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500">
                #${tag}
            </button>
        `).join('');
    };

    const renderTasksAndProjects = (searchTerm = '', bypassSearchLogic = false) => {
        // Preserve the Today section
        const todayContainer = document.getElementById('todayProjectContainer');
        const todayHtml = todayContainer ? todayContainer.outerHTML : '';
        
        projectsContainer.innerHTML = '';
        
        // Restore the Today section
        if (todayHtml) {
            projectsContainer.innerHTML = todayHtml;
        }
        
        const today = new Date().toISOString().slice(0, 10);
        
        // Debug: Log current projects (temporary)
        console.log('Current projects:', projects);
        console.log('Looking for Inbox:', projects.find(p => p.id === 'inbox'));
        
        const normalizedSearch = searchTerm.trim().toLowerCase();
        const isSearching = normalizedSearch.length > 0;
        
        // Only apply search logic if not bypassed (for collapse/expand operations)
        if (!bypassSearchLogic) {
        // If starting a new search, save the current collapsed state
        if (isSearching && originalCollapsedProjects.size === 0) {
            originalCollapsedProjects = new Set(collapsedProjects);
        }
        
        // If clearing search, restore original collapsed state
        if (!isSearching && originalCollapsedProjects.size > 0) {
            collapsedProjects = new Set(originalCollapsedProjects);
            originalCollapsedProjects.clear();
            saveDataToFirestore();
            }
        }
        
        // Use the actual collapsed projects set directly
        const localCollapsedProjects = collapsedProjects;
        console.log('🔍 renderTasksAndProjects - collapsedProjects state:', Array.from(collapsedProjects));
        
        const tasksToRender = normalizedSearch
            ? tasks.filter(task => task.name.toLowerCase().includes(normalizedSearch))
            : tasks.filter(task => task.isActive !== false); // Only show active tasks in sidebar

        projects.forEach(project => {
            // Add a filter to exclude tasks that are already in the "Today" list
            // Include tasks with dailyPlanDate === null or dailyPlanDate !== today
            const projectTasks = tasksToRender.filter(task => 
                task.projectId === project.id && 
                (task.dailyPlanDate === null || task.dailyPlanDate !== today)
            );
            
            console.log(`Project: ${project.name} (${project.id})`);
            console.log(`  - All tasks: ${tasks.length}`);
            console.log(`  - Tasks to render: ${tasksToRender.length}`);
            console.log(`  - Project tasks: ${projectTasks.length}`);
            console.log(`  - Project tasks:`, projectTasks);
            
            // Show projects if they have tasks, or if it's the Inbox, or if there are no tasks at all
            if (projectTasks.length === 0 && project.id !== 'inbox' && tasks.length > 0) {
                console.log(`  - Hiding project ${project.name} (no tasks)`);
                return;
            }

            // Auto-expand collapsed projects when search finds tasks in them
            const shouldAutoExpand = normalizedSearch && projectTasks.length > 0 && localCollapsedProjects.has(project.id);
            if (shouldAutoExpand) {
                localCollapsedProjects.delete(project.id);
            }

            const projectDiv = document.createElement('div');
            projectDiv.className = 'project-group';
            
            const projectHeader = document.createElement('div');
            // Special styling for Inbox project - same color as View Stats button
            const isInbox = project.id === 'inbox';
            const headerBgClass = isInbox ? 'bg-slate-100 hover:bg-slate-200' : 'hover:bg-slate-50';
            projectHeader.className = `group flex items-center justify-between cursor-pointer ${headerBgClass} p-2 rounded-lg transition-colors`;
            projectHeader.dataset.projectId = project.id;
            
            const headerContent = document.createElement('h3');
            headerContent.className = 'font-medium text-slate-900 flex items-center text-sm sidebar-header';
            
            // Create project name with optional task count badge
            const projectNameSpan = document.createElement('span');
            projectNameSpan.textContent = project.name;
            headerContent.appendChild(projectNameSpan);
            
            // Add task count badge if project is collapsed and has tasks
            const isProjectCollapsed = localCollapsedProjects.has(project.id);
            if (isProjectCollapsed && projectTasks.length > 0) {
                const taskCountBadge = document.createElement('span');
                taskCountBadge.className = 'ml-2 bg-slate-200 text-slate-600 text-xs font-medium rounded-full w-5 h-5 flex items-center justify-center';
                taskCountBadge.textContent = projectTasks.length;
                headerContent.appendChild(taskCountBadge);
            }
            
            // Add hover-triggered edit and delete project buttons (only for non-inbox projects)
            if (project.id !== 'inbox') {
                const editProjectBtn = document.createElement('button');
                editProjectBtn.className = 'opacity-0 group-hover:opacity-100 ml-2 text-slate-400 hover:text-blue-500 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200';
                editProjectBtn.innerHTML = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>`;
                editProjectBtn.setAttribute('data-project-id', project.id);
                editProjectBtn.setAttribute('data-action', 'edit-project');
                headerContent.appendChild(editProjectBtn);
                
                const deleteProjectBtn = document.createElement('button');
                deleteProjectBtn.className = 'opacity-0 group-hover:opacity-100 ml-2 text-slate-400 hover:text-red-500 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 transition-all duration-200';
                deleteProjectBtn.innerHTML = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>`;
                deleteProjectBtn.setAttribute('data-project-id', project.id);
                deleteProjectBtn.setAttribute('data-action', 'delete-project');
                headerContent.appendChild(deleteProjectBtn);
            }
            
            const collapseBtn = document.createElement('button');
            collapseBtn.className = 'text-slate-400 hover:text-slate-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
            collapseBtn.innerHTML = `<svg class="w-5 h-5 collapse-icon ${localCollapsedProjects.has(project.id) ? 'collapsed' : 'expanded'}" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>`;
            
            projectHeader.appendChild(headerContent);
            projectHeader.appendChild(collapseBtn);
            projectDiv.appendChild(projectHeader);
            
            const projectContent = document.createElement('div');
            const isCollapsed = localCollapsedProjects.has(project.id);
            console.log(`Project ${project.name} (${project.id}) - isCollapsed: ${isCollapsed}, localCollapsedProjects:`, Array.from(localCollapsedProjects));
            projectContent.className = `project-content ${isCollapsed ? 'collapsed' : 'expanded'}`;
            projectContent.setAttribute('data-project-id', project.id);
            
            if (projectTasks.length > 0) {
                console.log(`  - Rendering ${projectTasks.length} tasks for ${project.name}`);
                projectTasks.forEach(task => {
                    console.log(`    - Rendering task: ${task.name}`);
                    const taskDiv = document.createElement('div');
                    taskDiv.className = 'group flex items-center p-1.5 rounded-lg hover:bg-slate-100 transition-colors duration-150';
                    taskDiv.setAttribute('data-task-container-id', task.id);
                    taskDiv.innerHTML = `
                        <button data-task-id="${task.id}" class="priority-toggle-btn text-slate-300 hover:text-yellow-500 mr-2 shrink-0 transition-colors focus:outline-none focus:ring-2 focus:ring-yellow-500 rounded-full">
                            ${task.isPriority ? 
                                `<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>` : 
                                `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg>`
                            }
                        </button>
                        <button data-task-id="${task.id}" class="quick-complete-btn text-slate-300 hover:text-green-500 mr-3 shrink-0 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 rounded-full">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </button>
                        <div class="flex-grow cursor-pointer" data-task-id="${task.id}" data-action="quick-edit">
                          <div class="font-medium text-slate-800 flex items-center text-sm">
                            <span class="task-name cursor-pointer hover:text-blue-600 transition-colors" data-task-id="${task.id}">${task.name}</span>
                            ${task.dailyPlanDate === new Date().toISOString().slice(0, 10) ? `<span class="ml-1 text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded-full font-medium">🌟 Today</span>` : ''}
                            ${task.isRecurring ? `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-2 text-blue-500 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>` : ''}
                            ${task.isDivisible ? `<span class="ml-1 text-xs bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded-full font-medium">P</span>` : `<span class="ml-1 text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-full font-medium">A</span>`}
                          </div>
                          <div class="text-xs text-slate-500">${task.isDivisible ? `${task.totalTimeBracket || task.sessionTimeBracket || task.minSessionTime || task.totalTime || 'Standard'}` : `${task.totalTimeBracket || task.timeBracket || task.time || 'Quick'}`}${task.energy ? ` • ${task.energy}` : ''}</div>
                          ${task.isDivisible && task.timeSpent > 0 ? `
                            <div class="mt-0.5">
                              <div class="text-xs text-slate-400">
                                <span>Time spent: ${task.timeSpent} min</span>
                              </div>
                            </div>
                          ` : ''}
                        </div>
                        <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                          <button data-task-id="${task.id}" class="edit-btn text-slate-400 hover:text-blue-500 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                          </button>
                          <button data-task-id="${task.id}" class="delete-btn text-slate-400 hover:text-red-500 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                            <svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.48.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                          </button>
                        </div>
                    `;
                    projectContent.appendChild(taskDiv);
                });
            } else if (project.id === 'inbox') {
                const emptyStateDiv = document.createElement('div');
                emptyStateDiv.className = 'text-center text-slate-400 p-3 text-xs rounded-lg bg-slate-50';
                emptyStateDiv.textContent = 'All clear!';
                projectContent.appendChild(emptyStateDiv);
            }
            
            projectDiv.appendChild(projectContent);
            projectsContainer.appendChild(projectDiv);
        });
        
        // Render Today's tasks after all other projects
        renderTodayProject();
    };
      
    const renderCompletedTasks = () => {
        const today = new Date().toISOString().slice(0, 10);
        const tasksCompletedToday = completedTasks.filter(task => task.completedAt && task.completedAt.slice(0, 10) === today);
        
        // Update the collapse icon state
        const collapseIcon = document.querySelector('.task-review-collapse-icon');
        if (collapseIcon) {
            // Remove existing classes and add new ones
            collapseIcon.classList.remove('collapsed', 'expanded');
            collapseIcon.classList.add(taskReviewCollapsed ? 'collapsed' : 'expanded');
        }
        
        // Update the content container state
        const contentContainer = document.getElementById('taskReviewContent');
        if (contentContainer) {
            // Remove existing classes and add new ones
            contentContainer.classList.remove('collapsed', 'expanded');
            contentContainer.classList.add(taskReviewCollapsed ? 'collapsed' : 'expanded');
        }
        
        // Only render content if not collapsed
        if (taskReviewCollapsed) {
            return;
        }
        
        completedTaskList.innerHTML = '';
        
        if (tasksCompletedToday.length === 0) {
            completedTaskList.innerHTML = `<div class="text-center text-slate-400 p-4 rounded-lg mt-2 text-sm">
                ${emptyCompletedSVG}
                <p class="mt-2 font-medium text-slate-500">No tasks completed yet</p>
                <p>Start a task to see your progress here.</p>
            </div>`;
            return;
        }
        tasksCompletedToday.forEach(task => {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-3 p-2 text-slate-400';
            div.innerHTML = `<svg class="w-5 h-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 20 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg><span class="line-through text-sm">${task.name}</span>`;
            completedTaskList.appendChild(div);
        });
    };

    const renderTodayProject = () => {
        const today = new Date().toISOString().slice(0, 10);
        const todayTasks = tasks.filter(task => task.dailyPlanDate === today);
        const container = document.getElementById('todayProjectContainer');

        console.log('🔍 renderTodayProject called - today:', today);
        console.log('🔍 All tasks:', tasks);
        console.log('🔍 todayTasks found:', todayTasks.length);
        console.log('🔍 todayTasks:', todayTasks);

        if (!container) {
            console.error('❌ todayProjectContainer element not found!');
            return;
        }

        if (todayTasks.length === 0) {
            console.log('🔍 No tasks for today, showing empty state');
            container.innerHTML = `
                <div class="project-group">
                    <div class="group flex items-center justify-between bg-amber-50 hover:bg-amber-100 p-2 rounded-lg">
                        <h3 class="font-semibold text-amber-800 flex items-center text-sm sidebar-header">🌟 Today</h3>
                        <div class="flex items-center gap-2">
                            <span class="ml-2 bg-amber-200 text-amber-800 text-xs font-medium rounded-full w-5 h-5 flex items-center justify-center">0</span>
                            <button onclick="showDailyPlannerModal()" class="opacity-0 group-hover:opacity-100 transition-opacity duration-200 text-amber-600 hover:text-amber-800 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-1 rounded px-1 py-0.5" title="Open Daily Planner">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="project-content expanded">
                        <div class="text-center text-slate-400 p-3 text-xs rounded-lg bg-slate-50">
                            No tasks planned for today
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        // This is a simplified version of your project rendering logic
        let tasksHtml = todayTasks.map(task => {
            // Get current context (Work or Personal)
            const currentContext = task.contexts && task.contexts.length > 0 ? task.contexts[0] : 'Personal';
            const isWork = currentContext === 'Work';
            
            
            return `
            <div class="group flex items-center p-1.5 rounded-lg hover:bg-slate-100 transition-colors duration-150" data-task-container-id="${task.id}">
                <button data-task-id="${task.id}" class="quick-complete-btn text-slate-300 hover:text-green-500 mr-3 shrink-0">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
                <div class="flex-grow">
                    <div class="font-medium text-slate-800 text-sm">${task.name}</div>
                    <div class="text-xs text-slate-500 mt-1">
                        ${task.totalTimeBracket || task.timeBracket || 'Quick'} • ${isWork ? 'Work' : 'Personal'}
                    </div>
                </div>
                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editTodayTask('${task.id}')" class="text-slate-400 hover:text-blue-500 p-1 rounded" title="Edit task">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                    </button>
                    <button onclick="convertTodayTaskToProject('${task.id}')" class="text-slate-400 hover:text-purple-500 p-1 rounded" title="Move to project">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" /></svg>
                    </button>
                    <button onclick="deleteTodayTask('${task.id}')" class="text-slate-400 hover:text-red-500 p-1 rounded" title="Delete task">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                    </button>
                </div>
            </div>`;
        }).join('');

        container.innerHTML = `
        <div class="project-group">
            <div class="group flex items-center justify-between bg-amber-50 hover:bg-amber-100 p-2 rounded-lg">
                <h3 class="font-semibold text-amber-800 flex items-center text-sm sidebar-header">🌟 Today</h3>
                <div class="flex items-center gap-2">
                    <span class="ml-2 bg-amber-200 text-amber-800 text-xs font-medium rounded-full w-5 h-5 flex items-center justify-center">${todayTasks.length}</span>
                    <button onclick="showDailyPlannerModal()" class="opacity-0 group-hover:opacity-100 transition-opacity duration-200 text-amber-600 hover:text-amber-800 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-1 rounded px-1 py-0.5" title="Open Daily Planner">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    </button>
                </div>
            </div>
            <div class="project-content expanded">${tasksHtml}</div>
        </div>
        `;
    };

    const renderWeeklyReview = () => {
        const weeklyReviewContent = document.getElementById('weeklyReviewContent');
        if (!weeklyReviewContent) return;
        
        // Only render content if task review is not collapsed
        if (taskReviewCollapsed) {
            return;
        }
        
        // Get worklog analytics for the past 7 days
        const analytics = getWorklogAnalytics(7);
        
        // Calculate weekly data
        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        const weekAgoStr = weekAgo.toISOString().slice(0, 10);
        const todayStr = today.toISOString().slice(0, 10);
        
        // Tasks completed this week
        const tasksThisWeek = completedTasks.filter(t => 
            t.completedAt && t.completedAt.slice(0, 10) >= weekAgoStr && t.completedAt.slice(0, 10) <= todayStr
        );
        
        // Count inactive tasks for Review Nudge
        const inactiveTasks = tasks.filter(task => task.isActive === false);
        const inactiveCount = inactiveTasks.length;
        
        
        // Check if we have any data (worklogs or completed tasks)
        const tasksToShow = tasksThisWeek;
        
        if (analytics.totalSessions === 0 && tasksToShow.length === 0) {
            weeklyReviewContent.innerHTML = `
                <div class="text-center text-slate-500 py-8">
                    <div class="text-4xl mb-3">📊</div>
                    <h3 class="font-semibold text-slate-700 mb-2">No Data Yet</h3>
                    <p class="text-sm">Start working on tasks to see your weekly insights here!</p>
                    <p class="text-xs text-slate-400 mt-2">Focus sessions and completed tasks will appear in your analytics.</p>
                </div>
            `;
            return;
        }
        
        // Use worklog data for more accurate time tracking, fallback to estimated time
        let focusTimeHours;
        if (analytics.totalTime > 0) {
            focusTimeHours = Math.round((analytics.totalTime / 60) * 10) / 10;
        } else {
            // Fallback to estimated time from completed tasks
            const timeBracketMinutes = { 'Quick': 10, 'Standard': 30, 'Long': 67.5 };
            const estimatedTime = tasksToShow.reduce((total, task) => {
                if (task.timeBracket) {
                    return total + (timeBracketMinutes[task.timeBracket] || 30);
                } else if (task.totalTimeBracket) {
                    return total + (timeBracketMinutes[task.totalTimeBracket] || 30);
                } else if (task.time) {
                    return total + task.time;
                }
                return total + 30; // Default fallback
            }, 0);
            focusTimeHours = Math.round((estimatedTime / 60) * 10) / 10;
        }
        
        // Use worklog analytics for context performance, fallback to task analysis
        let mostProductiveContext = 'Work';
        const contextCounts = { 'Work': 0, 'Personal': 0 };
        
        if (analytics.sessionsByContext['Work'] && analytics.sessionsByContext['Personal']) {
            mostProductiveContext = analytics.sessionsByContext['Work'].time > analytics.sessionsByContext['Personal'].time ? 'Work' : 'Personal';
        } else {
            // Fallback to analyzing completed tasks
            tasksToShow.forEach(task => {
                if (task.contexts && task.contexts.length > 0) {
                    task.contexts.forEach(context => {
                        if (context === 'Work' || context === 'Personal') {
                            contextCounts[context]++;
                        }
                    });
                }
            });
            mostProductiveContext = contextCounts['Work'] > contextCounts['Personal'] ? 'Work' : 'Personal';
        }
        
        // Calculate context ratio for display
        const contextRatio = contextCounts['Work'] > 0 && contextCounts['Personal'] > 0 
            ? Math.round((contextCounts['Work'] / contextCounts['Personal']) * 10) / 10 
            : 0;
        
        // Time bracket distribution
        const timeBracketCounts = { 'Quick': 0, 'Standard': 0, 'Long': 0 };
        tasksToShow.forEach(task => {
            if (task.timeBracket) {
                timeBracketCounts[task.timeBracket]++;
            } else if (task.totalTimeBracket) {
                timeBracketCounts[task.totalTimeBracket]++;
            }
        });
        
        const preferredTimeBracket = Object.keys(timeBracketCounts).reduce((a, b) => 
            timeBracketCounts[a] > timeBracketCounts[b] ? a : b, 'Standard'
        );
        
        // Progress tasks completed
        const progressTasksCompleted = tasksThisWeek.filter(task => task.isDivisible).length;
        const atomicTasksCompleted = tasksThisWeek.filter(task => !task.isDivisible).length;
        
        // Longest streak
        const longestStreak = Math.max(streakData.currentStreak, streakData.longestStreak || 0);
        
        // Tasks not touched in a while
        const untouchedTasks = tasks.filter(task => {
            const lastWeekTasks = tasksThisWeek.filter(ct => ct.taskId === task.id);
            return lastWeekTasks.length === 0 && (task.timeSpent || 0) === 0;
        }).slice(0, 3);
        
        weeklyReviewContent.innerHTML = `
            <div class="space-y-4 text-sm">
                ${inactiveCount > 0 ? `
                <!-- Review Nudge -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center flex-1">
                            <svg class="w-5 h-5 text-slate-600 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                            </svg>
                            <span class="text-slate-700 text-sm">Ready for More? You have <strong>${inactiveCount}</strong> inactive task${inactiveCount === 1 ? '' : 's'}.</span>
                        </div>
                        <button id="reviewInactiveBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-medium px-3 py-1.5 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 flex-shrink-0">
                            Review Them
                        </button>
                    </div>
                </div>
                ` : ''}
                <!-- Weekly Summary -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                    <h3 class="font-semibold text-slate-800 mb-2 flex items-center text-sm">
                        <span class="text-lg mr-2">📈</span>
                        This Week's Summary
                    </h3>
                    <p class="text-slate-700 leading-relaxed text-xs">
                        You completed <strong>${tasksToShow.length} tasks</strong> this week${analytics.totalSessions > 0 ? ` in <strong>${analytics.totalSessions} focus sessions</strong>` : ''}, spending 
                        <strong>${focusTimeHours} hours</strong> in focus mode. You were most productive in 
                        <strong>${mostProductiveContext}</strong> context. Your longest streak is 
                        <strong>${longestStreak} days</strong>.
                    </p>
                </div>
                
                <!-- Productivity Insights -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-slate-50 p-3 rounded-lg">
                        <h4 class="font-semibold text-slate-800 mb-2 flex items-center text-xs">
                            <span class="text-sm mr-2">🎯</span>
                            Context Performance
                        </h4>
                        <p class="text-xs text-slate-600 mb-1">Most productive context:</p>
                        <div class="text-sm font-semibold text-slate-800">${mostProductiveContext}</div>
                        <div class="text-xs text-slate-500 mt-1">
                            ${contextCounts[mostProductiveContext]} tasks completed
                            ${contextRatio > 1 ? `(${contextRatio}:1 ratio)` : ''}
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 p-3 rounded-lg">
                        <h4 class="font-semibold text-slate-800 mb-2 flex items-center text-xs">
                            <span class="text-sm mr-2">⏱️</span>
                            Time Patterns
                        </h4>
                        <p class="text-xs text-slate-600 mb-1">Preferred time bracket:</p>
                        <div class="text-sm font-semibold text-slate-800">${preferredTimeBracket}</div>
                        <div class="text-xs text-slate-500 mt-1">
                            ${timeBracketCounts['Quick']} Quick • ${timeBracketCounts['Standard']} Standard • ${timeBracketCounts['Long']} Long
                        </div>
                    </div>
                </div>
                
                <!-- Task Type Breakdown -->
                <div class="bg-slate-50 p-3 rounded-lg">
                    <h4 class="font-semibold text-slate-800 mb-2 flex items-center text-xs">
                        <span class="text-sm mr-2">📊</span>
                        Task Breakdown
                    </h4>
                    <div class="grid grid-cols-2 gap-4 text-xs">
                        <div>
                            <div class="text-slate-600">Atomic Tasks</div>
                            <div class="font-semibold text-slate-800">${atomicTasksCompleted}</div>
                        </div>
                        <div>
                            <div class="text-slate-600">Progress Tasks</div>
                            <div class="font-semibold text-slate-800">${progressTasksCompleted}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Progress Tasks by Time Spent -->
                ${(() => {
                    // Get all Progress tasks with time spent, sorted by time spent
                    const progressTasksWithTime = tasks
                        .filter(task => task.isDivisible && (task.timeSpent || 0) > 0)
                        .sort((a, b) => (b.timeSpent || 0) - (a.timeSpent || 0))
                        .slice(0, 5); // Top 5
                    
                    if (progressTasksWithTime.length === 0) return '';
                    
                    const formatTime = (minutes) => {
                        const hours = Math.floor(minutes / 60);
                        const mins = Math.round(minutes % 60);
                        if (hours > 0) {
                            return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
                        }
                        return `${mins}m`;
                    };
                    
                    return `
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-3 rounded-lg border border-purple-200">
                        <h4 class="font-semibold text-slate-800 mb-3 flex items-center text-xs">
                            <span class="text-sm mr-2">⏰</span>
                            Most Time Spent on Progress Tasks
                        </h4>
                        <div class="space-y-2">
                            ${progressTasksWithTime.map((task, index) => `
                                <div class="flex items-center justify-between bg-white p-2 rounded border border-purple-100">
                                    <div class="flex items-center">
                                        <span class="text-xs text-slate-500 w-4 mr-2">${index + 1}.</span>
                                        <span class="text-xs text-slate-700 font-medium">${task.name}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-purple-600 bg-purple-100 px-2 py-0.5 rounded">
                                            ${formatTime(task.timeSpent || 0)}
                                        </span>
                                        ${task.totalTimeBracket ? `
                                            <span class="text-xs text-slate-500">
                                                ${task.totalTimeBracket}
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <p class="text-xs text-purple-700 mt-2">
                            These are your most worked-on Progress tasks. Keep building momentum!
                        </p>
                    </div>
                    `;
                })()}
                
                <!-- Neglected Tasks -->
                ${untouchedTasks.length > 0 ? `
                <div class="bg-amber-50 p-3 rounded-lg border border-amber-200">
                    <h4 class="font-semibold text-amber-800 mb-2 flex items-center text-xs">
                        <span class="text-sm mr-2">⏰</span>
                        Tasks You Haven't Touched
                    </h4>
                    <div class="space-y-1">
                        ${untouchedTasks.map(task => `
                            <div class="flex items-center justify-between bg-white p-2 rounded border border-amber-100">
                                <span class="text-xs text-slate-700">${task.name}</span>
                                <span class="text-xs text-amber-600 bg-amber-100 px-2 py-0.5 rounded">
                                    ${task.timeBracket || task.totalTimeBracket || 'Standard'}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-xs text-amber-700 mt-2">Consider scheduling these tasks or breaking them into smaller chunks.</p>
                </div>
                ` : ''}
                
                <!-- Motivational Message -->
                <div class="bg-green-50 p-3 rounded-lg border border-green-200 text-center">
                    <h4 class="font-semibold text-green-800 mb-1 flex items-center justify-center text-xs">
                        <span class="text-sm mr-2">🌟</span>
                        Keep Up the Great Work!
                    </h4>
                    <p class="text-xs text-green-700">
                        ${tasksThisWeek.length >= 10 ? 
                            "You're on fire this week! Your consistency is impressive." :
                            tasksThisWeek.length >= 5 ?
                            "Great progress this week! You're building solid habits." :
                            "Every task completed is a step forward. Keep going!"
                        }
                    </p>
                </div>
            </div>
        `;
    };

    const populateProjectDropdown = () => {
        const projectSelect = document.getElementById('projectSelect');
        projectSelect.innerHTML = '';
        console.log('Populating project dropdown with projects:', projects);
        
        // Add existing projects
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelect.appendChild(option);
            console.log('Added project option:', project.name, project.id);
        });
        
        // Add "New Project" option at the end
        const newProjectOption = document.createElement('option');
        newProjectOption.value = 'new-project';
        newProjectOption.textContent = '+ New Project';
        projectSelect.appendChild(newProjectOption);
    };

    const resetModal = () => {
        document.getElementById('taskName').value = '';
        document.getElementById('taskTags').value = '';
        document.getElementById('taskRecurring').checked = false;
        document.getElementById('taskDivisible').checked = false;
        document.getElementById('taskActive').checked = true; // Default to active for new tasks
        modalTagList = [];
        modalSelectedTime = null;
        modalSelectedTotalTime = null;
        modalSelectedMinSessionTime = null;
        modalSelectedContexts = [];
        modalSelectedEnergy = null;
        editingTaskId = null;
        document.getElementById('projectSelect').value = 'inbox';
        renderTagPreview();
        toggleTimeSections();
        document.querySelectorAll('.modal-time-btn, .modal-total-time-btn, .modal-min-session-btn, .modal-context-btn, .modal-energy-btn').forEach(b => {b.classList.remove('bg-blue-500','text-white','border-blue-500');b.classList.add('bg-white','text-slate-700')});
        
        // Hide new project input and reset dropdown
        hideNewProjectInput();
        
        // Clear custom time inputs (no longer used with time brackets)
    };

    // Store the element that had focus before modal opened
    let previousActiveElement = null;

    // --- PERFORMANCE OPTIMIZATION VARIABLES ---
    let searchDebounceTimer = null;
    let taskSuggestionsCache = new Map();
    let lastSearchQuery = '';
    let lastModeFilter = null;
    let lastTimeFilter = null;

    // --- USER PREFERENCES ---
    let userPreferences = {
        theme: 'system', // 'light', 'dark', 'system'
        fontSize: 'medium', // 'small', 'medium', 'large', 'extra-large'
        reducedMotion: false
    };

    // Cache invalidation function
    const invalidateTaskCache = () => {
        taskSuggestionsCache.clear();
        console.log('🗑️ Task suggestions cache cleared');
    };

    // --- THEME AND FONT SIZE MANAGEMENT ---
    const loadUserPreferences = () => {
        const saved = localStorage.getItem('userPreferences');
        if (saved) {
            userPreferences = { ...userPreferences, ...JSON.parse(saved) };
        }
        applyUserPreferences();
    };

    const saveUserPreferences = () => {
        localStorage.setItem('userPreferences', JSON.stringify(userPreferences));
    };

    const applyUserPreferences = () => {
        // Apply theme
        const root = document.documentElement;
        const isDark = userPreferences.theme === 'dark' || 
                      (userPreferences.theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        
        root.classList.toggle('dark', isDark);
        
        // Apply font size
        root.className = root.className.replace(/text-\w+-size/g, '');
        root.classList.add(`text-${userPreferences.fontSize}-size`);
        
        // Apply reduced motion
        root.classList.toggle('reduce-motion', userPreferences.reducedMotion);
        
        console.log('🎨 Applied user preferences:', userPreferences);
    };

    const setTheme = (theme) => {
        userPreferences.theme = theme;
        saveUserPreferences();
        applyUserPreferences();
    };

    const setFontSize = (size) => {
        userPreferences.fontSize = size;
        saveUserPreferences();
        applyUserPreferences();
    };

    const toggleTheme = () => {
        const themes = ['light', 'dark', 'system'];
        const currentIndex = themes.indexOf(userPreferences.theme);
        const nextIndex = (currentIndex + 1) % themes.length;
        setTheme(themes[nextIndex]);
    };

    // --- SETTINGS MODAL FUNCTIONS ---
    const showSettingsModal = () => {
        document.body.classList.add('overflow-hidden');
        showModal(document.getElementById('settingsModalOverlay'));
        loadSettingsIntoModal();
    };

    const closeSettingsModal = () => {
        document.body.classList.remove('overflow-hidden');
        hideModal(document.getElementById('settingsModalOverlay'));
    };

    const loadSettingsIntoModal = () => {
        // Set theme radio button
        document.querySelector(`input[name="theme"][value="${userPreferences.theme}"]`).checked = true;
        
        // Set font size radio button
        document.querySelector(`input[name="fontSize"][value="${userPreferences.fontSize}"]`).checked = true;
        
        // Set reduced motion checkbox
        document.getElementById('reducedMotion').checked = userPreferences.reducedMotion;
    };

    const saveSettings = () => {
        // Get theme selection
        const selectedTheme = document.querySelector('input[name="theme"]:checked').value;
        userPreferences.theme = selectedTheme;
        
        // Get font size selection
        const selectedFontSize = document.querySelector('input[name="fontSize"]:checked').value;
        userPreferences.fontSize = selectedFontSize;
        
        // Get reduced motion setting
        userPreferences.reducedMotion = document.getElementById('reducedMotion').checked;
        
        // Save and apply preferences
        saveUserPreferences();
        applyUserPreferences();
        
        closeSettingsModal();
        console.log('✅ Settings saved:', userPreferences);
    };

    const resetSettings = () => {
        userPreferences = {
            theme: 'system',
            fontSize: 'medium',
            reducedMotion: false
        };
        saveUserPreferences();
        applyUserPreferences();
        loadSettingsIntoModal();
        console.log('🔄 Settings reset to defaults');
    };

    // Virtual scrolling configuration
    const VIRTUAL_SCROLL_CONFIG = {
        itemHeight: 60, // Approximate height of each task item
        containerHeight: 400, // Height of the visible container
        bufferSize: 5 // Number of items to render outside visible area
    };

    // Virtual scrolling function for large lists
    const renderVirtualList = (items, containerId, renderItemFn, enableVirtualScrolling = false) => {
        const container = document.getElementById(containerId);
        if (!container) return;

        // If virtual scrolling is disabled or list is small, render normally
        if (!enableVirtualScrolling || items.length <= 20) {
            container.innerHTML = items.map(renderItemFn).join('');
            return;
        }

        // Calculate visible range
        const scrollTop = container.scrollTop || 0;
        const startIndex = Math.max(0, Math.floor(scrollTop / VIRTUAL_SCROLL_CONFIG.itemHeight) - VIRTUAL_SCROLL_CONFIG.bufferSize);
        const endIndex = Math.min(items.length - 1, startIndex + Math.ceil(VIRTUAL_SCROLL_CONFIG.containerHeight / VIRTUAL_SCROLL_CONFIG.itemHeight) + VIRTUAL_SCROLL_CONFIG.bufferSize);
        
        // Render only visible items
        const visibleItems = items.slice(startIndex, endIndex + 1);
        const topOffset = startIndex * VIRTUAL_SCROLL_CONFIG.itemHeight;
        const totalHeight = items.length * VIRTUAL_SCROLL_CONFIG.itemHeight;

        container.innerHTML = `
            <div style="height: ${totalHeight}px; position: relative;">
                <div style="transform: translateY(${topOffset}px);">
                    ${visibleItems.map(renderItemFn).join('')}
                </div>
            </div>
        `;
    };

    // Lazy loading for task details
    const lazyLoadTaskDetails = (taskId) => {
        // This would be called when a task is expanded or viewed in detail
        // For now, we'll just log it - in a real implementation, you'd load additional data
        console.log(`🔄 Lazy loading details for task: ${taskId}`);
        
        // Example: Load additional task metadata, comments, attachments, etc.
        // This could make API calls or load from a separate data source
        return Promise.resolve({
            id: taskId,
            details: 'Task details loaded on demand',
            loadedAt: new Date().toISOString()
        });
    };

    // Intersection Observer for lazy loading
    const setupLazyLoading = () => {
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const taskId = entry.target.dataset.taskId;
                        if (taskId) {
                            lazyLoadTaskDetails(taskId);
                            observer.unobserve(entry.target);
                        }
                    }
                });
            }, { rootMargin: '50px' });

            // Observe all task elements for lazy loading
            document.querySelectorAll('[data-task-id]').forEach(el => {
                observer.observe(el);
            });
        }
    };

    // Performance monitoring
    const performanceMonitor = {
        startTime: 0,
        startTimer: (label) => {
            performanceMonitor.startTime = performance.now();
            console.log(`⏱️ Starting ${label}...`);
        },
        endTimer: (label) => {
            const duration = performance.now() - performanceMonitor.startTime;
            console.log(`⏱️ ${label} completed in ${duration.toFixed(2)}ms`);
            return duration;
        },
        logCacheStats: () => {
            console.log(`📊 Cache stats: ${taskSuggestionsCache.size} entries cached`);
        }
    };

    // Helper function to show modal with proper accessibility
    const showModal = (modalElement) => {
        // Store the currently focused element
        previousActiveElement = document.activeElement;
        
        modalElement.classList.remove('hidden');
        modalElement.removeAttribute('inert');
        modalElement.setAttribute('aria-hidden', 'false');
        
        // Focus the first focusable element in the modal
        const focusableElements = modalElement.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        if (focusableElements.length > 0) {
            focusableElements[0].focus();
        }
    };

    // Helper function to hide modal with proper accessibility
    const hideModal = (modalElement) => {
        modalElement.classList.add('hidden');
        modalElement.setAttribute('inert', '');
        modalElement.setAttribute('aria-hidden', 'true');
        
        // Restore focus to the previously focused element
        if (previousActiveElement && previousActiveElement.focus) {
            previousActiveElement.focus();
        }
        previousActiveElement = null;
    };

    const openModal = (mode = 'add') => {
        document.body.classList.add('overflow-hidden');
        populateProjectDropdown();
        document.getElementById('modalTitle').textContent = mode === 'add' ? 'Add New Task' : 'Edit Task';
        showModal(modalOverlay);
        
        // Test if new elements exist
        const taskDivisible = document.getElementById('taskDivisible');
        const atomicSection = document.getElementById('atomicTimeSection');
        const progressSection = document.getElementById('progressTimeSection');
        
        if (taskDivisible && atomicSection && progressSection) {
            updateTaskTypeButtons();
            toggleTimeSections();
        }
    };
    const closeModal = () => {
        document.body.classList.remove('overflow-hidden');
        hideModal(modalOverlay);
        resetModal();
    };
    const renderTagPreview = () => {
        const tagDiv = document.getElementById('tagPreview');
        tagDiv.innerHTML = modalTagList.map((tag, i) => `<span class="bg-slate-200 text-slate-700 text-sm font-medium px-2 py-1 rounded-md flex items-center">${tag}<button data-tag-index="${i}" class="remove-tag-btn ml-2 text-slate-400 hover:text-red-500 font-bold focus:outline-none focus:ring-1 focus:ring-red-500 rounded-full">&times;</button></span>`).join('');
    };
    const saveTask = () => {
        console.log('🔧 Save task called with values:');
        console.log('🔧 modalSelectedTime:', modalSelectedTime);
        console.log('🔧 modalSelectedTotalTime:', modalSelectedTotalTime);
        console.log('🔧 modalSelectedMinSessionTime:', modalSelectedMinSessionTime);
        console.log('🔧 modalSelectedContexts:', modalSelectedContexts);
        console.log('🔧 modalSelectedEnergy:', modalSelectedEnergy);
        
        const name = document.getElementById('taskName').value.trim();
        const projectId = document.getElementById('projectSelect').value;
        const isRecurring = document.getElementById('taskRecurring').checked;
        const taskDivisible = document.getElementById('taskDivisible');
        const isDivisible = taskDivisible ? taskDivisible.checked : false;
        const isActive = document.getElementById('taskActive').checked;
        
        // Validation for Atomic tasks
        if (!isDivisible && (!name || !modalSelectedTime || modalSelectedContexts.length === 0)) {
          console.log('🔧 Atomic task validation failed:');
          console.log('🔧 name:', name);
          console.log('🔧 modalSelectedTime:', modalSelectedTime);
          console.log('🔧 modalSelectedContexts:', modalSelectedContexts);
          alert('Please provide a task name, time bracket, and context.');
          return;
        }
        
        // Validation for Progress tasks
        if (isDivisible && (!name || !modalSelectedTotalTime || !modalSelectedMinSessionTime || modalSelectedContexts.length === 0)) {
            console.log('🔧 Progress task validation failed:');
            console.log('🔧 name:', name);
            console.log('🔧 modalSelectedTotalTime:', modalSelectedTotalTime);
            console.log('🔧 modalSelectedMinSessionTime:', modalSelectedMinSessionTime);
            console.log('🔧 modalSelectedContexts:', modalSelectedContexts);
            alert('Please provide a task name, total time bracket, session time bracket, and context.');
            return;
        }
        
        if (!editingTaskId) {
            const isDuplicate = tasks.some(task => task.name.toLowerCase() === name.toLowerCase());
            if (isDuplicate) {
                alert('A task with this name already exists. Please choose a different name.');
                return;
            }
        }
        
        // Create task object based on type
        let taskData;
        if (isDivisible) {
            // Progress Task
            taskData = {
                id: editingTaskId || `task_${Date.now()}`,
                name,
                isDivisible: true,
                totalTimeBracket: modalSelectedMinSessionTime, // Use session time for both
                sessionTimeBracket: modalSelectedMinSessionTime,
                timeSpent: 0,
                contexts: [...modalSelectedContexts],
                energy: modalSelectedEnergy || null,
                tags: [...modalTagList],
                projectId,
                isRecurring,
                dailyPlanDate: null,
                isActive: isActive,
                isPriority: false
            };
        } else {
            // Atomic Task
            taskData = {
                id: editingTaskId || `task_${Date.now()}`,
                name,
                timeBracket: modalSelectedTime,
                isDivisible: false,
                contexts: [...modalSelectedContexts],
                energy: modalSelectedEnergy || null,
                tags: [...modalTagList],
                projectId,
                isRecurring,
                dailyPlanDate: null,
                isActive: isActive,
                isPriority: false
            };
        }
        
        if (editingTaskId) {
          const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
            if (taskIndex > -1) tasks[taskIndex] = taskData;
        } else {
            tasks.push(taskData);
        }
        invalidateTaskCache(); // Clear cache when tasks change
        saveDataToFirestore();
        closeModal();
    };
      
    const updateStreak = () => {
        const today = new Date();
        const todayStr = today.toISOString().slice(0, 10);
        if (streakData.lastCompletedDate === todayStr) return;
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().slice(0, 10);
        if (streakData.lastCompletedDate === yesterdayStr) {
            streakData.currentStreak++;
        } else {
            streakData.currentStreak = 1;
        }
        streakData.lastCompletedDate = todayStr;
        saveDataToFirestore();
    };

    window.showDailyPlannerModal = () => {
        // Clean up any duplicate tasks first
        // cleanupDuplicateTasks(); // Temporarily disabled to debug empty tasks
        // renderTodayProject(); // Update sidebar after cleanup
        
        const today = new Date().toISOString().slice(0, 10);
        const yesterday = new Date(new Date().setDate(new Date().getDate() - 1)).toISOString().slice(0, 10);
        
        const rolloverTasks = tasks.filter(task => task.dailyPlanDate === yesterday && !completedTasks.some(ct => ct.id === task.id));
        
        const rolloverSection = document.getElementById('dailyPlannerRolloverSection');
        const rolloverList = document.getElementById('dailyPlannerRolloverList');

        if (rolloverTasks.length > 0) {
            rolloverSection.classList.remove('hidden');
            rolloverList.innerHTML = rolloverTasks.map(task => `
                <div class="flex items-center justify-between bg-slate-50 p-2 rounded-lg text-sm">
                    <span class="text-slate-700">${task.name}</span>
                    <div class="flex gap-2">
                        <button data-task-id="${task.id}" class="daily-planner-action text-xs font-medium text-slate-500 hover:text-slate-800" data-action="discard">Discard</button>
                        <button data-task-id="${task.id}" class="daily-planner-action bg-slate-200 text-slate-700 hover:bg-slate-300 px-2 py-1 rounded-md text-xs font-medium" data-action="carryover">Carry Over</button>
                    </div>
                </div>
            `).join('');
        } else {
            rolloverSection.classList.add('hidden');
        }

        // Set the checkbox state
        document.getElementById('dailyPlannerToggle').checked = userSettings.showDailyPlanner;

        // Clear the input and today list
        document.getElementById('dailyPlannerInput').value = '';
        document.getElementById('dailyPlannerTodayList').innerHTML = '';

        // Show today's tasks in the modal
        showTodaysTasksInModal();

        document.body.classList.add('overflow-hidden');
        showModal(document.getElementById('dailyPlannerModalOverlay'));
    };

    // Move these functions to global scope
    window.addTaskToToday = (taskId) => {
        const today = new Date().toISOString().slice(0, 10);
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.dailyPlanDate = today;
            saveDataToFirestore();
            renderTasksAndProjects(); // Refresh the display
            renderTodayProject(); // Ensure Today section is updated
            showDailyPlannerModal(); // Refresh the modal
        }
    };

    window.removeFromToday = (taskId) => {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.dailyPlanDate = null;
            saveDataToFirestore();
            renderTasksAndProjects(); // Refresh the display
            renderTodayProject(); // Ensure Today section is updated
            showDailyPlannerModal(); // Refresh the modal
        }
    };

    window.editDailyTask = (taskId) => {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            // Close the Daily Planner modal
            hideModal(document.getElementById('dailyPlannerModalOverlay'));
            document.body.classList.remove('overflow-hidden');

            // Open the task edit modal
            editTask(taskId);
        }
    };

    window.createAndAddToToday = (taskName) => {
        console.log('createAndAddToToday called with:', taskName);
        const today = new Date().toISOString().slice(0, 10);
        console.log('🔍 Today date:', today);

        // Check if task already exists for today
        const existingTask = tasks.find(task => 
            task.name === taskName && 
            task.dailyPlanDate === today
        );
        
        if (existingTask) {
            console.log('Task already exists for today:', taskName);
            return;
        }

        // Create a new task using current quick selection settings
        console.log('🔍 Quick selection values:', window.quickTimeSelection, window.quickContextSelection);
        const newTask = {
            id: 'task_' + Date.now(),
            name: taskName,
            timeBracket: window.quickTimeSelection || 'Quick',
            contexts: [window.quickContextSelection || 'Personal'],
            projectId: 'inbox',
            tags: [],
            isRecurring: false,
            isDivisible: false,
            timeSpent: 0,
            dailyPlanDate: today,
            isActive: true,
            isPriority: false
        };

        console.log('🔍 Created new task:', newTask);
        tasks.push(newTask);
        saveDataToFirestore();
        renderTasksAndProjects();
        renderTodayProject(); // Ensure Today section is updated
        showDailyPlannerModal(); // Refresh the modal
    };

    // Test function to create a simple task
    window.createTestTask = () => {
        const today = new Date().toISOString().slice(0, 10);
        const testTask = {
            id: 'test_task_' + Date.now(),
            name: 'Test Task for Today',
            timeBracket: 'Quick',
            contexts: ['Personal'],
            projectId: 'inbox',
            tags: [],
            isRecurring: false,
            isDivisible: false,
            timeSpent: 0,
            dailyPlanDate: today,
            isActive: true,
            isPriority: false
        };
        tasks.push(testTask);
        console.log('Created test task:', testTask);
        saveDataToFirestore();
        renderTasksAndProjects();
        renderTodayProject();
        showDailyPlannerModal();
    };

    // Function to clean up energy levels from tasks that shouldn't have them
    window.cleanupTaskEnergyLevels = () => {
        console.log('🧹 Cleaning up energy levels from tasks...');
        let cleanedCount = 0;
        
        tasks.forEach(task => {
            // Remove energy levels from tasks that were created through Daily Planner
            // (tasks with dailyPlanDate but no explicit energy setting)
            if (task.dailyPlanDate && task.energy === 'Medium 💪') {
                console.log('🧹 Removing energy from task:', task.name);
                task.energy = null;
                cleanedCount++;
            }
        });
        
        if (cleanedCount > 0) {
            console.log(`🧹 Cleaned up ${cleanedCount} tasks`);
            saveDataToFirestore();
            renderAll();
        } else {
            console.log('🧹 No tasks needed cleaning');
        }
    };

    // Function to edit a Today task
    window.editTodayTask = (taskId) => {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            editTask(taskId);
        }
    };

    // Function to delete a Today task
    window.deleteTodayTask = (taskId) => {
        if (confirm('Are you sure you want to delete this task?')) {
            tasks = tasks.filter(task => task.id !== taskId);
            saveDataToFirestore();
            renderTasksAndProjects();
            renderTodayProject();
        }
    };

    // Function to convert a Today task to a regular project task
    window.convertTodayTaskToProject = (taskId) => {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        // Show project selection modal
        const projectSelectModal = document.createElement('div');
        projectSelectModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        projectSelectModal.id = 'projectSelectModal';
        projectSelectModal.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-lg w-96" onclick="event.stopPropagation()">
                <h3 class="text-lg font-semibold mb-4">Move "${task.name}" to Project</h3>
                <p class="text-sm text-slate-600 mb-4">Select which project to move this task to:</p>
                <select id="projectSelectForToday" class="w-full border border-slate-300 rounded-lg p-2 mb-4">
                    <option value="inbox">Inbox</option>
                    ${projects.filter(p => p.id !== 'inbox').map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                </select>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeProjectSelectModal()" class="px-4 py-2 text-slate-600 hover:text-slate-800">Cancel</button>
                    <button onclick="confirmMoveTodayTask('${taskId}')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Move</button>
                </div>
            </div>
        `;
        
        // Add click-outside-to-close functionality
        projectSelectModal.onclick = closeProjectSelectModal;
        document.body.appendChild(projectSelectModal);
    };

    // Function to close the project select modal
    window.closeProjectSelectModal = () => {
        const modal = document.getElementById('projectSelectModal');
        if (modal) {
            modal.remove();
        }
    };

    // Function to quickly update Today task time bracket
    window.updateTodayTaskTimeBracket = (taskId, newTimeBracket) => {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.timeBracket = newTimeBracket;
            saveDataToFirestore();
            renderTasksAndProjects();
            renderTodayProject();
        }
    };

    // Function to quickly update Today task context (Work/Personal)
    window.updateTodayTaskContext = (taskId, newContext) => {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.contexts = [newContext];
            saveDataToFirestore();
            renderTasksAndProjects();
            renderTodayProject();
        }
    };

    // Function to confirm moving a Today task to a project
    window.confirmMoveTodayTask = (taskId) => {
        const projectId = document.getElementById('projectSelectForToday').value;
        const task = tasks.find(t => t.id === taskId);
        
        if (task) {
            // Remove from Today (clear dailyPlanDate)
            task.dailyPlanDate = null;
            // Set the project
            task.projectId = projectId;
            
            // Close the modal first using the specific ID
            closeProjectSelectModal();
            
            saveDataToFirestore();
            renderTasksAndProjects();
            renderTodayProject();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            successMsg.textContent = `Task moved to ${projects.find(p => p.id === projectId)?.name || 'Inbox'}!`;
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 3000);
        }
    };

    // Function to clean up duplicate tasks
    window.cleanupDuplicateTasks = () => {
        const today = new Date().toISOString().slice(0, 10);
        const todayTasks = tasks.filter(task => task.dailyPlanDate === today);
        console.log('🔍 Cleanup - Today tasks before cleanup:', todayTasks.length, todayTasks);
        
        // Group tasks by name
        const taskGroups = {};
        todayTasks.forEach(task => {
            if (!taskGroups[task.name]) {
                taskGroups[task.name] = [];
            }
            taskGroups[task.name].push(task);
        });
        
        // Remove duplicates, keeping only the first one
        let removedCount = 0;
        Object.values(taskGroups).forEach(group => {
            if (group.length > 1) {
                // Keep the first task, remove the rest
                for (let i = 1; i < group.length; i++) {
                    const taskIndex = tasks.findIndex(t => t.id === group[i].id);
                    if (taskIndex !== -1) {
                        tasks.splice(taskIndex, 1);
                        removedCount++;
                    }
                }
            }
        });
        
        if (removedCount > 0) {
            console.log(`Cleaned up ${removedCount} duplicate tasks`);
            saveDataToFirestore();
            renderTasksAndProjects();
        }
        
        const todayTasksAfter = tasks.filter(task => task.dailyPlanDate === today);
        console.log('🔍 Cleanup - Today tasks after cleanup:', todayTasksAfter.length, todayTasksAfter);
    };


    const triggerDailyPlanner = () => {
        const today = new Date().toISOString().slice(0, 10);
        // Check if it's a new day and the user has the setting enabled
        if (userSettings.showDailyPlanner && lastLoginDate !== today) {
            showDailyPlannerModal();
        }
        lastLoginDate = today; // Update the last login date
    };

    const deleteTask = (taskId) => {
        if (confirm('Are you sure you want to delete this task?')) {
            tasks = tasks.filter(task => task.id !== taskId);
            saveDataToFirestore();
        }
    };
    const editTask = (taskId) => {
        resetModal();
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        editingTaskId = taskId;
        
        // Set all the task data first
        document.getElementById('taskName').value = task.name;
        document.getElementById('taskRecurring').checked = task.isRecurring || false;
        document.getElementById('taskDivisible').checked = task.isDivisible || false;
        document.getElementById('taskActive').checked = task.isActive !== false; // Default to true if undefined
        modalTagList = [...task.tags];
        modalSelectedTime = task.timeBracket || task.time; // Handle both old and new format
        modalSelectedMinSessionTime = task.sessionTimeBracket || task.minSessionTime || task.totalTimeBracket || task.totalTime; // Use session time for both
        modalSelectedContexts = [...task.contexts];
        modalSelectedEnergy = task.energy;
        renderTagPreview();
        
        // Open the modal first (this will populate the dropdown)
        openModal('edit');
        
        // Now set the project value AFTER the modal is open and dropdown is populated
        const projectSelect = document.getElementById('projectSelect');
        const projectId = task.projectId || 'inbox';
        console.log('🔧 Edit task - task.projectId:', task.projectId);
        console.log('🔧 Edit task - projectId to set:', projectId);
        console.log('🔧 Edit task - available options:', Array.from(projectSelect.options).map(opt => ({value: opt.value, text: opt.textContent})));
        const optionExists = Array.from(projectSelect.options).some(option => option.value === projectId);
        if (optionExists) {
            projectSelect.value = projectId;
            console.log('🔧 Edit task - set project to:', projectId);
        } else {
            console.warn('Project ID not found in dropdown:', projectId);
            projectSelect.value = 'inbox';
        }
        
        // Update task type buttons after data is set
        updateTaskTypeButtons();
        
        // Set button states after modal is open
        document.querySelectorAll('.modal-time-btn').forEach(btn => { if (btn.dataset.timebracket === task.timeBracket || (task.time && parseInt(btn.dataset.time) === task.time)) { btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); btn.classList.remove('bg-white','text-slate-700'); } });
        document.querySelectorAll('.modal-session-time-btn').forEach(btn => { if (btn.dataset.timebracket === modalSelectedMinSessionTime) { btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); btn.classList.remove('bg-white','text-slate-700'); } });
        document.querySelectorAll('.modal-context-btn').forEach(btn => { if (task.contexts.includes(btn.dataset.context)) { btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); btn.classList.remove('bg-white','text-slate-700'); }});
        document.querySelectorAll('.modal-energy-btn').forEach(btn => { if (btn.dataset.energy === task.energy) { btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); btn.classList.remove('bg-white','text-slate-700'); }});
    };
    const removeTag = (index) => {
        modalTagList.splice(index, 1);
        renderTagPreview();
    };

    const showNewProjectInput = () => {
        document.getElementById('newProjectInputContainer').classList.remove('hidden');
        document.getElementById('newProjectNameInput').focus();
    };

    const hideNewProjectInput = () => {
        document.getElementById('newProjectInputContainer').classList.add('hidden');
        document.getElementById('newProjectNameInput').value = '';
        // Reset dropdown to first project (Inbox)
        document.getElementById('projectSelect').value = 'inbox';
    };

    const createNewProject = () => {
        const projectName = document.getElementById('newProjectNameInput').value.trim();
        
        if (!projectName) {
            alert('Please enter a project name.');
            return;
        }
        
        // Check if project already exists
        const existingProject = projects.find(p => p.name.toLowerCase() === projectName.toLowerCase());
        if (existingProject) {
            alert('A project with this name already exists.');
            return;
        }
        
        // Create new project
        const newProject = {
            id: 'proj_' + Date.now(),
            name: projectName
        };
        
        projects.push(newProject);
        saveDataToFirestore();
        
        // Update dropdown and select the new project
        populateProjectDropdown();
        document.getElementById('projectSelect').value = newProject.id;
        
        // Hide the input
        hideNewProjectInput();
        
        console.log('Created new project:', newProject);
    };
    
    const startQuickEdit = (taskId) => {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        
        const taskElement = document.querySelector(`[data-task-container-id="${taskId}"]`);
        const taskNameSpan = taskElement.querySelector('.task-name');
        const currentName = taskNameSpan.textContent;
        
        // Create input field
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentName;
        input.className = 'w-full border border-blue-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500';
        
        // Replace span with input
        taskNameSpan.replaceWith(input);
        input.focus();
        input.select();
        
        const finishEdit = () => {
            const newName = input.value.trim();
            if (newName && newName !== currentName) {
                task.name = newName;
                saveDataToFirestore();
                renderAll();
            } else {
                // Restore original name if empty or unchanged
                const newSpan = document.createElement('span');
                newSpan.className = 'task-name';
                newSpan.textContent = currentName;
                input.replaceWith(newSpan);
            }
        };
        
        input.addEventListener('blur', finishEdit);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                finishEdit();
            } else if (e.key === 'Escape') {
                const newSpan = document.createElement('span');
                newSpan.className = 'task-name';
                newSpan.textContent = currentName;
                input.replaceWith(newSpan);
            }
        });
    };
    
    const deleteProject = (projectId) => {
        const project = projects.find(p => p.id === projectId);
        if (!project || project.id === 'inbox') return;
        
        const projectTasks = tasks.filter(task => task.projectId === projectId);
        let deleteMode = 'project-only'; // 'project-only', 'move-to-inbox', 'delete-all'
        
        // Show the modal
        if (projectTasks.length === 0) {
            // No tasks, just delete the project
            projectDeleteContent.innerHTML = `
                <p class="text-slate-600">Are you sure you want to delete the project <strong>"${project.name}"</strong>?</p>
                <p class="text-sm text-slate-500 mt-2">This project has no tasks.</p>
            `;
            deleteMode = 'project-only';
        } else {
            // Has tasks, show options
            projectDeleteContent.innerHTML = `
                <p class="text-slate-600 mb-4">Project <strong>"${project.name}"</strong> has <strong>${projectTasks.length}</strong> task(s).</p>
                <div class="space-y-3">
                    <label class="flex items-center">
                        <input type="radio" name="deleteMode" value="move-to-inbox" class="mr-3 text-blue-600 focus:ring-blue-500" checked>
                        <span class="text-slate-700">Move tasks to Inbox (recommended)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="deleteMode" value="delete-all" class="mr-3 text-red-600 focus:ring-red-500">
                        <span class="text-slate-700">Delete tasks and project</span>
                    </label>
                </div>
            `;
            deleteMode = 'move-to-inbox';
        }
        
        // Store the project info for the modal
        projectDeleteModalOverlay.dataset.projectId = projectId;
        projectDeleteModalOverlay.dataset.deleteMode = deleteMode;
        
        // Show modal
        document.body.classList.add('overflow-hidden');
        showModal(projectDeleteModalOverlay);
    };
    
    const executeProjectDelete = () => {
        const projectId = projectDeleteModalOverlay.dataset.projectId;
        const project = projects.find(p => p.id === projectId);
        if (!project) return;
        
        const projectTasks = tasks.filter(task => task.projectId === projectId);
        
        // Check which radio button is selected
        const selectedMode = document.querySelector('input[name="deleteMode"]:checked');
        const deleteMode = selectedMode ? selectedMode.value : 'move-to-inbox';
        
        if (deleteMode === 'move-to-inbox') {
            // Move tasks to Inbox
            projectTasks.forEach(task => {
                task.projectId = 'inbox';
            });
        } else if (deleteMode === 'delete-all') {
            // Delete all tasks
            tasks = tasks.filter(task => task.projectId !== projectId);
        }
        
        // Delete project
        projects = projects.filter(p => p.id !== projectId);
        collapsedProjects.delete(projectId);
        saveDataToFirestore();
        renderAll();
        
        // Refresh project management modal if it's open
        if (!document.getElementById('projectManagementModalOverlay').classList.contains('hidden')) {
            renderProjectManagementList();
        }
        
        // Close modal
        closeProjectDeleteModal();
    };
    
    const closeProjectDeleteModal = () => {
        document.body.classList.remove('overflow-hidden');
        hideModal(projectDeleteModalOverlay);
        projectDeleteModalOverlay.dataset.projectId = '';
        projectDeleteModalOverlay.dataset.deleteMode = '';
    };

    const editProject = (projectId) => {
        const project = projects.find(p => p.id === projectId);
        if (!project) return;
        
        // Create inline edit input
        const projectHeader = document.querySelector(`[data-project-id="${projectId}"]`);
        const headerContent = projectHeader.querySelector('h3');
        const currentName = headerContent.textContent;
        
        // Create input field
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentName;
        input.className = 'font-semibold text-slate-900 bg-white border border-blue-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500';
        
        // Replace text with input
        headerContent.textContent = '';
        headerContent.appendChild(input);
        input.focus();
        input.select();
        
        // Handle save on Enter or blur
        const saveEdit = () => {
            const newName = input.value.trim();
            if (newName && newName !== currentName) {
                project.name = newName;
                saveDataToFirestore();
                renderAll();
            } else {
                // Restore original name if empty or unchanged
                headerContent.textContent = currentName;
            }
        };
        
        input.addEventListener('blur', saveEdit);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                saveEdit();
            } else if (e.key === 'Escape') {
                headerContent.textContent = currentName;
            }
        });
    };
    const markTaskDone = (taskId) => {
        const taskIndex = tasks.findIndex(t => t.id === taskId);
        if (taskIndex > -1) {
            const task = tasks[taskIndex];
            
            const positiveMessages = ["Great job! ✨", "Awesome work! 🔥", "That's one step closer. 🚀", "Productivity unlocked! 🌟", "Amazing habit. 💪"];
            const message = positiveMessages[Math.floor(Math.random() * positiveMessages.length)];
            
            if (task.isDivisible) {
                // Progress Task: Track time spent and check if complete
                // Use the actual session time (from filter or task time), not just minSessionTime
                let sessionTime;
                if (selectedTimeFilter) {
                    sessionTime = selectedTimeFilter;
                } else {
                    sessionTime = task.minSessionTime;
                }
                const newTimeSpent = (task.timeSpent || 0) + sessionTime;
                
                // Update the task with new time spent
                tasks[taskIndex].timeSpent = newTimeSpent;
                
                if (newTimeSpent >= task.totalTime) {
                    // Task is fully complete
                    const taskElement = document.querySelector(`[data-task-container-id="${taskId}"]`);
                    if (taskElement) {
                        taskElement.classList.add('task-completing');
                    }
                    setTimeout(() => {
                        const completedTask = { ...tasks[taskIndex], completedAt: new Date().toISOString() };
                        completedTasks.push(completedTask);
                        tasks.splice(taskIndex, 1);
                        updateStreak();
                        saveDataToFirestore(); 
                    }, 300);
                    filteredList.innerHTML = `<div class="text-center text-green-600 p-4 bg-green-50 rounded-lg border border-green-200 shadow-sm animate-fade-in">${message} - Task Complete!</div>`;
                } else {
                    // Task is partially complete, show progress
                    const progressPercent = Math.round((newTimeSpent / task.totalTime) * 100);
                    saveDataToFirestore();
                    filteredList.innerHTML = `<div class="text-center text-blue-600 p-4 bg-blue-50 rounded-lg border border-blue-200 shadow-sm animate-fade-in">
                        <div class="font-semibold">Progress Update! 📈</div>
                        <div class="text-sm mt-1">${newTimeSpent}/${task.totalTime} min (${progressPercent}% complete)</div>
                    </div>`;
                }
            } else if (task.isRecurring) {
                // For recurring atomic tasks, just log completion and update streak
                // Create a worklog for recurring completion
                const worklog = createWorklog(taskId, 'recurring-complete');
                endWorklog(worklog.id, 'completed');
                saveWorklogsToFirestore();
                
                const completedTask = { ...task, completedAt: new Date().toISOString() };
                completedTasks.push(completedTask);
                updateStreak();
                saveDataToFirestore(); 
                // Don't remove from main task list, so no animation needed
                // But we can flash a success message
                 filteredList.innerHTML = `<div class="text-center text-green-600 p-4 bg-green-50 rounded-lg border border-green-200 shadow-sm animate-fade-in">${message} (Recurring)</div>`;
            } else {
                // For single atomic tasks, animate and remove
                const taskElement = document.querySelector(`[data-task-container-id="${taskId}"]`);
                if (taskElement) {
                    taskElement.classList.add('task-completing');
                }
                setTimeout(() => {
                    // Create a worklog for quick completion
                    const worklog = createWorklog(taskId, 'quick-complete');
                    endWorklog(worklog.id, 'completed');
                    saveWorklogsToFirestore();
                    
                    const completedTask = { ...tasks[taskIndex], completedAt: new Date().toISOString() };
                    completedTasks.push(completedTask);
                    tasks.splice(taskIndex, 1);
                    updateStreak();
                    saveDataToFirestore(); 
                }, 300);
                filteredList.innerHTML = `<div class="text-center text-green-600 p-4 bg-green-50 rounded-lg border border-green-200 shadow-sm animate-fade-in">${message}</div>`;
            }
            
            setTimeout(() => { if(filteredList.firstChild && (filteredList.firstChild.textContent.includes(message))) filteredList.innerHTML = ''; }, 4000);
        }
        
        // Update content area after task completion
        updateContentArea();
        
        if (!focusOverlay.classList.contains('hidden')) {
            stopFocusSession(false);
        }
    };

    // --- WEEKLY REVIEW MODAL ---
    const showStatsModal = () => {
        const statsContent = document.getElementById('statsContent');
        
        // Calculate weekly data
        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        const weekAgoStr = weekAgo.toISOString().slice(0, 10);
        const todayStr = today.toISOString().slice(0, 10);
        
        // Tasks completed this week
        const tasksThisWeek = completedTasks.filter(t => 
            t.completedAt && t.completedAt.slice(0, 10) >= weekAgoStr && t.completedAt.slice(0, 10) <= todayStr
        );
        
        // Focus time calculation (assuming 25 min average per task)
        const focusTimeHours = Math.round((tasksThisWeek.length * 25) / 60 * 10) / 10;
        
        // Most productive context
        const contextCounts = {};
        tasksThisWeek.forEach(task => {
            if (task.contexts) {
                task.contexts.forEach(context => {
                    contextCounts[context] = (contextCounts[context] || 0) + 1;
                });
            }
        });
        const mostProductiveContext = Object.keys(contextCounts).reduce((a, b) => 
            contextCounts[a] > contextCounts[b] ? a : b, 'Workday'
        );
        
        // Longest streak calculation
        const longestStreak = Math.max(streakData.currentStreak, streakData.longestStreak || 0);
        
        // Tasks not touched in a while (no time spent in last 7 days)
        const untouchedTasks = tasks.filter(task => {
            const lastWeekTasks = tasksThisWeek.filter(ct => ct.taskId === task.id);
            return lastWeekTasks.length === 0 && task.timeSpent === 0;
        }).slice(0, 3);
        
        // Energy level distribution
        const energyCounts = { 'Low 🧠': 0, 'Medium 💪': 0, 'High 🔥': 0 };
        tasksThisWeek.forEach(task => {
            if (energyCounts.hasOwnProperty(task.energy)) {
                energyCounts[task.energy]++;
            }
        });
        const preferredEnergy = Object.keys(energyCounts).reduce((a, b) => 
            energyCounts[a] > energyCounts[b] ? a : b, 'Medium 💪'
        );
        
        statsContent.innerHTML = `
            <!-- Weekly Summary -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                <h3 class="font-semibold text-slate-800 mb-3 flex items-center">
                    <span class="text-2xl mr-2">📈</span>
                    This Week's Summary
                </h3>
                <p class="text-slate-700 leading-relaxed">
                    You completed <strong>${tasksThisWeek.length} tasks</strong> this week, spending 
                    <strong>${focusTimeHours} hours</strong> in focus mode. You were most productive in the 
                    <strong>'${mostProductiveContext}'</strong> context. Your longest streak is now 
                    <strong>${longestStreak} days</strong>.
                </p>
            </div>
            
            <!-- Productivity Insights -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-slate-50 p-4 rounded-xl">
                    <h4 class="font-semibold text-slate-800 mb-2 flex items-center">
                        <span class="text-lg mr-2">⚡</span>
                        Energy Patterns
                    </h4>
                    <p class="text-sm text-slate-600 mb-2">Your preferred energy level:</p>
                    <div class="text-lg font-semibold text-slate-800">${preferredEnergy}</div>
                    <div class="text-xs text-slate-500 mt-1">
                        ${energyCounts['Low 🧠']} Low • ${energyCounts['Medium 💪']} Medium • ${energyCounts['High 🔥']} High
            </div>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl">
                    <h4 class="font-semibold text-slate-800 mb-2 flex items-center">
                        <span class="text-lg mr-2">🎯</span>
                        Context Performance
                    </h4>
                    <p class="text-sm text-slate-600 mb-2">Most productive context:</p>
                    <div class="text-lg font-semibold text-slate-800">${mostProductiveContext}</div>
                    <div class="text-xs text-slate-500 mt-1">
                        ${contextCounts[mostProductiveContext] || 0} tasks completed
                    </div>
                </div>
            </div>
            
            <!-- Neglected Tasks -->
            ${untouchedTasks.length > 0 ? `
            <div class="bg-amber-50 p-4 rounded-xl border border-amber-200">
                <h4 class="font-semibold text-amber-800 mb-3 flex items-center">
                    <span class="text-lg mr-2">⏰</span>
                    Tasks You Haven't Touched in a While
                </h4>
                <div class="space-y-2">
                    ${untouchedTasks.map(task => `
                        <div class="flex items-center justify-between bg-white p-2 rounded-lg border border-amber-100">
                            <span class="text-sm text-slate-700">${task.name}</span>
                            <span class="text-xs text-amber-600 bg-amber-100 px-2 py-1 rounded">${task.time} min</span>
                        </div>
                    `).join('')}
                </div>
                <p class="text-xs text-amber-700 mt-2">Consider scheduling these tasks or breaking them into smaller chunks.</p>
            </div>
            ` : ''}
            
            <!-- Motivational Message -->
            <div class="bg-green-50 p-4 rounded-xl border border-green-200 text-center">
                <h4 class="font-semibold text-green-800 mb-2 flex items-center justify-center">
                    <span class="text-lg mr-2">🌟</span>
                    Keep Up the Great Work!
                </h4>
                <p class="text-sm text-green-700">
                    ${tasksThisWeek.length >= 10 ? 
                        "You're on fire this week! Your consistency is impressive." :
                        tasksThisWeek.length >= 5 ?
                        "Great progress this week! You're building solid habits." :
                        "Every task completed is a step forward. Keep going!"
                    }
                </p>
            </div>
        `;

        document.body.classList.add('overflow-hidden');
        showModal(statsModalOverlay);
    };
    const closeStatsModal = () => {
        document.body.classList.remove('overflow-hidden');
        hideModal(statsModalOverlay);
    };

    // --- INACTIVE TASKS MODAL FUNCTIONS ---
    const showInactiveTasksModal = () => {
        const inactiveTasks = tasks.filter(task => task.isActive === false);
        const inactiveTasksList = document.getElementById('inactiveTasksList');
        
        if (inactiveTasks.length === 0) {
            inactiveTasksList.innerHTML = `
                <div class="text-center text-slate-500 py-8">
                    <div class="text-4xl mb-3">✅</div>
                    <h3 class="font-semibold text-slate-700 mb-2">No Inactive Tasks</h3>
                    <p class="text-sm">All your tasks are currently active!</p>
                </div>
            `;
        } else {
            inactiveTasksList.innerHTML = inactiveTasks.map(task => {
                const project = projects.find(p => p.id === task.projectId);
                const projectName = project ? project.name : 'Unknown Project';
                const timeBracket = task.totalTimeBracket || task.timeBracket || 'Quick';
                const context = task.contexts && task.contexts.length > 0 ? task.contexts[0] : 'Personal';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                        <div class="flex items-center flex-1">
                            <div class="w-2 h-2 bg-slate-400 rounded-full mr-3"></div>
                            <div class="flex-1">
                                <div class="font-medium text-slate-800">${task.name}</div>
                                <div class="text-sm text-slate-500">${projectName} • ${timeBracket} • ${context}</div>
                            </div>
                        </div>
                        <button 
                            data-task-id="${task.id}" 
                            class="reactivate-task-btn bg-blue-500 hover:bg-blue-600 text-white text-xs font-medium px-3 py-1.5 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                        >
                            Reactivate
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        document.body.classList.add('overflow-hidden');
        showModal(inactiveTasksModalOverlay);
    };

    const closeInactiveTasksModal = () => {
        document.body.classList.remove('overflow-hidden');
        hideModal(inactiveTasksModalOverlay);
    };

    // --- SIGN UP/SIGN IN MODAL FUNCTIONS ---
    const showSignUpModal = () => {
        document.body.classList.add('overflow-hidden');
        showModal(document.getElementById('signUpModalOverlay'));
    };

    const closeSignUpModal = () => {
        document.body.classList.remove('overflow-hidden');
        hideModal(document.getElementById('signUpModalOverlay'));
    };

    const showSignInModal = () => {
        document.body.classList.add('overflow-hidden');
        showModal(document.getElementById('signInModalOverlay'));
    };

    const closeSignInModal = () => {
        document.body.classList.remove('overflow-hidden');
        hideModal(document.getElementById('signInModalOverlay'));
    };

    // --- PROJECT MANAGEMENT MODAL FUNCTIONS ---
    const showProjectManagementModal = () => {
        document.body.classList.add('overflow-hidden');
        showModal(document.getElementById('projectManagementModalOverlay'));
        renderProjectManagementList();
    };

    const closeProjectManagementModal = () => {
        document.body.classList.remove('overflow-hidden');
        hideModal(document.getElementById('projectManagementModalOverlay'));
    };

    // --- TAG MANAGER MODAL FUNCTIONS ---
    const showTagManagerModal = () => {
        document.body.classList.add('overflow-hidden');
        showModal(document.getElementById('tagManagerModalOverlay'));
        renderTagManagerList();
    };

    const closeTagManagerModal = () => {
        document.body.classList.remove('overflow-hidden');
        hideModal(document.getElementById('tagManagerModalOverlay'));
    };

    const renderTagManagerList = () => {
        const tagManagerCloud = document.getElementById('tagManagerCloud');
        if (!tagManagerCloud) return;
        
        // Get all unique tags from tasks
        const allTags = new Set();
        tasks.forEach(task => {
            if (task.tags && Array.isArray(task.tags)) {
                task.tags.forEach(tag => allTags.add(tag));
            }
        });
        
        if (allTags.size === 0) {
            tagManagerCloud.innerHTML = '<div class="text-center text-slate-500 py-4 text-sm">No tags found. Add some tags to your tasks to see them here.</div>';
            return;
        }
        
        // Sort tags alphabetically
        const sortedTags = Array.from(allTags).sort();
        
        tagManagerCloud.innerHTML = sortedTags.map(tag => {
            // Count how many tasks use this tag
            const taskCount = tasks.filter(task => task.tags && task.tags.includes(tag)).length;
            
            return `
                <div class="relative group inline-block">
                    <span class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1.5 rounded-full cursor-pointer hover:bg-blue-200 hover:shadow-md transition-all duration-200 inline-flex items-center gap-1 border border-blue-200 hover:border-blue-300" data-tag-name="${tag}" data-action="edit-tag" title="Click to edit tag name">
                        #${tag}
                        <span class="text-xs text-blue-600">(${taskCount})</span>
                    </span>
                    <button data-tag-name="${tag}" data-action="delete-tag" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-4 h-4 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1 flex items-center justify-center" title="Delete tag">
                        ×
                    </button>
                </div>
            `;
        }).join('');
    };

    const addNewTag = () => {
        const newTagInput = document.getElementById('newTagInput');
        const tagName = newTagInput.value.trim();
        
        if (!tagName) {
            alert('Please enter a tag name.');
            return;
        }
        
        // Check if tag already exists
        const allTags = new Set();
        tasks.forEach(task => {
            if (task.tags && Array.isArray(task.tags)) {
                task.tags.forEach(tag => allTags.add(tag));
            }
        });
        
        if (allTags.has(tagName)) {
            alert('This tag already exists.');
            return;
        }
        
        // Create a placeholder task with the new tag so it shows up immediately
        const placeholderTask = {
            id: `placeholder-${Date.now()}`,
            name: `Tag placeholder for "${tagName}"`,
            projectId: 'inbox',
            totalTime: 1,
            minSessionTime: 1,
            energy: 'Low 🧠',
            context: ['Work'],
            tags: [tagName],
            timeSpent: 0,
            isRecurring: false,
            isDivisible: false,
            priority: '',
            createdAt: new Date().toISOString(),
            isPlaceholder: true, // Flag to identify placeholder tasks
            isActive: true,
            isPriority: false
        };
        
        tasks.push(placeholderTask);
        saveDataToFirestore();
        newTagInput.value = '';
        renderTagManagerList();
        renderTagCloud(); // Update the tag cloud in Advanced Filters
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        successMsg.textContent = `Tag "${tagName}" created and ready to use!`;
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
    };

    const editTag = (oldTagName) => {
        // This will be called from the event delegation, but we need the element
        // The actual inline editing will be handled in the renderTagManagerList function
    };

    const deleteTag = (tagName) => {
        deleteTagWithConfirmation(tagName);
    };

    // --- INLINE EDITING FUNCTIONS ---
    let currentlyEditingTag = null;

    const startInlineEdit = (tagName, element) => {
        if (currentlyEditingTag) {
            return; // Already editing something
        }
        
        currentlyEditingTag = tagName;
        const originalText = element.textContent;
        
        // Create input element
        const input = document.createElement('input');
        input.type = 'text';
        input.value = tagName;
        input.className = 'bg-white border-2 border-blue-400 text-blue-800 text-sm font-medium px-2 py-1 rounded-full outline-none focus:ring-2 focus:ring-blue-500 min-w-0 flex-1';
        input.style.minWidth = '60px';
        
        // Replace the tag text with input
        element.innerHTML = '';
        element.appendChild(input);
        
        // Focus and select text
        setTimeout(() => {
            input.focus();
            input.select();
        }, 10);
        
        // Handle save on Enter or blur
        const saveEdit = () => {
            const newTagName = input.value.trim();
            
            if (!newTagName || newTagName === '') {
                cancelEdit(element, originalText);
                return;
            }
            
            if (newTagName === tagName) {
                cancelEdit(element, originalText);
                return; // No change
            }
            
            // Check if new name already exists
            const allTags = new Set();
            tasks.forEach(task => {
                if (task.tags && Array.isArray(task.tags)) {
                    task.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            if (allTags.has(newTagName)) {
                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                errorMsg.textContent = 'A tag with this name already exists.';
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 3000);
                cancelEdit(element, originalText);
                return;
            }
            
            // Update all tasks that use this tag
            let updatedCount = 0;
            tasks.forEach(task => {
                if (task.tags && Array.isArray(task.tags)) {
                    const tagIndex = task.tags.indexOf(tagName);
                    if (tagIndex !== -1) {
                        task.tags[tagIndex] = newTagName;
                        updatedCount++;
                    }
                }
            });
            
            if (updatedCount > 0) {
                saveDataToFirestore();
                renderTagManagerList();
                renderTagCloud(); // Update the tag cloud in Advanced Filters
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                successMsg.textContent = `Tag renamed to "${newTagName}" in ${updatedCount} task${updatedCount !== 1 ? 's' : ''}`;
                document.body.appendChild(successMsg);
                setTimeout(() => successMsg.remove(), 3000);
            }
            
            currentlyEditingTag = null;
        };
        
        const cancelEdit = (element, originalText) => {
            element.innerHTML = originalText;
            currentlyEditingTag = null;
        };
        
        // Event listeners
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveEdit();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelEdit(element, originalText);
            }
        });
        
        input.addEventListener('blur', saveEdit);
    };

    const deleteTagWithConfirmation = (tagName) => {
        const taskCount = tasks.filter(task => task.tags && task.tags.includes(tagName)).length;
        
        if (!confirm(`Are you sure you want to delete the tag "${tagName}"?\n\nThis will remove it from ${taskCount} task${taskCount !== 1 ? 's' : ''}. This action cannot be undone.`)) {
            return;
        }
        
        // Remove the tag from all tasks and delete placeholder tasks
        tasks = tasks.filter(task => {
            if (task.tags && Array.isArray(task.tags)) {
                task.tags = task.tags.filter(tag => tag !== tagName);
                // If this was a placeholder task for this tag, remove it entirely
                if (task.isPlaceholder && task.tags.length === 0) {
                    return false; // Remove this task
                }
            }
            return true; // Keep this task
        });
        
        saveDataToFirestore();
        renderTagManagerList();
        renderTagCloud(); // Update the tag cloud in Advanced Filters
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        successMsg.textContent = `Tag "${tagName}" deleted from ${taskCount} task${taskCount !== 1 ? 's' : ''}`;
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
    };

    const renderProjectManagementList = () => {
        const projectList = document.getElementById('projectManagementList');
        projectList.innerHTML = '';

        projects.forEach(project => {
            const projectTasks = tasks.filter(task => task.projectId === project.id);
            const isActive = projectTasks.length > 0;
            const taskCount = projectTasks.length;

            const projectItem = document.createElement('div');
            projectItem.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200';
            projectItem.setAttribute('data-project-id', project.id);
            
            // Prevent modal project items from triggering sidebar events
            projectItem.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            projectItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full ${isActive ? 'bg-green-500' : 'bg-slate-300'}"></div>
                        <span class="font-medium text-slate-900">${project.name}</span>
                    </div>
                    <span class="text-sm text-slate-500">${taskCount} task${taskCount !== 1 ? 's' : ''}</span>
                </div>
                <div class="flex items-center space-x-2">
                    ${project.id !== 'inbox' ? `
                        <button class="edit-project-btn text-slate-400 hover:text-slate-600 p-1 rounded-md transition-colors" data-project-id="${project.id}" title="Rename">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button class="delete-project-btn text-red-400 hover:text-red-600 p-1 rounded-md transition-colors" data-project-id="${project.id}" title="Delete">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    ` : ''}
                </div>
            `;
            
            projectList.appendChild(projectItem);
        });

        // Add event listeners for edit and delete buttons
        document.querySelectorAll('.edit-project-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const projectId = e.target.closest('.edit-project-btn').dataset.projectId;
                console.log('Edit button clicked for project:', projectId);
                editProjectInModal(projectId);
            });
        });

        document.querySelectorAll('.delete-project-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const projectId = e.target.closest('.delete-project-btn').dataset.projectId;
                console.log('Delete button clicked for project:', projectId);
                deleteProject(projectId);
            });
        });
    };

    const deleteEmptyProjects = () => {
        const emptyProjects = projects.filter(project => {
            if (project.id === 'inbox') return false; // Never delete inbox
            const projectTasks = tasks.filter(task => task.projectId === project.id);
            return projectTasks.length === 0;
        });

        if (emptyProjects.length === 0) {
            alert('No empty projects to delete.');
            return;
        }

        if (confirm(`Delete ${emptyProjects.length} empty project${emptyProjects.length !== 1 ? 's' : ''}?`)) {
            emptyProjects.forEach(project => {
                projects = projects.filter(p => p.id !== project.id);
            });
            saveDataToFirestore();
            renderAll();
            renderProjectManagementList();
        }
    };

    const collapseAllProjects = () => {
        // Collapse all projects
        projects.forEach(project => {
            collapsedProjects.add(project.id);
        });
        allProjectsCollapsed = true;
        
        // Save to Firestore
        saveDataToFirestore();
        
        // Re-render to show collapsed state (bypass search logic to avoid conflicts)
        renderTasksAndProjects('', true);
        
        console.log('All projects collapsed');
    };

    const editProjectInModal = (projectId) => {
        const project = projects.find(p => p.id === projectId);
        if (!project || project.id === 'inbox') return;
        
        // Find the project item in the modal (not the sidebar)
        const projectManagementList = document.getElementById('projectManagementList');
        const projectItem = projectManagementList.querySelector(`[data-project-id="${projectId}"]`);
        if (!projectItem) {
            console.log('Project item not found for ID:', projectId);
            return;
        }
        
        console.log('Project item found:', projectItem);
        console.log('Project item HTML:', projectItem.innerHTML);
        
        const projectNameSpan = projectItem.querySelector('span.font-medium.text-slate-900');
        if (!projectNameSpan) {
            console.log('Project name span not found');
            console.log('All spans in project item:', projectItem.querySelectorAll('span'));
            return;
        }
        const currentName = projectNameSpan.textContent;
        
        // Create input field
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentName;
        input.className = 'font-medium text-slate-900 bg-white border border-blue-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500';
        
        // Replace text with input
        projectNameSpan.textContent = '';
        projectNameSpan.appendChild(input);
        input.focus();
        input.select();
        
        // Handle save on Enter or blur
        const saveEdit = () => {
            const newName = input.value.trim();
            if (newName && newName !== currentName) {
                project.name = newName;
                saveDataToFirestore();
                renderAll();
                // Refresh the modal list
                renderProjectManagementList();
            } else {
                // Restore original name if empty or unchanged
                projectNameSpan.textContent = currentName;
            }
        };
        
        const cancelEdit = () => {
            projectNameSpan.textContent = currentName;
        };
        
        input.addEventListener('blur', saveEdit);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveEdit();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelEdit();
            }
        });
    };

    const handleSignUpModal = async () => {
        const email = document.getElementById('signUpEmailInput').value;
        const password = document.getElementById('signUpPasswordInput').value;
        const errorElement = document.getElementById('signUpAuthError');
        
        if (!email || !password) {
            showAuthError('Please fill in all fields', errorElement);
            return;
        }
        
        try {
            console.log('🔐 Attempting to create new account...');
            console.log('📧 Email:', email);
            await window.createUserWithEmailAndPassword(auth, email, password);
            console.log('✅ Account created successfully');
            closeSignUpModal();
        } catch (error) {
            console.error('❌ Account creation failed:', error);
            console.error('❌ Error code:', error.code);
            console.error('❌ Error message:', error.message);
            showAuthError(getAuthErrorMessage(error.code), errorElement);
        }
    };

    const handleSignInModal = async () => {
        const email = document.getElementById('signInEmailInput').value;
        const password = document.getElementById('signInPasswordInput').value;
        const errorElement = document.getElementById('signInAuthError');
        
        if (!email || !password) {
            showAuthError('Please fill in all fields', errorElement);
            return;
        }
        
        try {
            console.log('🔐 Attempting email/password sign in...');
            console.log('📧 Email:', email);
            console.log('🔑 Auth object:', auth);
            await window.signInWithEmailAndPassword(auth, email, password);
            console.log('✅ Sign in successful');
            closeSignInModal();
        } catch (error) {
            console.error('❌ Sign in failed:', error);
            console.error('❌ Error code:', error.code);
            console.error('❌ Error message:', error.message);
            showAuthError(getAuthErrorMessage(error.code), errorElement);
        }
    };

    const handleSignUpGoogleModal = async () => {
        try {
            const provider = new window.GoogleAuthProvider();
            await window.signInWithPopup(auth, provider);
            closeSignUpModal();
        } catch (error) {
            const errorElement = document.getElementById('signUpAuthError');
            showAuthError(getAuthErrorMessage(error.code), errorElement);
        }
    };

    const handleSignInGoogleModal = async () => {
        try {
            const provider = new window.GoogleAuthProvider();
            await window.signInWithPopup(auth, provider);
            closeSignInModal();
        } catch (error) {
            const errorElement = document.getElementById('signInAuthError');
            showAuthError(getAuthErrorMessage(error.code), errorElement);
        }
    };

    // --- WORKLOG MANAGEMENT FUNCTIONS ---
    // --- FOCUS SESSION PERSISTENCE ---
    const saveFocusSessionToStorage = (sessionData) => {
        try {
            localStorage.setItem('focusSession', JSON.stringify(sessionData));
            console.log('💾 Focus session saved to localStorage:', sessionData);
        } catch (error) {
            console.error('❌ Failed to save focus session to localStorage:', error);
        }
    };

    const loadFocusSessionFromStorage = () => {
        try {
            const sessionData = localStorage.getItem('focusSession');
            if (sessionData) {
                const parsed = JSON.parse(sessionData);
                console.log('📱 Focus session loaded from localStorage:', parsed);
                return parsed;
            }
        } catch (error) {
            console.error('❌ Failed to load focus session from localStorage:', error);
        }
        return null;
    };

    const clearFocusSessionFromStorage = () => {
        try {
            localStorage.removeItem('focusSession');
            console.log('🗑️ Focus session cleared from localStorage');
        } catch (error) {
            console.error('❌ Failed to clear focus session from localStorage:', error);
        }
    };

    const restoreFocusSession = (sessionData) => {
        if (!sessionData || !sessionData.taskId) {
            console.log('⚠️ No valid session data to restore');
            return false;
        }

        // Find the task
        const task = tasks.find(t => t.id === sessionData.taskId);
        if (!task) {
            console.log('⚠️ Task not found for restored session:', sessionData.taskId);
            clearFocusSessionFromStorage();
            return false;
        }

        // Restore session state
        currentFocusTaskId = sessionData.taskId;
        currentTask = task;
        currentWorklogId = sessionData.worklogId;
        isPaused = sessionData.isPaused || false;
        startTime = sessionData.startTime;
        sessionLength = sessionData.sessionDuration || 25;
        elapsedSeconds = Math.floor((sessionData.elapsedTime || 0) / 1000);
        pausedTime = sessionData.pausedTime || 0;

        // Calculate remaining time
        const totalElapsed = sessionData.elapsedTime + (Date.now() - startTime - pausedTime);
        const remainingTime = Math.max(0, (sessionLength * 60 * 1000) - totalElapsed);

        // Update UI
        document.getElementById('focusTaskName').textContent = task.name;
        document.getElementById('focusTimeRemaining').textContent = formatTime(remainingTime);
        document.getElementById('focusPauseText').textContent = isPaused ? 'Resume' : 'Pause';
        document.getElementById('pauseIcon').classList.toggle('hidden', !isPaused);
        document.getElementById('playIcon').classList.toggle('hidden', isPaused);

        // Show focus overlay
        const focusOverlay = document.getElementById('focusOverlay');
        focusOverlay.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

        // Update timer display
        updateTimerDisplay();

        // Start timer
        if (!isPaused) {
            startTimer();
        }

        console.log('✅ Focus session restored successfully');
        return true;
    };

    const createWorklog = (taskId, sessionType = 'focus') => {
        const worklogId = `worklog_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const worklog = {
            id: worklogId,
            taskId: taskId,
            userId: currentUser?.uid || 'guest',
            sessionType: sessionType, // 'focus', 'break', 'meeting', etc.
            startTime: new Date().toISOString(),
            endTime: null,
            duration: 0, // in minutes
            pausedTime: 0, // total paused time in seconds
            pauseCount: 0,
            status: 'active', // 'active', 'paused', 'completed', 'cancelled'
            notes: '',
            energy: null,
            context: null,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        worklogs.push(worklog);
        currentWorklogId = worklogId;
        console.log('📝 Created worklog:', worklog);
        return worklog;
    };

    const updateWorklog = (worklogId, updates) => {
        const worklogIndex = worklogs.findIndex(w => w.id === worklogId);
        if (worklogIndex === -1) return false;
        
        worklogs[worklogIndex] = {
            ...worklogs[worklogIndex],
            ...updates,
            updatedAt: new Date().toISOString()
        };
        
        console.log('📝 Updated worklog:', worklogs[worklogIndex]);
        return true;
    };

    const endWorklog = (worklogId, status = 'completed') => {
        const worklog = worklogs.find(w => w.id === worklogId);
        if (!worklog) return false;
        
        const endTime = new Date();
        const startTime = new Date(worklog.startTime);
        const totalSeconds = Math.floor((endTime - startTime) / 1000);
        const activeSeconds = totalSeconds - worklog.pausedTime;
        const duration = Math.floor(activeSeconds / 60);
        
        updateWorklog(worklogId, {
            endTime: endTime.toISOString(),
            duration: duration,
            status: status
        });
        
        console.log('📝 Ended worklog:', worklogs.find(w => w.id === worklogId));
        return true;
    };

    const pauseWorklog = (worklogId) => {
        const worklog = worklogs.find(w => w.id === worklogId);
        if (!worklog) return false;
        
        updateWorklog(worklogId, {
            status: 'paused',
            pauseCount: worklog.pauseCount + 1
        });
        
        console.log('📝 Paused worklog:', worklogId);
        return true;
    };

    const resumeWorklog = (worklogId) => {
        const worklog = worklogs.find(w => w.id === worklogId);
        if (!worklog) return false;
        
        updateWorklog(worklogId, {
            status: 'active'
        });
        
        console.log('📝 Resumed worklog:', worklogId);
        return true;
    };

    const saveWorklogsToFirestore = async () => {
        if (!currentUser) return;
        
        try {
            const userDocRef = window.doc(db, 'users', currentUser.uid);
            await window.setDoc(userDocRef, {
                worklogs: worklogs
            }, { merge: true });
            console.log('💾 Worklogs saved to Firestore');
        } catch (error) {
            console.error('❌ Error saving worklogs to Firestore:', error);
        }
    };

    const loadWorklogsFromFirestore = async (userId) => {
        try {
            const userDocRef = window.doc(db, 'users', userId);
            const docSnap = await window.getDoc(userDocRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                worklogs = data.worklogs || [];
                console.log('📥 Loaded worklogs from Firestore:', worklogs.length);
            }
        } catch (error) {
            console.error('❌ Error loading worklogs from Firestore:', error);
            worklogs = [];
        }
    };

    // --- WORKLOG ANALYTICS FUNCTIONS ---
    const getWorklogAnalytics = (days = 7) => {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - days);
        
        const filteredWorklogs = worklogs.filter(worklog => {
            const worklogDate = new Date(worklog.startTime);
            return worklogDate >= startDate && worklogDate <= endDate && worklog.status === 'completed';
        });
        
        const analytics = {
            totalSessions: filteredWorklogs.length,
            totalTime: filteredWorklogs.reduce((sum, worklog) => sum + worklog.duration, 0),
            averageSessionLength: 0,
            sessionsByDay: {},
            sessionsByTask: {},
            sessionsByContext: {},
            sessionsByEnergy: {},
            totalPauseTime: filteredWorklogs.reduce((sum, worklog) => sum + worklog.pausedTime, 0),
            averagePausesPerSession: 0,
            mostProductiveDay: null,
            mostWorkedOnTask: null
        };
        
        if (analytics.totalSessions > 0) {
            analytics.averageSessionLength = Math.round(analytics.totalTime / analytics.totalSessions);
            analytics.averagePausesPerSession = Math.round(
                filteredWorklogs.reduce((sum, worklog) => sum + worklog.pauseCount, 0) / analytics.totalSessions
            );
        }
        
        // Group by day
        filteredWorklogs.forEach(worklog => {
            const day = worklog.startTime.split('T')[0];
            if (!analytics.sessionsByDay[day]) {
                analytics.sessionsByDay[day] = { sessions: 0, time: 0 };
            }
            analytics.sessionsByDay[day].sessions++;
            analytics.sessionsByDay[day].time += worklog.duration;
        });
        
        // Group by task
        filteredWorklogs.forEach(worklog => {
            const task = tasks.find(t => t.id === worklog.taskId);
            const taskName = task ? task.name : 'Unknown Task';
            if (!analytics.sessionsByTask[taskName]) {
                analytics.sessionsByTask[taskName] = { sessions: 0, time: 0 };
            }
            analytics.sessionsByTask[taskName].sessions++;
            analytics.sessionsByTask[taskName].time += worklog.duration;
        });
        
        // Group by context
        filteredWorklogs.forEach(worklog => {
            const context = worklog.context || 'Unknown';
            if (!analytics.sessionsByContext[context]) {
                analytics.sessionsByContext[context] = { sessions: 0, time: 0 };
            }
            analytics.sessionsByContext[context].sessions++;
            analytics.sessionsByContext[context].time += worklog.duration;
        });
        
        // Group by energy
        filteredWorklogs.forEach(worklog => {
            const energy = worklog.energy || 'Unknown';
            if (!analytics.sessionsByEnergy[energy]) {
                analytics.sessionsByEnergy[energy] = { sessions: 0, time: 0 };
            }
            analytics.sessionsByEnergy[energy].sessions++;
            analytics.sessionsByEnergy[energy].time += worklog.duration;
        });
        
        // Find most productive day
        let maxTime = 0;
        Object.entries(analytics.sessionsByDay).forEach(([day, data]) => {
            if (data.time > maxTime) {
                maxTime = data.time;
                analytics.mostProductiveDay = { day, ...data };
            }
        });
        
        // Find most worked on task
        let maxTaskTime = 0;
        Object.entries(analytics.sessionsByTask).forEach(([taskName, data]) => {
            if (data.time > maxTaskTime) {
                maxTaskTime = data.time;
                analytics.mostWorkedOnTask = { taskName, ...data };
            }
        });
        
        console.log('📊 Worklog Analytics:', analytics);
        return analytics;
    };

    // --- TIMER AND FOCUS FUNCTIONS ---
    const updateTimerDisplay = () => {
        const minutes = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
        const seconds = (elapsedSeconds % 60).toString().padStart(2, '0');
        const timeString = `${minutes}:${seconds}`;
        focusTimerDisplay.textContent = timeString;
        document.title = `${timeString} - ${focusTaskName.textContent}`;
    };

    const startTimer = () => {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (!isPaused) {
                elapsedSeconds++;
                updateTimerDisplay();
                
                // Update localStorage with current session state
                if (currentFocusTaskId && currentWorklogId) {
                    const sessionData = {
                        taskId: currentFocusTaskId,
                        worklogId: currentWorklogId,
                        startTime: startTime,
                        sessionDuration: sessionLength || 25,
                        elapsedTime: elapsedSeconds * 1000,
                        pausedTime: pausedTime,
                        isPaused: isPaused
                    };
                    saveFocusSessionToStorage(sessionData);
                }
            }
        }, 1000);
    };
    
    const stopFocusSession = (confirmFirst = true) => {
        if (!confirmFirst) {
            // Direct stop without confirmation (used when completing task)
            clearInterval(timerInterval);
            document.body.classList.remove('overflow-hidden');
            timerInterval = null;
            isPaused = false;
            
            // End worklog if exists
            if (currentWorklogId) {
                endWorklog(currentWorklogId, 'cancelled');
                saveWorklogsToFirestore();
                currentWorklogId = null;
            }
            
            // Clear localStorage
            clearFocusSessionFromStorage();
            
            currentFocusTaskId = null;
            focusOverlay.classList.add('hidden');
            document.title = originalTitle;
            return;
        }
        
        // For Progress tasks, show action buttons directly
        if (currentTask && currentTask.isDivisible) {
            clearInterval(timerInterval);
            timerInterval = null;
            isPaused = false;
            clearFocusSessionFromStorage();
            showActionButtons();
            return;
        }
        
        // For Atomic tasks, stop directly without confirmation
        if (currentTask && !currentTask.isDivisible) {
        clearInterval(timerInterval);
        document.body.classList.remove('overflow-hidden');
        timerInterval = null;
        isPaused = false;
        clearFocusSessionFromStorage();
        currentFocusTaskId = null;
        focusOverlay.classList.add('hidden');
        document.title = originalTitle;
            return;
        }
        
        // Fallback: show confirmation modal
        showModal(stopFocusModalOverlay);
    };

    const executeStopFocusSession = () => {
        clearInterval(timerInterval);
        timerInterval = null;
        isPaused = false;
        
        // Show action buttons when timer stops
        showActionButtons();
        
        closeStopFocusModal();
    };

    const closeStopFocusModal = () => {
        hideModal(stopFocusModalOverlay);
    };

    const showStartTaskModal = (taskId) => {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        
        // Populate modal with task details
        document.getElementById('startTaskName').textContent = task.name;
        
        let details = '';
        if (task.isDivisible) {
            details = `Progress Task • ${task.sessionTimeBracket || task.minSessionTime || task.totalTimeBracket || 'Quick'}`;
            if (task.timeSpent > 0) {
                details += ` • ${task.timeSpent} min spent`;
            }
        } else {
            details = `Atomic Task • ${task.timeBracket || 'Quick'}`;
        }
        
        if (task.energy) {
            details += ` • ${task.energy}`;
        }
        
        document.getElementById('startTaskDetails').textContent = details;
        
        // Store task ID for confirmation
        startTaskModalOverlay.dataset.taskId = taskId;
        
        // Show modal
        document.body.classList.add('overflow-hidden');
        showModal(startTaskModalOverlay);
    };

    const closeStartTaskModal = () => {
        document.body.classList.remove('overflow-hidden');
        hideModal(startTaskModalOverlay);
        startTaskModalOverlay.dataset.taskId = '';
    };

    const showCompleteTaskModal = () => {
        if (!currentTask || !currentFocusTaskId) return;
        
        // Populate modal with task details
        document.getElementById('completeTaskName').textContent = currentTask.name;
        
        let details = '';
        if (currentTask.isDivisible) {
            details = `Progress Task • ${currentTask.sessionTimeBracket || currentTask.minSessionTime || currentTask.totalTimeBracket || 'Quick'}`;
            if (currentTask.timeSpent > 0) {
                details += ` • ${currentTask.timeSpent} min spent`;
            }
        } else {
            details = `Atomic Task • ${currentTask.timeBracket || 'Quick'}`;
        }
        
        if (currentTask.energy) {
            details += ` • ${currentTask.energy}`;
        }
        
        // Add current session time
        const currentSessionTime = Math.floor(elapsedSeconds / 60);
        if (currentSessionTime > 0) {
            details += ` • ${currentSessionTime} min this session`;
        }
        
        document.getElementById('completeTaskDetails').textContent = details;
        
        // Show modal
        document.body.classList.add('overflow-hidden');
        showModal(completeTaskModalOverlay);
    };

    const closeCompleteTaskModal = () => {
        document.body.classList.remove('overflow-hidden');
        hideModal(completeTaskModalOverlay);
    };

    const saveProgress = () => {
        if (!currentTask || !currentFocusTaskId) return;
        
        const timeSpent = Math.floor(elapsedSeconds / 60); // Convert to minutes
        const taskIndex = tasks.findIndex(t => t.id === currentFocusTaskId);
        
        if (taskIndex === -1) return;
        
        // End the current worklog
        if (currentWorklogId) {
            endWorklog(currentWorklogId, 'completed');
            saveWorklogsToFirestore();
        }
        
        // Add time spent to existing time (no upper limit for Progress tasks)
        tasks[taskIndex].timeSpent = (tasks[taskIndex].timeSpent || 0) + timeSpent;
        
        saveDataToFirestore();
        
        // Show success message
        const message = `Progress saved! +${timeSpent} min (Total: ${tasks[taskIndex].timeSpent} min)`;
        const filteredList = document.getElementById('filteredList');
        if (filteredList) {
            filteredList.innerHTML = `<div class="text-center text-orange-600 p-4 bg-orange-50 rounded-lg border border-orange-200 shadow-sm animate-fade-in">${message}</div>`;
            setTimeout(() => { 
                if(filteredList.firstChild && filteredList.firstChild.textContent.includes(message)) {
                    filteredList.innerHTML = '';
                }
            }, 4000);
        }
        
        // Update content area and re-render tasks to show progress
        updateContentArea();
        renderAll();
        
        // Close timer
        stopFocusSession(false);
    };

    const clearAllFilters = () => {
        // Reset all selections
        selectedMode = null;
        selectedTimeFilter = null;
        selectedEnergyFilters = [];
        selectedProjectFilters = [];
        selectedTagFilters = [];
        filterByPriorityOnly = false;
        
        // Reset mode buttons
        document.getElementById('workModeBtn').classList.remove('bg-blue-500', 'text-white', 'shadow-sm');
        document.getElementById('workModeBtn').classList.add('text-slate-700');
        document.getElementById('personalModeBtn').classList.remove('bg-blue-500', 'text-white', 'shadow-sm');
        document.getElementById('personalModeBtn').classList.add('text-slate-700');
        
        // Reset time filters
        document.querySelectorAll('.time-filter').forEach(b => {
            b.classList.remove('bg-blue-500','text-white','border-blue-500');
            b.classList.add('bg-slate-100','text-slate-600');
        });
        
        // Reset advanced filters
        document.querySelectorAll('.energy-filter').forEach(b => {
            b.classList.remove('bg-blue-500','text-white','border-blue-500');
            b.classList.add('bg-slate-100','text-slate-600');
        });
        document.querySelectorAll('.project-filter').forEach(b => {
            b.classList.remove('bg-blue-500','text-white','border-blue-500');
            b.classList.add('bg-slate-100','text-slate-600');
        });
        document.querySelectorAll('.tag-filter').forEach(b => {
            b.classList.remove('bg-blue-500','text-white','border-blue-500');
            b.classList.add('bg-slate-100','text-slate-600');
        });
        
        // Clear custom time input
        const customTimeInput = document.getElementById('customTimeFilterInput');
        if (customTimeInput) {
            customTimeInput.value = '';
            customTimeInput.classList.remove('bg-blue-50', 'border-blue-500', 'ring-2', 'ring-blue-200');
            customTimeInput.classList.add('border-slate-300');
        }
        
        // Reset priority only toggle
        const priorityOnlyToggle = document.getElementById('priorityOnlyToggle');
        if (priorityOnlyToggle) {
            priorityOnlyToggle.checked = false;
        }
        
        // Hide task suggestions
        document.getElementById('taskSuggestionsSection').classList.add('hidden');
        
        // Show content area
        document.getElementById('contentArea').classList.remove('hidden');
        updateContentArea();
    };

    const completeTask = () => {
        if (!currentTask || !currentFocusTaskId) return;
        
        const timeSpent = Math.floor(elapsedSeconds / 60); // Convert to minutes
        const taskIndex = tasks.findIndex(t => t.id === currentFocusTaskId);
        
        if (taskIndex === -1) return;
        
        // End the current worklog
        if (currentWorklogId) {
            endWorklog(currentWorklogId, 'completed');
            saveWorklogsToFirestore();
        }
        
        // Mark task as complete
        const completedTask = { ...tasks[taskIndex], completedAt: new Date().toISOString() };
        completedTasks.push(completedTask);
        tasks.splice(taskIndex, 1);
        updateStreak();
        saveDataToFirestore();
        
        // Clear all filters and refresh suggestions
        clearAllFilters();
        
        // Show success message
        const message = `Task completed! Time spent: ${timeSpent} min`;
        const filteredList = document.getElementById('filteredList');
        if (filteredList) {
            filteredList.innerHTML = `<div class="text-center text-green-600 p-4 bg-green-50 rounded-lg border border-green-200 shadow-sm animate-fade-in">${message}</div>`;
            setTimeout(() => { 
                if(filteredList.firstChild && filteredList.firstChild.textContent.includes(message)) {
                    filteredList.innerHTML = '';
                }
            }, 4000);
        }
        
        // Update content area
        updateContentArea();
        
        // Close timer
        stopFocusSession(false);
    };

    const showActionButtons = () => {
        if (!currentTask) return;
        
        if (currentTask.isDivisible) {
            // Progress task - show both Save Progress and Complete Task buttons
            focusSaveProgressBtn.classList.remove('hidden');
            focusCompleteBtn.classList.remove('hidden');
            
            // Update Save Progress button text
            focusSaveProgressBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                <span>Save Progress</span>
            `;
            
            // Update Complete Task button text
            focusCompleteBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                <span>Complete Task</span>
            `;
        } else {
            // Atomic task - show only Mark as Complete button
            focusCompleteBtn.classList.remove('hidden');
            focusSaveProgressBtn.classList.add('hidden');
            
            // Update Mark as Complete button text
            focusCompleteBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                <span>Mark as Complete</span>
            `;
        }
    };

    const startFocusSession = (taskId, sessionLengthMinutes = null) => {
        const task = tasks.find(t => t.id === taskId);
        if (!task) {
            console.error("Task not found for ID:", taskId);
            return;
        }
        document.body.classList.add('overflow-hidden');
        currentFocusTaskId = taskId;
        currentTask = task;
        sessionLength = sessionLengthMinutes;
        
        // Create worklog for this session
        createWorklog(taskId, 'focus');
        
        // Reset timer
        elapsedSeconds = 0;
        isPaused = false;
        
        // Save session to localStorage for persistence
        const sessionData = {
            taskId: taskId,
            worklogId: currentWorklogId,
            startTime: Date.now(),
            sessionDuration: sessionLength || 25,
            elapsedTime: 0,
            pausedTime: 0,
            isPaused: false
        };
        saveFocusSessionToStorage(sessionData);
        
        // Determine time bracket to display
        let timeBracketText = '';
        if (sessionLength) {
            // Task started from Find a task - show session length
            timeBracketText = `${sessionLength} min session`;
        } else if (task.isDivisible) {
            // Progress task - show session time bracket
            timeBracketText = `Session: ${task.sessionTimeBracket || task.minSessionTime || task.totalTimeBracket || 'Quick'}`;
        } else {
            // Atomic task - show time bracket
            timeBracketText = `Time: ${task.timeBracket || 'Quick'}`;
        }
        
        focusTaskName.textContent = task.name;
        document.getElementById('focusTimeBracket').textContent = timeBracketText;
        updateTimerDisplay(); 
        
        // Reset button states
        document.getElementById('focusPauseText').textContent = 'Pause';
        document.getElementById('pauseIcon').classList.remove('hidden');
        document.getElementById('playIcon').classList.add('hidden');

        // Show control buttons (Pause and Stop)
        focusPauseBtn.classList.remove('hidden');
        focusStopBtn.classList.remove('hidden');
        
        // Show appropriate action buttons based on task type
        if (task.isDivisible) {
            // Progress task - hide action buttons initially, they'll appear when timer stops
            focusSaveProgressBtn.classList.add('hidden');
        focusCompleteBtn.classList.add('hidden');
            
            // Update Stop button text for Progress tasks
            focusStopBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" /></svg>
                <span>Stop</span>
            `;
        } else {
            // Atomic task - show Mark as Complete button immediately
            focusCompleteBtn.classList.remove('hidden');
            focusSaveProgressBtn.classList.add('hidden');
            
            // Update Stop button text for Atomic tasks
            focusStopBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" /></svg>
                <span>Stop & Discard</span>
            `;
            
            // Update Mark as Complete button text
            focusCompleteBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                <span>Mark as Complete</span>
            `;
        }
        
        focusOverlay.classList.remove('hidden');
        startTimer();
    };
      
    const renderSuggestedTask = (task, isSurprise = false) => {
          const div = document.createElement('div');
          const baseClasses = 'bg-white border rounded-xl p-4 animate-fade-in flex items-center justify-between';
          div.className = isSurprise
              ? `${baseClasses} border-2 border-blue-500 shadow-lg`
              : `${baseClasses} border-slate-200`;
          
          div.innerHTML = `
              <div class="flex-grow">
                <h3 class="font-bold text-slate-900 flex items-center">
                  ${task.name}
                  ${task.isRecurring ? `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-2 text-blue-500 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>` : ''}
                ${task.isDivisible ? `<span class="ml-2 text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-medium">Progress</span>` : `<span class="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">Atomic</span>`}
                </h3>
              <p class="text-sm text-slate-500">Time: ${task.isDivisible ? `${task.totalTimeBracket || task.totalTime} (${task.sessionTimeBracket || task.minSessionTime})` : `${task.timeBracket || task.time}`}${task.energy ? ` | Energy: ${task.energy}` : ''}</p>
              ${task.isDivisible ? `
                <div class="mt-2">
                  ${task.timeSpent > 0 ? `
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                      <span>Progress</span>
                      <span>${task.timeSpent}/${task.totalTime} min (${Math.round((task.timeSpent / task.totalTime) * 100)}%)</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2">
                      <div class="bg-orange-500 h-2 rounded-full transition-all duration-300" style="width: ${Math.min((task.timeSpent / task.totalTime) * 100, 100)}%"></div>
                    </div>
                  ` : `
                    <div class="text-xs text-slate-400">
                      <span class="inline-flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        ~${Math.ceil(task.totalTime / task.minSessionTime)} sessions to complete
                      </span>
                    </div>
                  `}
                </div>
              ` : ''}
                 <div class="flex flex-wrap gap-2 mt-2 ${task.tags.length === 0 ? 'hidden' : ''}">
                    ${task.tags.map(tag => `<span class="text-xs bg-slate-100 text-slate-600 font-medium px-2 py-1 rounded-md">${tag}</span>`).join('')}
                </div>
              </div>
              <button data-task-id="${task.id}" class="start-btn ml-4 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition-colors font-semibold shrink-0 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600">Start</button>
          `;
          filteredList.appendChild(div);
    };

    // --- SIMPLIFIED TASK SUGGESTION SYSTEM ---
    let currentSuggestions = []; // Store current suggestions to avoid reshuffling on mode changes
    
    const generateTaskSuggestions = () => {
        if (!selectedMode || !selectedTimeFilter) {
            document.getElementById('taskSuggestionsSection').classList.add('hidden');
            return;
        }

        const candidates = getTaskCandidates();
        currentSuggestions = selectTopTasks(candidates, 3, true); // Use randomization for reshuffle
        
        renderTaskSuggestions(currentSuggestions);
        document.getElementById('taskSuggestionsSection').classList.remove('hidden');
        
        // Auto-collapse Task Review section when tasks are shown
        taskReviewCollapsed = true;
        renderCompletedTasks();
        renderWeeklyReview();
    };

    const updateTaskSuggestionsForMode = () => {
        if (!selectedMode || !selectedTimeFilter) {
            document.getElementById('taskSuggestionsSection').classList.add('hidden');
            return;
        }

        // If we have existing suggestions, filter them by the new mode instead of regenerating
        if (currentSuggestions.length > 0) {
            const filteredSuggestions = currentSuggestions.filter(task => {
                // Check if task matches the new mode
                const modeMatches = task.contexts && (
                    task.contexts.includes(selectedMode) || // New simplified contexts
                    (selectedMode === 'Work' && (task.contexts.includes('Workday') || task.contexts.includes('Work'))) || // Work mode
                    (selectedMode === 'Personal' && (task.contexts.includes('Evening') || task.contexts.includes('Weekend') || task.contexts.includes('Home') || task.contexts.includes('Personal'))) // Personal mode
                );
                return modeMatches;
            });
            
            // If we have enough filtered suggestions, use them
            if (filteredSuggestions.length >= 3) {
                renderTaskSuggestions(filteredSuggestions.slice(0, 3));
                document.getElementById('taskSuggestionsSection').classList.remove('hidden');
                
                // Auto-collapse Task Review section when tasks are shown
                taskReviewCollapsed = true;
                renderCompletedTasks();
                renderWeeklyReview();
                return;
            }
        }
        
        // Fallback: generate new suggestions if filtering doesn't work
        const candidates = getTaskCandidates();
        currentSuggestions = selectTopTasks(candidates, 3, false); // No randomization for mode changes
        
        renderTaskSuggestions(currentSuggestions);
        document.getElementById('taskSuggestionsSection').classList.remove('hidden');
        
        // Auto-collapse Task Review section when tasks are shown
        taskReviewCollapsed = true;
        renderCompletedTasks();
        renderWeeklyReview();
    };

    const getTaskCandidates = () => {
        return tasks.filter(task => {
            // Filter for active tasks only (treat undefined as active for backward compatibility)
            if (task.isActive === false) return false;
            
            // Filter by priority only if enabled
            if (filterByPriorityOnly && task.isPriority !== true) return false;
            
            // Filter by mode (Work or Personal) - handle both old and new context values
            const modeMatches = task.contexts && (
                task.contexts.includes(selectedMode) || // New simplified contexts
                (selectedMode === 'Work' && (task.contexts.includes('Workday') || task.contexts.includes('Work'))) || // Work mode
                (selectedMode === 'Personal' && (task.contexts.includes('Evening') || task.contexts.includes('Weekend') || task.contexts.includes('Home') || task.contexts.includes('Personal'))) // Personal mode
            );
            if (!modeMatches) return false;

            // Filter by time
            const timeMatches = checkTimeMatch(task, selectedTimeFilter);
            if (!timeMatches) return false;

            // Apply advanced filters if they're set
            if (selectedEnergyFilters.length > 0) {
                const energyMatches = selectedEnergyFilters.includes(task.energy);
                if (!energyMatches) return false;
            }

            if (selectedProjectFilters.length > 0) {
                const projectMatches = task.projectId && selectedProjectFilters.includes(task.projectId);
                if (!projectMatches) return false;
            }

            if (selectedTagFilters.length > 0) {
                const tagMatches = task.tags && task.tags.some(tag => selectedTagFilters.includes(tag));
                if (!tagMatches) return false;
            }

            return true;
        });
    };

    // Convert time brackets to minute ranges
    const getTimeBracketRange = (bracket) => {
        switch (bracket) {
            case 'Quick': return { min: 1, max: 15 };
            case 'Standard': return { min: 15, max: 45 };
            case 'Long': return { min: 45, max: 90 };
            default: return { min: 0, max: 0 };
        }
    };

    const checkTimeMatch = (task, timeAvailable) => {
        // Handle both old format (specific minutes) and new format (time brackets)
        if (task.timeBracket || task.totalTimeBracket || task.sessionTimeBracket) {
            // New format: use time brackets
            const taskBracket = task.isDivisible ? task.sessionTimeBracket : task.timeBracket;
            const bracketRange = getTimeBracketRange(taskBracket);
            
            // Quick tasks can be done in any available time (1+ minutes)
            if (taskBracket === 'Quick') {
                return timeAvailable >= 1;
            }
            // Standard tasks need at least 15 minutes
            else if (taskBracket === 'Standard') {
                return timeAvailable >= 15;
            }
            // Long tasks need at least 45 minutes
            else if (taskBracket === 'Long') {
                return timeAvailable >= 45;
            }
            
            // Fallback to original logic for other cases
            return timeAvailable >= bracketRange.min && timeAvailable <= bracketRange.max;
        } else {
            // Old format: use specific minutes with tolerance
            const tolerance = 10; // ±10 minutes tolerance
            const taskTime = task.isDivisible ? task.minSessionTime : task.time;
            return taskTime <= timeAvailable + tolerance;
        }
    };

    const selectTopTasks = (candidates, count, useRandomization = true) => {
        performanceMonitor.startTimer('selectTopTasks');
        
        // Create cache key based on input parameters
        const cacheKey = `${candidates.length}-${count}-${useRandomization}-${selectedTimeFilter}-${selectedMode}`;
        
        // Check cache first
        if (taskSuggestionsCache.has(cacheKey)) {
            const cached = taskSuggestionsCache.get(cacheKey);
            // Verify the cached result is still valid (same candidates)
            if (cached.candidatesHash === candidates.length) {
                console.log('🚀 Cache hit for selectTopTasks');
                performanceMonitor.endTimer('selectTopTasks (cached)');
                return cached.result;
            }
        }
        
        const today = new Date().toISOString().slice(0, 10);
        
        // Smart scoring system based on time bracket priority
        const scored = candidates.map(task => {
            let score = 0;
            
            // TODAY TASK PRIORITY - Highest priority for tasks scheduled today
            if (task.dailyPlanDate === today) {
                score += 1000; // Highest priority - even above starred tasks
            }
            
            // PRIORITY TASK BOOST - Heavily favor priority tasks
            if (task.isPriority === true) {
                score += 500; // High boost but below today's tasks
            }
            
            // Time bracket priority scoring
            if (task.timeBracket || task.totalTimeBracket || task.sessionTimeBracket) {
                // New format: use time brackets
                const taskBracket = task.isDivisible ? task.sessionTimeBracket : task.timeBracket;
                const bracketRange = getTimeBracketRange(taskBracket);
                
                // When there's plenty of time (60+ minutes), favor longer tasks
                if (selectedTimeFilter >= 60) {
                    // Priority 1: Long tasks for very long available times
                    if (taskBracket === 'Long') {
                        score += 25; // Highest priority for long sessions
                    }
                    // Priority 2: Standard tasks for medium available times
                    else if (taskBracket === 'Standard') {
                        score += 20; // Good priority for long sessions
                    }
                    // Priority 3: Quick tasks (can be done anytime)
                    else if (taskBracket === 'Quick') {
                        score += 15; // Lower priority when there's lots of time
                    }
                }
                // When there's moderate time (30-59 minutes), balance all types
                else if (selectedTimeFilter >= 30) {
                    // Priority 1: Standard tasks for medium available times
                    if (taskBracket === 'Standard') {
                        score += 22; // Highest priority for medium sessions
                    }
                    // Priority 2: Quick tasks can be done in any available time
                    else if (taskBracket === 'Quick') {
                        score += 20; // Good priority
                    }
                    // Priority 3: Long tasks only for very long available times
                    else if (taskBracket === 'Long') {
                        score += 10; // Lower priority for medium sessions
                    }
                }
                // When there's limited time (<30 minutes), favor quick tasks
                else {
                    // Priority 1: Quick tasks can be done in any available time (highest flexibility)
                    if (taskBracket === 'Quick') {
                        score += 20; // Highest priority - most flexible
                    }
                    // Priority 2: Standard tasks for medium available times
                    else if (taskBracket === 'Standard') {
                        score += 15; // Second priority
                    }
                    // Priority 3: Long tasks only for very long available times
                    else if (taskBracket === 'Long') {
                        score += 10; // Third priority
                    }
                }
            } else {
                // Old format: use specific minutes
            const taskTime = task.isDivisible ? task.minSessionTime : task.time;
            const timeDiff = Math.abs(taskTime - selectedTimeFilter);
            score += Math.max(0, 10 - timeDiff); // 0-10 points based on time fit
            }
            
            // Energy match bonus
            if (selectedEnergyFilters.length > 0 && selectedEnergyFilters.includes(task.energy)) {
                score += 5;
            }
            
            // Project match bonus
            if (selectedProjectFilters.length > 0 && task.projectId && selectedProjectFilters.includes(task.projectId)) {
                score += 5;
            }
            
            // Tag match bonus
            if (selectedTagFilters.length > 0 && task.tags) {
                const matchingTags = task.tags.filter(tag => selectedTagFilters.includes(tag)).length;
                score += matchingTags * 2;
            }
            
            // Random factor to add variety (only when explicitly reshuffling)
            if (useRandomization) {
            score += Math.random() * 3;
            }
            
            return { task, score };
        });

        // Sort by score and return top tasks
        const result = scored.sort((a, b) => b.score - a.score).slice(0, count).map(item => item.task);
        
        // Cache the result
        taskSuggestionsCache.set(cacheKey, {
            result: result,
            candidatesHash: candidates.length,
            timestamp: Date.now()
        });
        
        // Limit cache size to prevent memory leaks
        if (taskSuggestionsCache.size > 50) {
            const firstKey = taskSuggestionsCache.keys().next().value;
            taskSuggestionsCache.delete(firstKey);
        }
        
        performanceMonitor.endTimer('selectTopTasks');
        return result;
    };

    const renderTaskSuggestions = (suggestions) => {
        const container = document.getElementById('taskSuggestions');
        
        if (suggestions.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center p-6 bg-amber-50 rounded-lg border border-amber-200">
                    <h4 class="font-semibold text-amber-800 mb-2">No tasks found</h4>
                    <p class="text-sm text-amber-700">No tasks match your current filters. Try adjusting your time or mode.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = suggestions.map(task => {
            const taskTime = task.isDivisible ? task.minSessionTime : task.time;
            const isProgressTask = task.isDivisible;
            const today = new Date().toISOString().slice(0, 10);
            const isTodayTask = task.dailyPlanDate === today;
            
            // Debug: Log task data to see where energy is coming from
            if (task.name === 'Newer test') {
                console.log('🔍 Debug - Newer test task data:', task);
                console.log('🔍 Debug - task.energy:', task.energy);
            }
            
            const timeDisplay = task.isDivisible ? 
                `${task.totalTimeBracket || task.totalTime} (${task.sessionTimeBracket || task.minSessionTime})` : 
                `${task.timeBracket || task.time}`;
            
            return `
                <div class="bg-white border ${isTodayTask ? 'border-amber-300' : 'border-slate-200'} rounded-lg p-4 hover:shadow-md transition-shadow h-full flex flex-col ${isTodayTask ? 'bg-amber-50' : ''}">
                    <h4 class="font-semibold ${isTodayTask ? 'text-amber-800' : 'text-slate-800'} mb-2 text-sm flex-shrink-0 flex items-start">
                        <span class="flex items-center">
                            ${task.name}
                        </span>
                        ${isProgressTask ? '<span class="ml-1 text-xs bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded-full font-medium flex-shrink-0">P</span>' : '<span class="ml-1 text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-full font-medium flex-shrink-0">A</span>'}
                    </h4>
                    <div class="flex flex-wrap gap-1 mb-3 flex-shrink-0">
                        <span class="text-xs px-2 py-1 rounded-full ${isTodayTask ? 'bg-amber-200 text-amber-800' : 'bg-blue-100 text-blue-700'}">${timeDisplay}</span>
                        ${task.energy ? `<span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700">${task.energy}</span>` : ''}
                    </div>
                    <div class="flex gap-2 mt-auto">
                        <button data-task-id="${task.id}" class="start-btn w-full bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                            Start
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        // Auto-collapse Task Review section when tasks are shown
        if (suggestions.length > 0) {
            taskReviewCollapsed = true;
            renderCompletedTasks();
            renderWeeklyReview();
        }
    };

    const updateModeSelection = (selectedBtnId, unselectedBtnId) => {
        const selectedBtn = document.getElementById(selectedBtnId);
        const unselectedBtn = document.getElementById(unselectedBtnId);
        
        // Update selected button - solid blue background with white text
        selectedBtn.classList.add('bg-blue-500', 'text-white', 'shadow-sm');
        selectedBtn.classList.remove('text-slate-700');
        
        // Update unselected button - transparent background with dark text
        unselectedBtn.classList.remove('bg-blue-500', 'text-white', 'shadow-sm');
        unselectedBtn.classList.add('text-slate-700');
    };

    const applyFiltersAndSuggest = (mode = 'suggest') => {
        filteredList.innerHTML = '';
        const activeEnergyFilter = selectedEnergyFilters[0] || null;
        
        // Hide content area when filters are applied to focus on tasks
        document.getElementById('contentArea').classList.add('hidden');
        
        if (mode === 'surprise') {
            if (tasks.length === 0) {
                filteredList.innerHTML = `<div class="text-center text-slate-500 p-4 bg-white rounded-xl border border-slate-200">Add some tasks to be surprised!</div>`;
                return;
            }
            const taskToSuggest = tasks[Math.floor(Math.random() * tasks.length)];
            renderSuggestedTask(taskToSuggest, true);
        } else {
            const potentialTasks = tasks.filter(task => {
                const timeMatches = () => {
                  if (!selectedTimeFilter) return true;
                  let tolerance = 5;
                  if (selectedTimeFilter >= 30) tolerance = 10;
                    
                    // For Atomic Tasks: use task.time
                    // For Progress Tasks: use task.minSessionTime (minimum session requirement)
                    const taskTime = task.isDivisible ? task.minSessionTime : task.time;
                    return taskTime <= selectedTimeFilter + tolerance;
                };
                const contextMatches = selectedContextFilters.length === 0 || task.contexts.some(c => selectedContextFilters.includes(c));
                const energyMatches = () => {
                    if (!activeEnergyFilter) return true;
                    const selectedEnergyIndex = energyLevels.indexOf(activeEnergyFilter);
                    const taskEnergyIndex = energyLevels.indexOf(task.energy);
                    return taskEnergyIndex <= selectedEnergyIndex;
                };
                const tagMatches = () => {
                    if (selectedTagFilters.length === 0) return true;
                    return selectedTagFilters.some(tag => task.tags && task.tags.includes(tag));
                };
                
                return timeMatches() && contextMatches && energyMatches() && tagMatches();
            });

            if (potentialTasks.length > 0) {
                // Sort tasks by relevance score (highest first)
                const scoredTasks = potentialTasks.map(task => {
                    let score = 0;
                    
                    // Time matching score (most important)
                    if (selectedTimeFilter) {
                        const taskTime = task.isDivisible ? task.minSessionTime : task.time;
                        const timeDiff = Math.abs(taskTime - selectedTimeFilter);
                        
                        if (timeDiff === 0) {
                            score += 100; // Perfect match
                        } else if (timeDiff <= 5) {
                            score += 80; // Very close
                        } else if (timeDiff <= 10) {
                            score += 60; // Close
                        } else if (timeDiff <= 15) {
                            score += 40; // Reasonable
                        } else {
                            score += 20; // Acceptable but not ideal
                        }
                    } else {
                        score += 50; // No time filter, neutral score
                    }
                    
                    // Energy matching score
                    if (activeEnergyFilter) {
                        const selectedEnergyIndex = energyLevels.indexOf(activeEnergyFilter);
                        const taskEnergyIndex = energyLevels.indexOf(task.energy);

                        if (taskEnergyIndex === selectedEnergyIndex) {
                            score += 50; // Perfect energy match
                        } else if (Math.abs(taskEnergyIndex - selectedEnergyIndex) === 1) {
                            score += 30; // Close energy match
                        } else {
                            score += 10; // Acceptable energy
                        }
                    } else {
                        score += 25; // No energy filter, neutral score
                    }
                    
                    // Context matching bonus
                    if (selectedContextFilters.length > 0) {
                        const matchingContexts = task.contexts.filter(c => selectedContextFilters.includes(c)).length;
                        score += matchingContexts * 15; // 15 points per matching context
                    }
                    
                    // Tag matching bonus
                    if (selectedTagFilters.length > 0) {
                        const matchingTags = task.tags ? task.tags.filter(tag => selectedTagFilters.includes(tag)).length : 0;
                        score += matchingTags * 10; // 10 points per matching tag
                    }
                    
                    // Prefer tasks that haven't been started recently
                    if (task.timeSpent === 0) {
                        score += 5; // Small bonus for fresh tasks
                    }
                    
                    return { task, score };
                });
                
                // Sort by score (highest first) and render
                scoredTasks
                    .sort((a, b) => b.score - a.score)
                    .forEach(({ task }) => renderSuggestedTask(task, false));
            } else {
                filteredList.innerHTML = `<div class="text-center text-slate-400 p-4 bg-white rounded-xl border border-slate-200">
                    ${emptyFilterSVG}
                    <p class="mt-2 font-medium text-slate-500">No tasks found</p>
                    <p>Try adjusting your filters.</p>
                </div>`;
            }
        }
    };
      
    const applySmartDefaults = () => {
        const now = new Date();
        const hour = now.getHours();
        const day = now.getDay();
        
        let defaultContext = null;
        if (day >= 1 && day <= 5) { // Weekday
            if (hour >= 9 && hour < 17) defaultContext = 'Workday';
            else if (hour >=17 && hour < 22) defaultContext = 'Evening';
        } else { // Weekend
            defaultContext = 'Weekend';
        }

        if (defaultContext) {
            const contextButton = document.querySelector(`.context-filter[data-context="${defaultContext}"]`);
            if (contextButton) {
                selectedContextFilters = [defaultContext];
                contextButton.classList.remove('bg-white', 'text-slate-700');
                contextButton.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
        }
    };

    // --- UNIFIED COMMAND SYSTEM ---
    let commandSuggestionsVisible = false;
    let selectedSuggestionIndex = -1;
    let commandSuggestionsList = [];

    const showCommandSuggestions = (suggestions) => {
        if (suggestions.length === 0) {
            commandSuggestions.classList.add('hidden');
            commandSuggestionsVisible = false;
            return;
        }

        commandSuggestions.innerHTML = suggestions.map((suggestion, index) => {
            const isTodayTask = suggestion.subtitle && suggestion.subtitle.includes('🌟 Today');
            const isInactive = suggestion.isInactive;
            const bgColor = isTodayTask ? 'bg-amber-50' : 'bg-white';
            const borderColor = isTodayTask ? 'border-amber-200' : 'border-slate-100';
            const selectedBg = index === selectedSuggestionIndex ? (isTodayTask ? 'bg-amber-100' : 'bg-blue-50') : '';
            
            return `
            <div class="command-suggestion px-3 py-2 cursor-pointer hover:${isTodayTask ? 'bg-amber-100' : 'bg-slate-50'} border-b ${borderColor} last:border-b-0 ${selectedBg}" data-index="${index}">
                <div class="flex items-center gap-2">
                    <span class="${isTodayTask ? 'text-amber-500' : 'text-slate-400'}">${suggestion.icon}</span>
                    <div class="flex-1">
                        <div class="text-sm font-medium ${isTodayTask ? 'text-amber-800' : 'text-slate-700'} ${isInactive ? 'opacity-60' : ''}">${suggestion.title}</div>
                        <div class="text-xs ${isTodayTask ? 'text-amber-600' : 'text-slate-500'}">${suggestion.subtitle}</div>
                    </div>
                    ${isInactive ? `
                        <button class="reactivate-task-btn text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded-md transition-colors" 
                                data-task-id="${suggestion.task.id}">
                            Reactivate
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
        }).join('');

        commandSuggestions.classList.remove('hidden');
        commandSuggestionsVisible = true;
        selectedSuggestionIndex = -1;
    };

    const hideCommandSuggestions = () => {
        commandSuggestions.classList.add('hidden');
        commandSuggestionsVisible = false;
        selectedSuggestionIndex = -1;
    };

    const getCommandSuggestions = (query) => {
        if (!query.trim()) return [];

        const normalizedQuery = query.toLowerCase();
        const suggestions = [];
        const today = new Date().toISOString().slice(0, 10);

        // Search existing tasks (include both active and inactive)
        const matchingTasks = tasks.filter(task => 
            task.name.toLowerCase().includes(normalizedQuery) ||
            task.tags?.some(tag => tag.toLowerCase().includes(normalizedQuery))
        );

        // Separate Today tasks from other tasks
        const todayTasks = matchingTasks.filter(task => task.dailyPlanDate === today);
        const otherTasks = matchingTasks.filter(task => task.dailyPlanDate !== today);

        // Add Today tasks first (prioritized)
        todayTasks.slice(0, 2).forEach(task => {
            const timeBracket = task.totalTimeBracket || task.timeBracket || 'Quick';
            const context = task.contexts && task.contexts.length > 0 ? task.contexts[0] : 'Personal';
            const isInactive = task.isActive === false;
            suggestions.push({
                type: 'existing',
                task: task,
                title: task.name,
                subtitle: `🌟 Today • ${timeBracket} • ${context}${isInactive ? ' • ⚠️ Inactive' : ''}`,
                icon: '🌟',
                isInactive: isInactive
            });
        });

        // Add other tasks (limit to 1 if we have Today tasks, 3 if no Today tasks)
        const otherTaskLimit = todayTasks.length > 0 ? 1 : 3;
        otherTasks.slice(0, otherTaskLimit).forEach(task => {
            const isInactive = task.isActive === false;
            suggestions.push({
                type: 'existing',
                task: task,
                title: task.name,
                subtitle: `Existing task • ${task.tags?.length ? task.tags.join(', ') : 'No tags'}${isInactive ? ' • ⚠️ Inactive' : ''}`,
                icon: '🔍',
                isInactive: isInactive
            });
        });

        // Add create new task option
        suggestions.push({
            type: 'create',
            title: `Create "${query}"`,
            subtitle: 'Press Enter to open task creation modal',
            icon: '➕'
        });

        return suggestions;
    };

    // Debounced search function
    const debouncedSearch = (query) => {
        // Clear existing timer
        if (searchDebounceTimer) {
            clearTimeout(searchDebounceTimer);
        }
        
        // Set new timer
        searchDebounceTimer = setTimeout(() => {
            if (query.trim()) {
                const suggestions = getCommandSuggestions(query);
                commandSuggestionsList = suggestions;
                showCommandSuggestions(suggestions);
            } else {
                hideCommandSuggestions();
                // Show all tasks when input is empty
                renderTasksAndProjects('');
            }
        }, 300); // 300ms delay
    };

    const handleCommandInput = (e) => {
        const query = e.target.value;
        debouncedSearch(query);
    };

    const handleCommandKeyDown = (e) => {
        if (!commandSuggestionsVisible) {
            if (e.key === 'Enter' && e.target.value.trim()) {
                // Create new task directly
                handleCreateTask(e.target.value);
                e.target.value = '';
                hideCommandSuggestions();
            }
            return;
        }

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, commandSuggestionsList.length - 1);
                updateSuggestionSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSuggestionSelection();
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedSuggestionIndex >= 0) {
                    executeSuggestion(commandSuggestionsList[selectedSuggestionIndex]);
                } else {
                    // Create new task with current input
                    handleCreateTask(e.target.value);
                }
                e.target.value = '';
                hideCommandSuggestions();
                break;
            case 'Escape':
                hideCommandSuggestions();
                break;
        }
    };

    const updateSuggestionSelection = () => {
        const suggestionElements = commandSuggestions.querySelectorAll('.command-suggestion');
        suggestionElements.forEach((el, index) => {
            if (index === selectedSuggestionIndex) {
                el.classList.add('bg-blue-50');
            } else {
                el.classList.remove('bg-blue-50');
            }
        });
    };

    const executeSuggestion = (suggestion) => {
        if (suggestion.type === 'existing') {
            // Start the existing task
            startTaskFromSidebar(suggestion.task.id);
        } else if (suggestion.type === 'create') {
            // Create new task
            handleCreateTask(unifiedCommandInput.value);
        }
    };

    const handleCreateTask = (input) => {
        if (!input.trim()) return;

        const timeBracketRegex = /@(quick|standard|long)/i;
        const modeRegex = /#(work|personal)/i;
        const tagRegex = /#(?!work|personal)(\w+)/g; // Match #tag but not #work or #personal
        const contextRegex = /@(work|personal)/i;
        const projectRegex = /\^([\w\s]+)/;

        const timeBracketMatch = input.match(timeBracketRegex);
        const modeMatch = input.match(modeRegex);
        const tagsMatch = [...input.matchAll(tagRegex)];
        const contextMatch = input.match(contextRegex);
        const projectMatch = input.match(projectRegex);
        
        // Remove all special syntax from the task name
        let name = input.replace(timeBracketRegex, '').replace(modeRegex, '').replace(tagRegex, '').replace(contextRegex, '').replace(projectRegex, '').trim();

        if (!name) return;
        
        // Open the modal with pre-filled data
        resetModal();
        populateProjectDropdown();
        document.getElementById('taskName').value = name;
        
        // Pre-fill project if specified
        if (projectMatch) {
            const projectName = projectMatch[1].trim();
            let project = projects.find(p => p.name.toLowerCase() === projectName.toLowerCase());
            if (project) {
                document.getElementById('projectSelect').value = project.id;
            }
        }

        // Pre-fill time bracket if specified
        if (timeBracketMatch) {
            const timeBracket = timeBracketMatch[1].charAt(0).toUpperCase() + timeBracketMatch[1].slice(1).toLowerCase();
            modalSelectedTime = timeBracket;
            const btn = document.querySelector(`.modal-time-btn[data-timeBracket="${timeBracket}"]`);
            if(btn) { 
                btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); 
                btn.classList.remove('bg-white', 'text-slate-700'); 
            }
        }
        
        // Pre-fill tags if specified
        if (tagsMatch.length > 0) {
            modalTagList = tagsMatch.map(match => match[1]);
            renderTagPreview();
        }
        
        // Pre-fill contexts if specified
        if (contextMatch) {
            const context = contextMatch[1].charAt(0).toUpperCase() + contextMatch[1].slice(1).toLowerCase();
            modalSelectedContexts = [context];
                const btn = document.querySelector(`.modal-context-btn[data-context="${context}"]`);
            if(btn) { 
                btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); 
                btn.classList.remove('bg-white', 'text-slate-700'); 
            }
        }

        // Handle mode change if specified - also pre-fill context in modal
        if (modeMatch) {
            const mode = modeMatch[1].charAt(0).toUpperCase() + modeMatch[1].slice(1).toLowerCase();
            // Set the mode selection in the main interface
            selectedMode = mode;
            updateModeSelection(`${mode.toLowerCase()}ModeBtn`, mode === 'Work' ? 'personalModeBtn' : 'workModeBtn');
            
            // Also pre-fill the context in the modal
            modalSelectedContexts = [mode];
            const btn = document.querySelector(`.modal-context-btn[data-context="${mode}"]`);
            if(btn) { 
                btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); 
                btn.classList.remove('bg-white', 'text-slate-700'); 
            }
        }

        // Open the modal
        openModal('add');
        hideCommandSuggestions();
    };
      
    const handleAddProject = (e) => {
        if (e.key !== 'Enter' || !e.target.value.trim()) return;
        const projectName = e.target.value.trim();
        if (projectName && !projects.find(p => p.name.toLowerCase() === projectName.toLowerCase())) {
            projects.push({ id: `proj_${Date.now()}`, name: projectName });
            saveDataToFirestore();
        }
        e.target.value = '';
        hideProjectAutocomplete();
    };

    const showProjectAutocomplete = (inputValue) => {
        const autocomplete = document.getElementById('projectAutocomplete');
        if (!inputValue.trim()) {
            hideProjectAutocomplete();
            return;
        }

        const matchingProjects = projects.filter(project => 
            project.name.toLowerCase().includes(inputValue.toLowerCase()) && 
            project.name.toLowerCase() !== inputValue.toLowerCase()
        );

        if (matchingProjects.length === 0) {
            hideProjectAutocomplete();
            return;
        }

        autocomplete.innerHTML = matchingProjects.map(project => `
            <div class="px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-b-0" 
                 onclick="selectProjectSuggestion('${project.name}')">
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-slate-400 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <span class="font-medium">${project.name}</span>
                    <span class="ml-auto text-xs text-slate-400">Already exists</span>
                </div>
            </div>
        `).join('');

        autocomplete.classList.remove('hidden');
    };

    const hideProjectAutocomplete = () => {
        const autocomplete = document.getElementById('projectAutocomplete');
        autocomplete.classList.add('hidden');
    };

    const selectProjectSuggestion = (projectName) => {
        const input = document.getElementById('newProjectInput');
        input.value = projectName;
        input.focus();
        hideProjectAutocomplete();
    };

    // updateProjectCount function removed - replaced with Manage Projects button
      
    const initializeStreak = () => {
        const today = new Date();
        const todayStr = today.toISOString().slice(0, 10);
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().slice(0, 10);

        if (streakData.lastCompletedDate && streakData.lastCompletedDate !== todayStr && streakData.lastCompletedDate !== yesterdayStr) {
            streakData.currentStreak = 0;
            streakData.lastCompletedDate = null;
            saveDataToFirestore(); 
        }

    };

    const updateTaskTypeButtons = () => {
        const atomicTaskBtn = document.getElementById('atomicTaskBtn');
        const progressTaskBtn = document.getElementById('progressTaskBtn');
        const taskDivisible = document.getElementById('taskDivisible');
        
        if (!atomicTaskBtn || !progressTaskBtn || !taskDivisible) {
            return;
        }
        
        const isDivisible = taskDivisible.checked;
        
        if (isDivisible) {
            // Progress selected
            atomicTaskBtn.className = 'px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-slate-600 hover:text-slate-700 border border-slate-200 hover:bg-slate-50';
            progressTaskBtn.className = 'px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 bg-blue-100 text-blue-700 shadow-sm border border-blue-300 hover:shadow-md';
        } else {
            // Atomic selected
            atomicTaskBtn.className = 'px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 bg-blue-100 text-blue-700 shadow-sm border border-blue-300 hover:shadow-md';
            progressTaskBtn.className = 'px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-slate-600 hover:text-slate-700 border border-slate-200 hover:bg-slate-50';
        }
    };

    const toggleTimeSections = () => {
        const taskDivisible = document.getElementById('taskDivisible');
        const atomicSection = document.getElementById('atomicTimeSection');
        const progressSection = document.getElementById('progressTimeSection');
        
        if (!taskDivisible || !atomicSection || !progressSection) {
            return;
        }
        
        const isDivisible = taskDivisible.checked;
        
        if (isDivisible) {
            atomicSection.classList.add('hidden');
            progressSection.classList.remove('hidden');
        } else {
            atomicSection.classList.remove('hidden');
            progressSection.classList.add('hidden');
        }
    };

    const renderFilterButtons = () => {
        // renderFilterButtons called
        const timeOptions = [5, 10, 15, 20, 25, 30, 45, 60];
        const timeBrackets = ['Quick', 'Standard', 'Long'];
        const contextOptions = ['Work', 'Personal']; // Simplified contexts
        const energyOptions = ['Low 🧠', 'Medium 💪', 'High 🔥'];

        const createButtons = (opts, containerId, className, dataAttr) => {
            const container = document.getElementById(containerId);
            if (container) {
                console.log(`🔧 Creating buttons for ${containerId}:`, opts);
                console.log(`🔧 Data attribute: ${dataAttr}`);
                console.log(`🔧 Class name: ${className}`);
                
                const buttonHtml = opts.map(opt => {
                    const displayText = dataAttr === 'time' ? `${opt} min` : opt;
                    // Use different styling for modal buttons vs filter buttons
                    const isModalButton = containerId.includes('modal');
                    const buttonClass = isModalButton 
                        ? `${className} bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 px-3 py-2 rounded-lg text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1`
                        : `${className} bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-1.5 rounded-lg transition-colors text-xs font-medium focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500`;
                    // Use proper camelCase for data attributes
                    const dataAttrCamel = dataAttr === 'timeBracket' ? 'timeBracket' : dataAttr;
                    
                    // Add tooltip for time bracket buttons in modal
                    let tooltip = '';
                    if (isModalButton && dataAttr === 'timeBracket') {
                        const tooltips = {
                            'Quick': '1-15 minutes - Small tasks like checking email or quick calls',
                            'Standard': '15-45 minutes - Regular tasks like writing or research',
                            'Long': '45-90 minutes - Complex tasks requiring deep focus'
                        };
                        tooltip = `title="${tooltips[opt] || ''}"`;
                    }
                    
                    return `<button data-${dataAttrCamel}="${opt}" class="${buttonClass}" ${tooltip}>${displayText}</button>`;
                }).join('');
                
                container.innerHTML = buttonHtml;
                console.log(`🔧 Buttons created for ${containerId}, container:`, container);
                console.log(`🔧 Button HTML:`, buttonHtml);
                
                // Verify buttons were created
                const createdButtons = container.querySelectorAll(`[data-${dataAttr}]`);
                console.log(`🔧 Created ${createdButtons.length} buttons with data-${dataAttr}`);
                createdButtons.forEach((btn, i) => {
                    console.log(`🔧 Button ${i}:`, btn.dataset, btn.className);
                });
            } else {
                console.error(`❌ Container not found: ${containerId}`);
            }
        };
        
        // Main time filters (keep as minutes for user selection)
        createButtons(timeOptions, 'timeFilters', 'time-filter', 'time');
        
        // Advanced filters (energy, projects, and tags)
        createButtons(energyOptions, 'energyFilters', 'energy-filter', 'energy');
        renderProjectFilters();
        renderTagCloud();
        
        // Modal time bracket buttons
        // Creating modal buttons
        createButtons(timeBrackets, 'modalTimeButtons', 'modal-time-btn', 'timeBracket');
        createButtons(timeBrackets, 'modalSessionTimeButtons', 'modal-session-time-btn', 'timeBracket');
        createButtons(contextOptions, 'modalContextButtons', 'modal-context-btn', 'context');
        createButtons(energyOptions, 'modalEnergyButtons', 'modal-energy-btn', 'energy');
        // Modal buttons creation complete
    };
      
    const initializeEventListeners = () => {
        console.log('🔧 initializeEventListeners called');
        console.log('🔧 About to set up modal button handlers...');
        // --- Mobile Menu Toggle ---

        
        menuBtn.addEventListener('click', () => {
            sidebar.classList.remove('hidden');
            sidebar.classList.add('flex');
        });
        closeMenuBtn.addEventListener('click', () => {
            sidebar.classList.add('hidden');
            sidebar.classList.remove('flex');
        });

        // Settings button event listeners
        document.getElementById('settingsBtn').addEventListener('click', showSettingsModal);
        document.getElementById('desktopSettingsBtn').addEventListener('click', showSettingsModal);
        document.getElementById('closeSettingsBtn').addEventListener('click', closeSettingsModal);
        document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
        document.getElementById('resetSettingsBtn').addEventListener('click', resetSettings);
        
        // Debug: Check if elements exist
        console.log('🔍 Checking login elements...');
        console.log('googleLoginBtn:', document.getElementById('googleLoginBtn'));
        console.log('signInBtn:', document.getElementById('signInBtn'));
        console.log('signUpBtn:', document.getElementById('signUpBtn'));
        console.log('guestLoginBtn:', document.getElementById('guestLoginBtn'));
        
        try {
            // Test basic click functionality first
            const guestBtn = document.getElementById('guestLoginBtn');
            if (guestBtn) {
                guestBtn.addEventListener('click', () => {
                    console.log('🎭 Guest button clicked via addEventListener!');
                });
            }
        
        document.getElementById('googleLoginBtn').onclick = handleGoogleLogin;
        document.getElementById('signInBtn').onclick = handleEmailSignIn;
        document.getElementById('signUpBtn').onclick = handleEmailSignUp;
            document.getElementById('guestLoginBtn').onclick = showGuestMode;
            

            console.log('✅ Login button handlers set up successfully');
        } catch (error) {
            console.error('❌ Error setting up login button handlers:', error);
        }
        
        // Handle Enter key in email/password inputs
        document.getElementById('emailInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleEmailSignIn();
            }
        });
        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleEmailSignIn();
            }
        });
        const addTaskBtn = document.getElementById('addTaskBtn');
        if (addTaskBtn) {
            addTaskBtn.onclick = () => openModal('add');
        }
        // Context mode selection
        const workModeBtn = document.getElementById('workModeBtn');
        const personalModeBtn = document.getElementById('personalModeBtn');
        console.log('🔧 Work mode button:', workModeBtn);
        console.log('🔧 Personal mode button:', personalModeBtn);
        
        if (workModeBtn) {
            workModeBtn.onclick = () => {
                console.log('🔧 Work mode clicked');
            selectedMode = 'Work';
            updateModeSelection('workModeBtn', 'personalModeBtn');
                
                // Auto-collapse Task Review section when mode is selected
                taskReviewCollapsed = true;
                renderCompletedTasks();
                renderWeeklyReview();
                
                // Only update suggestions if we have both mode and time filter
                if (selectedTimeFilter) {
                    updateTaskSuggestionsForMode();
                }
            };
        } else {
            console.error('❌ Work mode button not found');
        }
        
        if (personalModeBtn) {
            personalModeBtn.onclick = () => {
                console.log('🔧 Personal mode clicked');
            selectedMode = 'Personal';
            updateModeSelection('personalModeBtn', 'workModeBtn');
                
                // Auto-collapse Task Review section when mode is selected
                taskReviewCollapsed = true;
                renderCompletedTasks();
                renderWeeklyReview();
                
                // Only update suggestions if we have both mode and time filter
                if (selectedTimeFilter) {
                    updateTaskSuggestionsForMode();
                }
            };
        } else {
            console.error('❌ Personal mode button not found');
        }
        
        // Reshuffle button
        document.getElementById('reshuffleBtn').onclick = () => {
            generateTaskSuggestions();
        };
        
        // Toggle advanced filters
        document.getElementById('toggleAdvancedFilters').onclick = () => {
            const advancedFilters = document.getElementById('advancedFilters');
            const icon = document.getElementById('advancedFiltersIcon');
            if (advancedFilters.classList.contains('hidden')) {
                advancedFilters.classList.remove('hidden');
                icon.textContent = '▲';
                advancedFiltersOpen = true;
            } else {
                advancedFilters.classList.add('hidden');
                icon.textContent = '▼';
                advancedFiltersOpen = false;
            }
        };

        // Toggle advanced task options
        document.getElementById('toggleAdvancedTaskOptions').onclick = () => {
            const advancedTaskOptions = document.getElementById('advancedTaskOptions');
            const icon = document.getElementById('advancedTaskOptionsIcon');
            if (advancedTaskOptions.classList.contains('hidden')) {
                advancedTaskOptions.classList.remove('hidden');
                icon.textContent = '▲';
            } else {
                advancedTaskOptions.classList.add('hidden');
                icon.textContent = '▼';
            }
        };
        document.getElementById('clearFiltersBtn').onclick = () => {
            clearAllFilters();
        };
        
        // Priority Only filter toggle
        document.getElementById('priorityOnlyToggle').addEventListener('change', (e) => {
            filterByPriorityOnly = e.target.checked;
            generateTaskSuggestions();
        });
        document.getElementById('cancelTaskBtn').onclick = closeModal;
        

        const closeModalBtn = document.getElementById('closeModalBtn');
        if (closeModalBtn) {
            closeModalBtn.onclick = closeModal;
        }
        document.getElementById('saveTaskBtn').onclick = saveTask;
        document.getElementById('taskTags').addEventListener('keypress', e => {
          if (e.key === 'Enter' && e.target.value.trim()) {
            e.preventDefault();
            if (!modalTagList.includes(e.target.value.trim())) modalTagList.push(e.target.value.trim());
            e.target.value = '';
            renderTagPreview();
          }
        });
        
        // New project creation event listeners
        document.getElementById('projectSelect').addEventListener('change', (e) => {
            if (e.target.value === 'new-project') {
                showNewProjectInput();
            }
        });
        
        document.getElementById('createProjectBtn').onclick = createNewProject;
        document.getElementById('cancelNewProjectBtn').onclick = hideNewProjectInput;
        
        // Allow Enter key to create project
        document.getElementById('newProjectNameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                createNewProject();
            }
        });
        
        // Custom time input event listeners removed - using time brackets now

        // Add event listener for divisibility checkbox (if it exists)
        const taskDivisible = document.getElementById('taskDivisible');
        if (taskDivisible) {
            taskDivisible.addEventListener('change', toggleTimeSections);
        }
        
        // Add event listeners for task type buttons
        const atomicTaskBtn = document.getElementById('atomicTaskBtn');
        const progressTaskBtn = document.getElementById('progressTaskBtn');
        
        if (atomicTaskBtn && progressTaskBtn) {
            atomicTaskBtn.addEventListener('click', () => {
                taskDivisible.checked = false;
                updateTaskTypeButtons();
                toggleTimeSections();
            });
            
            progressTaskBtn.addEventListener('click', () => {
                taskDivisible.checked = true;
                updateTaskTypeButtons();
                toggleTimeSections();
            });
        }

        // Unified command input
        unifiedCommandInput.addEventListener('input', handleCommandInput);
        unifiedCommandInput.addEventListener('keydown', handleCommandKeyDown);
        unifiedCommandInput.addEventListener('blur', () => {
            // Delay hiding to allow clicking on suggestions
            setTimeout(hideCommandSuggestions, 150);
        });
        
        // Command suggestions click handler
        commandSuggestions.addEventListener('click', (e) => {
            // Handle reactivate button clicks
            if (e.target.classList.contains('reactivate-task-btn')) {
                e.stopPropagation();
                const taskId = e.target.dataset.taskId;
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    task.isActive = true;
                    saveDataToFirestore();
                    renderTasksAndProjects();
                    hideCommandSuggestions();
                }
                return;
            }
            
            const suggestion = e.target.closest('.command-suggestion');
            if (suggestion) {
                const index = parseInt(suggestion.dataset.index);
                executeSuggestion(commandSuggestionsList[index]);
                unifiedCommandInput.value = '';
                hideCommandSuggestions();
            }
        });
        
        document.getElementById('newProjectInput').addEventListener('keypress', handleAddProject);
        document.getElementById('newProjectInput').addEventListener('input', (e) => showProjectAutocomplete(e.target.value));
        document.getElementById('newProjectInput').addEventListener('focus', (e) => showProjectAutocomplete(e.target.value));
        document.getElementById('newProjectInput').addEventListener('blur', () => {
            // Delay hiding to allow clicking on suggestions
            setTimeout(hideProjectAutocomplete, 150);
        });
        
        // --- Stats Modal Listeners ---
        document.getElementById('closeStatsBtn').onclick = closeStatsModal;

        // Sign up/Sign in modal event listeners
        document.getElementById('closeSignUpModalBtn').onclick = closeSignUpModal;
        document.getElementById('closeSignInModalBtn').onclick = closeSignInModal;
        document.getElementById('signUpModalBtn').onclick = handleSignUpModal;
        document.getElementById('signInModalBtn').onclick = handleSignInModal;
        document.getElementById('signUpGoogleLoginBtn').onclick = handleSignUpGoogleModal;
        document.getElementById('signInGoogleLoginBtn').onclick = handleSignInGoogleModal;
        
        // Project management modal event listeners
        document.getElementById('manageProjectsBtn').onclick = showProjectManagementModal;
        document.getElementById('closeProjectManagementModalBtn').onclick = closeProjectManagementModal;
        document.getElementById('closeProjectManagementModalBtn2').onclick = closeProjectManagementModal;
        document.getElementById('deleteEmptyProjectsBtn').onclick = deleteEmptyProjects;
        document.getElementById('collapseAllProjectsBtn').onclick = collapseAllProjects;
        document.getElementById('showLoginModalBtn').onclick = () => {
            closeSignUpModal();
            showSignInModal();
        };
        document.getElementById('showSignUpModalBtn').onclick = () => {
            closeSignInModal();
            showSignUpModal();
        };
        
        // --- Project Delete Modal Listeners ---
        document.getElementById('cancelProjectDeleteBtn').onclick = closeProjectDeleteModal;
        document.getElementById('confirmProjectDeleteBtn').onclick = executeProjectDelete;
        
        // --- Stop Focus Session Modal Listeners ---
        document.getElementById('cancelStopFocusBtn').onclick = closeStopFocusModal;
        document.getElementById('confirmStopFocusBtn').onclick = executeStopFocusSession;
        
        // --- Start Task Modal Listeners ---
        document.getElementById('cancelStartTaskBtn').onclick = closeStartTaskModal;
        document.getElementById('confirmStartTaskBtn').onclick = () => {
            const taskId = startTaskModalOverlay.dataset.taskId;
            if (taskId) {
                startFocusSession(taskId); // No session length for sidebar tasks
                closeStartTaskModal();
            }
        };
        
        // --- Complete Task Modal Listeners ---
        document.getElementById('cancelCompleteTaskBtn').onclick = closeCompleteTaskModal;
        document.getElementById('confirmCompleteTaskBtn').onclick = () => {
            completeTask();
            closeCompleteTaskModal();
        };
        


        const handleFilterClick = (containerId, selector, stateVarSetter, allowToggle = false) => {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`❌ Filter container not found: ${containerId}`);
                return;
            }
            console.log(`🔧 Setting up filter handler for ${containerId}`);
            container.addEventListener('click', e => {
                if (e.target.matches(selector)) {
                    if (allowToggle) {
                        // For context filters - allow toggle (multi-select)
                     e.target.classList.toggle('bg-blue-500');
                     e.target.classList.toggle('text-white');
                     e.target.classList.toggle('border-blue-500');
                     e.target.classList.toggle('bg-slate-100');
                     e.target.classList.toggle('text-slate-600');
                    } else {
                        // For time and energy filters - radio button behavior (single select)
                        document.querySelectorAll(selector).forEach(b => {
                            b.classList.remove('bg-blue-500','text-white','border-blue-500');
                            b.classList.add('bg-slate-100','text-slate-600');
                        });
                        e.target.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                        e.target.classList.remove('bg-slate-100', 'text-slate-600');
                    }
                    stateVarSetter(e.target);
                }
            });
        };
        console.log('🔧 Setting up time filters...');
        handleFilterClick('timeFilters', '.time-filter', (el) => {
            const timeValue = parseInt(el.dataset.time);
            selectedTimeFilter = timeValue;
            console.log('🔧 Time filter clicked, selectedTimeFilter set to:', selectedTimeFilter);
            currentSuggestions = []; // Clear current suggestions when time changes
            
            // Auto-collapse Task Review section when time filter is selected
            taskReviewCollapsed = true;
            renderCompletedTasks();
            renderWeeklyReview();
            
            generateTaskSuggestions();
            // Clear custom input when button is clicked and reset visual indicator
            const customTimeInput = document.getElementById('customTimeFilterInput');
            if (customTimeInput) {
            customTimeInput.value = '';
            customTimeInput.classList.remove('bg-blue-50', 'border-blue-500', 'ring-2', 'ring-blue-200');
            customTimeInput.classList.add('border-slate-300');
            }
        }); // Single-select behavior (radio button style)
        console.log('🔧 Setting up energy filters...');
        handleFilterClick('energyFilters', '.energy-filter', (el) => {
            const energy = el.dataset.energy;
            if (selectedEnergyFilters.length > 0 && selectedEnergyFilters[0] === energy) {
                // If clicking the same energy button, deselect it
                selectedEnergyFilters = [];
                // Manually update the visual styling to show deselected state
                el.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                el.classList.add('bg-slate-100', 'text-slate-600');
            } else {
                // Select the new energy (single selection)
                selectedEnergyFilters = [energy];
            }
            currentSuggestions = []; // Clear current suggestions when energy changes
            generateTaskSuggestions();
        }); // Single-select with toggle behavior
        console.log('🔧 Setting up project filters...');
        handleFilterClick('projectFilters', '.project-filter', (el) => {
            const project = el.dataset.project;
            const index = selectedProjectFilters.indexOf(project);
            if (index > -1) {
                selectedProjectFilters.splice(index, 1);
            } else {
                selectedProjectFilters.push(project);
            }
            currentSuggestions = []; // Clear current suggestions when project changes
            generateTaskSuggestions();
        }, true); // Enable toggle behavior for multi-select
        
        // Custom time filter input
        const customTimeFilterInput = document.getElementById('customTimeFilterInput');
        if (customTimeFilterInput) {
            customTimeFilterInput.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            if (value && value > 0) {
                // Clear other time filter selections
                document.querySelectorAll('.time-filter').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                    btn.classList.add('bg-slate-100', 'text-slate-600');
                });
                selectedTimeFilter = value;
                currentSuggestions = []; // Clear current suggestions when custom time changes
                
                // Auto-collapse Task Review section when custom time is entered
                taskReviewCollapsed = true;
                renderCompletedTasks();
                renderWeeklyReview();
                
                // Add visual indicator for custom time selection
                e.target.classList.add('bg-blue-50', 'border-blue-500', 'ring-2', 'ring-blue-200');
                e.target.classList.remove('border-slate-300');
                
                generateTaskSuggestions();
            } else if (!value) {
                selectedTimeFilter = null;
                
                // Remove visual indicator
                e.target.classList.remove('bg-blue-50', 'border-blue-500', 'ring-2', 'ring-blue-200');
                e.target.classList.add('border-slate-300');
                
                document.getElementById('taskSuggestionsSection').classList.add('hidden');
            }
        });
        
        // Add focus event listener to deselect time buttons when custom input is focused
        customTimeFilterInput.addEventListener('focus', (e) => {
            // Clear other time filter selections when user focuses on custom input
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-slate-100', 'text-slate-600');
            });
        });
        } else {
            console.error('❌ Custom time filter input not found');
        }
        
        handleFilterClick('contextFilters', '.context-filter', (el) => {
            const context = el.dataset.context;
            const index = selectedContextFilters.indexOf(context);
                if (index > -1) {
                    selectedContextFilters.splice(index, 1);
                } else {
                    selectedContextFilters.push(context);
                }
        }, true); // Allow toggle for context filters

        const handleModalButtonClick = (containerId, selector, stateVarSetter, isMultiSelect = false) => {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`❌ Modal button container not found: ${containerId}`);
                return;
            }
            console.log(`🔧 Setting up modal button handler for ${containerId}`);
            console.log(`🔧 Container found:`, container);
            console.log(`🔧 Selector: ${selector}`);
            
            // Check if buttons exist at setup time
            const existingButtons = container.querySelectorAll(selector);
            console.log(`🔧 Existing buttons at setup time:`, existingButtons.length, existingButtons);
            
            container.addEventListener('click', e => {
                console.log(`🔧 Modal button clicked in ${containerId}:`, e.target);
                console.log(`🔧 Clicked element classes:`, e.target.className);
                console.log(`🔧 Clicked element dataset:`, e.target.dataset);
                console.log(`🔧 Matches selector "${selector}":`, e.target.matches(selector));
                
                if (e.target.matches(selector)) {
                    console.log(`🔧 Button matches selector, processing click`);
                    // Handle time bracket buttons differently
                    let value;
                    console.log(`🔧 Dataset keys:`, Object.keys(e.target.dataset));
                    console.log(`🔧 timebracket:`, e.target.dataset.timebracket);
                    console.log(`🔧 time:`, e.target.dataset.time);
                    
                    if (selector.includes('time') && e.target.dataset.timebracket) {
                        value = e.target.dataset.timebracket;
                        console.log(`🔧 Using timebracket value:`, value);
                    } else if (selector.includes('time') && e.target.dataset.time) {
                        value = parseInt(e.target.dataset.time);
                        console.log(`🔧 Using time value:`, value);
                    } else if (e.target.dataset.context) {
                        value = e.target.dataset.context;
                        console.log(`🔧 Using context value:`, value);
                    } else if (e.target.dataset.energy) {
                        value = e.target.dataset.energy;
                        console.log(`🔧 Using energy value:`, value);
                    } else {
                        console.log(`🔧 No matching dataset found!`);
                        return;
                    }
                    
                    if (isMultiSelect) {
                        const stateArray = stateVarSetter();
                        const index = stateArray.indexOf(value);
                        if (index > -1) {
                            stateArray.splice(index, 1);
                            e.target.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                            e.target.classList.add('bg-white','text-slate-700');
                        } else {
                            stateArray.push(value);
                            e.target.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                            e.target.classList.remove('bg-white','text-slate-700');
                        }
                    } else {
                        stateVarSetter(value);
                        // Handle different button styles for modal vs filter buttons
                        const isModalButton = containerId.includes('modal');
                        if (isModalButton) {
                            document.querySelectorAll(selector).forEach(b => {
                                b.classList.remove('bg-blue-500','text-white','border-blue-500');
                                b.classList.add('bg-white','text-slate-700','border-slate-200');
                            });
                        e.target.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                            e.target.classList.remove('bg-white','text-slate-700','border-slate-200');
                        } else {
                            document.querySelectorAll(selector).forEach(b => {
                                b.classList.remove('bg-blue-500','text-white','border-blue-500');
                                b.classList.add('bg-slate-100','text-slate-600');
                            });
                            e.target.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                            e.target.classList.remove('bg-slate-100','text-slate-600');
                        }
                    }
                    console.log(`🔧 Button click processed successfully`);
                } else {
                    console.log(`🔧 Clicked element does not match selector`);
                }
            });
        };
        
        // Setting up modal button handlers
        
        handleModalButtonClick('modalTimeButtons', '.modal-time-btn', (val) => {
            console.log('🔧 Time button clicked, value:', val);
            modalSelectedTime = val;
            console.log('🔧 modalSelectedTime set to:', modalSelectedTime);
        });
        handleModalButtonClick('modalSessionTimeButtons', '.modal-session-time-btn', (val) => {
            console.log('🔧 Session time button clicked, value:', val);
            modalSelectedMinSessionTime = val;
            console.log('🔧 modalSelectedMinSessionTime set to:', modalSelectedMinSessionTime);
        });
        // Custom handler for energy buttons to make them toggleable
        document.addEventListener('click', (e) => {
            if (e.target.matches('.modal-energy-btn')) {
                const value = e.target.dataset.energy;
                
                if (modalSelectedEnergy === value) {
                    // If clicking the same energy button, deselect it
                    modalSelectedEnergy = null;
                    e.target.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                    e.target.classList.add('bg-white', 'text-slate-700', 'border-slate-200');
                } else {
                    // Select the new energy
                    modalSelectedEnergy = value;
                    document.querySelectorAll('.modal-energy-btn').forEach(b => {
                    b.classList.remove('bg-blue-500','text-white','border-blue-500');
                        b.classList.add('bg-white','text-slate-700','border-slate-200');
                });
                e.target.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                    e.target.classList.remove('bg-white','text-slate-700','border-slate-200');
                }
            }
        });
        // Custom handler for context buttons to make them multi-select
        document.addEventListener('click', (e) => {
            if (e.target.matches('.modal-context-btn')) {
                const value = e.target.dataset.context;
                console.log('🔧 Context button clicked, value:', value);
                console.log('🔧 Current contexts before:', modalSelectedContexts);
                
                const index = modalSelectedContexts.indexOf(value);
                if (index > -1) {
                    // Remove if already selected
                    modalSelectedContexts.splice(index, 1);
                    e.target.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                    e.target.classList.add('bg-white', 'text-slate-700', 'border-slate-200');
                } else {
                    // Add if not selected
                    modalSelectedContexts.push(value);
                    e.target.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                    e.target.classList.remove('bg-white', 'text-slate-700', 'border-slate-200');
                }
                console.log('🔧 Current contexts after:', modalSelectedContexts);
            }
        });
        
        // Custom time input handlers removed - using time brackets only
        
        // Custom time input handlers removed - using time brackets only

        focusPauseBtn.onclick = () => {
          isPaused = !isPaused;
          document.getElementById('focusPauseText').textContent = isPaused ? 'Resume' : 'Pause';
          document.getElementById('pauseIcon').classList.toggle('hidden');
          document.getElementById('playIcon').classList.toggle('hidden');
          
          // Update worklog status
          if (currentWorklogId) {
            if (isPaused) {
              pauseWorklog(currentWorklogId);
            } else {
              resumeWorklog(currentWorklogId);
            }
          }
          
          // Update localStorage with pause state
          if (currentFocusTaskId && currentWorklogId) {
            const sessionData = {
              taskId: currentFocusTaskId,
              worklogId: currentWorklogId,
              startTime: startTime,
              sessionDuration: sessionLength || 25,
              elapsedTime: elapsedSeconds * 1000,
              pausedTime: pausedTime,
              isPaused: isPaused
            };
            saveFocusSessionToStorage(sessionData);
          }
        };
        focusStopBtn.onclick = () => stopFocusSession();
        focusCompleteBtn.onclick = () => showCompleteTaskModal();
        focusSaveProgressBtn.onclick = () => saveProgress();

        // --- UX Improvement: Add listeners for closing modals ---
        modalOverlay.addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') closeModal();
        });
        statsModalOverlay.addEventListener('click', (e) => {
            if (e.target.id === 'statsModalOverlay') closeStatsModal();
        });
        projectDeleteModalOverlay.addEventListener('click', (e) => {
            if (e.target.id === 'projectDeleteModalOverlay') closeProjectDeleteModal();
        });
        stopFocusModalOverlay.addEventListener('click', (e) => {
            if (e.target.id === 'stopFocusModalOverlay') closeStopFocusModal();
        });
        startTaskModalOverlay.addEventListener('click', (e) => {
            if (e.target.id === 'startTaskModalOverlay') closeStartTaskModal();
        });
        completeTaskModalOverlay.addEventListener('click', (e) => {
            if (e.target.id === 'completeTaskModalOverlay') closeCompleteTaskModal();
        });
        document.getElementById('signUpModalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'signUpModalOverlay') closeSignUpModal();
        });
        document.getElementById('signInModalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'signInModalOverlay') closeSignInModal();
        });
        document.getElementById('projectManagementModalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'projectManagementModalOverlay') closeProjectManagementModal();
        });
        
        // Tag Manager event listeners
        document.getElementById('editTagsBtn').onclick = showTagManagerModal;
        
        document.getElementById('closeTagManagerBtn').onclick = closeTagManagerModal;
        document.getElementById('closeTagManagerBtn2').onclick = closeTagManagerModal;
        document.getElementById('addTagBtn').onclick = addNewTag;
        document.getElementById('newTagInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewTag();
            }
        });
        document.getElementById('tagManagerModalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'tagManagerModalOverlay') closeTagManagerModal();
        });
        
        // Inactive Tasks Modal event listeners
        document.addEventListener('click', (e) => {
            if (e.target.id === 'reviewInactiveBtn') {
                showInactiveTasksModal();
            }
            if (e.target.id === 'closeInactiveTasksModalBtn') {
                closeInactiveTasksModal();
            }
            if (e.target.classList.contains('reactivate-task-btn')) {
                const taskId = e.target.dataset.taskId;
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    task.isActive = true;
                    saveDataToFirestore();
                    renderTasksAndProjects();
                    renderWeeklyReview();
                    showInactiveTasksModal(); // Refresh the modal
                }
            }
        });
        
        inactiveTasksModalOverlay.addEventListener('click', (e) => {
            if (e.target.id === 'inactiveTasksModalOverlay') closeInactiveTasksModal();
        });

        // Settings Modal event listeners
        document.getElementById('settingsModalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'settingsModalOverlay') closeSettingsModal();
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Check for open modals using aria-hidden attribute
                if (document.getElementById('signUpModalOverlay').getAttribute('aria-hidden') === 'false') closeSignUpModal();
                else if (document.getElementById('signInModalOverlay').getAttribute('aria-hidden') === 'false') closeSignInModal();
                else if (document.getElementById('projectManagementModalOverlay').getAttribute('aria-hidden') === 'false') closeProjectManagementModal();
                else if (document.getElementById('tagManagerModalOverlay').getAttribute('aria-hidden') === 'false') closeTagManagerModal();
                else if (inactiveTasksModalOverlay.getAttribute('aria-hidden') === 'false') closeInactiveTasksModal();
                else if (stopFocusModalOverlay.getAttribute('aria-hidden') === 'false') closeStopFocusModal();
                else if (startTaskModalOverlay.getAttribute('aria-hidden') === 'false') closeStartTaskModal();
                else if (completeTaskModalOverlay.getAttribute('aria-hidden') === 'false') closeCompleteTaskModal();
                else if (projectDeleteModalOverlay.getAttribute('aria-hidden') === 'false') closeProjectDeleteModal();
                else if (statsModalOverlay.getAttribute('aria-hidden') === 'false') closeStatsModal();
                else if (modalOverlay.getAttribute('aria-hidden') === 'false') closeModal();
                else if (document.getElementById('dailyPlannerModalOverlay').getAttribute('aria-hidden') === 'false') {
                    document.body.classList.remove('overflow-hidden');
                    hideModal(document.getElementById('dailyPlannerModalOverlay'));
                }
                else if (document.getElementById('settingsModalOverlay').getAttribute('aria-hidden') === 'false') closeSettingsModal();
                else if (sidebar.classList.contains('flex') && window.innerWidth < 768) closeMenuBtn.click();
            }
        });

        // Event Delegation for dynamic buttons
        document.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-btn');
            if (editButton) editTask(editButton.dataset.taskId);

            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) deleteTask(deleteButton.dataset.taskId);
            
            // Tag Manager event delegation
            const editTagButton = e.target.closest('[data-action="edit-tag"]');
            if (editTagButton) {
                const tagName = editTagButton.dataset.tagName;
                startInlineEdit(tagName, editTagButton);
            }
            
            const deleteTagButton = e.target.closest('[data-action="delete-tag"]');
            if (deleteTagButton) {
                const tagName = deleteTagButton.dataset.tagName;
                deleteTag(tagName);
            }

            const startButton = e.target.closest('.start-btn');
            if (startButton) {
                // Get the current value of selectedTimeFilter at click time
                const currentTimeFilter = selectedTimeFilter;
                console.log('🔧 Start button clicked, selectedTimeFilter:', currentTimeFilter);
                startFocusSession(startButton.dataset.taskId, currentTimeFilter);
            }
            
            const startTaskButton = e.target.closest('.start-task-btn');
            if (startTaskButton) startFocusSession(startTaskButton.dataset.taskId);

            // Task title click handler for starting tasks
            const taskTitle = e.target.closest('.task-name');
            if (taskTitle && !e.target.closest('.edit-btn') && !e.target.closest('.delete-btn') && !e.target.closest('.quick-complete-btn') && !e.target.closest('.priority-toggle-btn')) {
                showStartTaskModal(taskTitle.dataset.taskId); // No session length for sidebar tasks
            }

            const removeTagButton = e.target.closest('.remove-tag-btn');
            if (removeTagButton) removeTag(parseInt(removeTagButton.dataset.tagIndex));
            
            const quickCompleteButton = e.target.closest('.quick-complete-btn');
            if (quickCompleteButton) markTaskDone(quickCompleteButton.dataset.taskId);
            
            const priorityToggleButton = e.target.closest('.priority-toggle-btn');
            if (priorityToggleButton) {
                const taskId = priorityToggleButton.dataset.taskId;
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    task.isPriority = !task.isPriority;
                    saveDataToFirestore();
                    renderTasksAndProjects();
                }
            }
            
            
            // Filter button handling is now done by handleFilterClick function above
            
            const tagFilter = e.target.closest('.tag-filter');
            if (tagFilter) {
                const tag = tagFilter.dataset.tag;
                const index = selectedTagFilters.indexOf(tag);
                if (index > -1) {
                    selectedTagFilters.splice(index, 1);
                    tagFilter.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                    tagFilter.classList.add('bg-slate-100', 'text-slate-600');
                } else {
                    selectedTagFilters.push(tag);
                    tagFilter.classList.remove('bg-slate-100', 'text-slate-600');
                    tagFilter.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                }
                generateTaskSuggestions();
            }
            
            // Handle delete project button
            const deleteProjectBtn = e.target.closest('[data-action="delete-project"]');
            if (deleteProjectBtn) {
                e.stopPropagation(); // Prevent triggering collapse/expand
                deleteProject(deleteProjectBtn.dataset.projectId);
                return;
            }
            
            // Handle edit project button
            const editProjectBtn = e.target.closest('[data-action="edit-project"]');
            if (editProjectBtn) {
                e.stopPropagation(); // Prevent triggering collapse/expand
                editProject(editProjectBtn.dataset.projectId);
                return;
            }
            
            // Handle task review section toggle
            if (e.target.closest('#taskReviewHeader')) {
                console.log('Task review section clicked, current state:', taskReviewCollapsed);
                taskReviewCollapsed = !taskReviewCollapsed;
                console.log('New state:', taskReviewCollapsed);
                renderCompletedTasks();
                renderWeeklyReview();
                return;
            }
            
            // Handle project collapse/expand
            const projectHeader = e.target.closest('[data-project-id]');
            if (projectHeader) {
                const projectId = projectHeader.dataset.projectId;
                const projectContent = document.querySelector(`.project-content[data-project-id="${projectId}"]`);
                const collapseIcon = projectHeader.querySelector('.collapse-icon');
                
                console.log('Project header clicked:', projectId);
                console.log('Current collapsed state:', collapsedProjects.has(projectId));
                console.log('Project content:', projectContent);
                console.log('Collapse icon:', collapseIcon);
                
                // Check if elements exist before manipulating them
                if (!projectContent || !collapseIcon) {
                    console.log('Missing elements for project collapse:', { projectContent, collapseIcon });
                    return;
                }
                
                // Toggle the collapsed state
                const isCurrentlyCollapsed = collapsedProjects.has(projectId);
                console.log('🔍 Project toggle - projectId:', projectId, 'isCurrentlyCollapsed:', isCurrentlyCollapsed);
                console.log('🔍 Project toggle - collapsedProjects before:', Array.from(collapsedProjects));
                
                if (isCurrentlyCollapsed) {
                    // Expand project
                    console.log('Expanding project:', projectId);
                    collapsedProjects.delete(projectId);
                    projectContent.classList.remove('collapsed');
                    projectContent.classList.add('expanded');
                    collapseIcon.classList.remove('collapsed');
                    collapseIcon.classList.add('expanded');
                } else {
                    // Collapse project
                    console.log('Collapsing project:', projectId);
                    collapsedProjects.add(projectId);
                    projectContent.classList.remove('expanded');
                    projectContent.classList.add('collapsed');
                    collapseIcon.classList.remove('expanded');
                    collapseIcon.classList.add('collapsed');
                }
                
                console.log('🔍 Project toggle - collapsedProjects after:', Array.from(collapsedProjects));
                
                // Update allProjectsCollapsed state
                allProjectsCollapsed = projects.every(project => collapsedProjects.has(project.id));
                saveDataToFirestore();
            }
        });
        
        // Handle quick edit (double click on task name)
        document.addEventListener('dblclick', (e) => {
            const quickEditElement = e.target.closest('[data-action="quick-edit"]');
            if (quickEditElement) {
                startQuickEdit(quickEditElement.dataset.taskId);
            }
        });

        // Daily Planner Event Delegation
        document.getElementById('dailyPlannerModalOverlay').addEventListener('click', e => {
            const action = e.target.dataset.action;
            const taskId = e.target.dataset.taskId;
            const task = tasks.find(t => t.id === taskId);
            const today = new Date().toISOString().slice(0, 10);

            if (action === 'carryover' && task) {
                task.dailyPlanDate = today;
                e.target.closest('.flex').parentElement.remove(); // Remove the item from the list
            } else if (action === 'discard' && task) {
                task.dailyPlanDate = null;
                e.target.closest('.flex').parentElement.remove(); // Remove the item from the list
            } else if (e.target.classList.contains('create-and-add-btn')) {
                const taskName = e.target.dataset.taskName;
                console.log('Create & Add button clicked, taskName:', taskName);
                if (taskName) {
                    createAndAddToToday(taskName);
                } else {
                    console.error('No taskName found in dataset');
                }
            } else if (e.target.classList.contains('add-to-today-btn')) {
                const taskId = e.target.dataset.taskId;
                if (taskId) {
                    addTaskToToday(taskId);
                }
            } else if (e.target.classList.contains('reactivate-task-btn')) {
                const taskId = e.target.dataset.taskId;
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    task.isActive = true;
                    saveDataToFirestore();
                    // Refresh the daily planner search results
                    const query = document.getElementById('dailyPlannerInput').value.trim();
                    if (query.length > 0) {
                        document.getElementById('dailyPlannerInput').dispatchEvent(new Event('input'));
                    }
                }
            }
        });

        document.getElementById('closeDailyPlannerBtn').onclick = () => {
            saveDataToFirestore(); // Save any changes made
            renderAll();
            hideModal(document.getElementById('dailyPlannerModalOverlay'));
            document.body.classList.remove('overflow-hidden');
        };

        document.getElementById('finishDailyPlanBtn').onclick = () => {
            saveDataToFirestore(); // Save any changes made
            renderAll();
            hideModal(document.getElementById('dailyPlannerModalOverlay'));
            document.body.classList.remove('overflow-hidden');
        };

        document.getElementById('dailyPlannerToggle').onchange = (e) => {
            userSettings.showDailyPlanner = e.target.checked;
            // You might want to save userSettings to Firestore as well
        };

        // Daily Planner input event listener
        const dailyPlannerInput = document.getElementById('dailyPlannerInput');
        if (dailyPlannerInput) {
            // Handle input changes
            dailyPlannerInput.oninput = (e) => {
                const query = e.target.value.trim();
                const todayList = document.getElementById('dailyPlannerTodayList');
                const quickOptions = document.getElementById('quickSelectionOptions');
                console.log('Daily planner input changed:', query);
                
                if (query.length > 0) {
                    // Show quick selection options
                    quickOptions.classList.remove('hidden');
                    
                    const todayForSearch = new Date().toISOString().slice(0, 10);
                    const matchingTasks = tasks.filter(task =>
                        task.name.toLowerCase().includes(query.toLowerCase()) &&
                        (task.dailyPlanDate === null || task.dailyPlanDate !== todayForSearch)
                    );

                    if (matchingTasks.length > 0) {
                        todayList.innerHTML = matchingTasks.map(task => {
                            const isInactive = task.isActive === false;
                            return `
                            <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg border border-slate-200 ${isInactive ? 'opacity-60' : ''}">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 ${isInactive ? 'bg-gray-400' : 'bg-blue-500'} rounded-full mr-3"></div>
                                    <div>
                                        <div class="font-medium text-slate-800 text-sm">${task.name}${isInactive ? ' (Inactive)' : ''}</div>
                                        <div class="text-xs text-slate-500">${task.timeBracket || 'Quick'}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${isInactive ? `
                                        <button class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded-md transition-colors reactivate-task-btn" data-task-id="${task.id}">
                                            Reactivate
                                        </button>
                                    ` : ''}
                                    <button class="text-blue-500 hover:text-blue-700 text-xs font-medium add-to-today-btn" data-task-id="${task.id}">
                                        Add to Today
                                    </button>
                                </div>
                            </div>
                        `;
                        }).join('');
                    } else {
                        // Show create new task option
                        todayList.innerHTML = `
                            <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg border border-slate-200">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                    <div>
                                        <div class="font-medium text-slate-800 text-sm">Create new task: "${query}"</div>
                                        <div class="text-xs text-slate-500">Click to create and add to today</div>
                                    </div>
                                </div>
                                <button class="text-green-500 hover:text-green-700 text-xs font-medium create-and-add-btn" data-task-name="${query.replace(/"/g, '&quot;')}">
                                    Create & Add
                                </button>
                            </div>
                        `;
                    }
                } else {
                    // When input is empty, clear the list and hide quick options
                    todayList.innerHTML = '';
                    quickOptions.classList.add('hidden');
                }
            };

            // Handle Enter key
            dailyPlannerInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query.length > 0) {
                        // Create and add the task
                        createAndAddTask(query);
                    }
                }
            };
        }

    };

    // Helper function to show today's tasks in the modal (now just clears the list since tasks are shown in sidebar)
    const showTodaysTasksInModal = () => {
        const todayList = document.getElementById('dailyPlannerTodayList');
        todayList.innerHTML = '';
    };


    // Function to select quick time
    window.selectQuickTime = (time) => {
        console.log('🔍 selectQuickTime called with:', time);
        window.quickTimeSelection = time;
        console.log('🔍 quickTimeSelection set to:', window.quickTimeSelection);
        updateQuickTimeButtons();
    };

    // Function to select quick context
    window.selectQuickContext = (context) => {
        console.log('🔍 selectQuickContext called with:', context);
        window.quickContextSelection = context;
        console.log('🔍 quickContextSelection set to:', window.quickContextSelection);
        updateQuickContextButtons();
    };

    // Function to update time button states
    const updateQuickTimeButtons = () => {
        const buttons = document.querySelectorAll('.quick-time-btn');
        buttons.forEach(btn => {
            const time = btn.textContent.trim();
            if (time === window.quickTimeSelection) {
                btn.className = `quick-time-btn text-xs px-2 py-1 rounded-full border ${
                    time === 'Quick' ? 'bg-blue-100 text-blue-700 border-blue-200' :
                    time === 'Standard' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' :
                    'bg-purple-100 text-purple-700 border-purple-200'
                }`;
            } else {
                btn.className = 'quick-time-btn text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200';
            }
        });
    };

    // Function to update context button states
    const updateQuickContextButtons = () => {
        const buttons = document.querySelectorAll('.quick-context-btn');
        buttons.forEach(btn => {
            const context = btn.textContent.trim();
            if (context === window.quickContextSelection) {
                btn.className = `quick-context-btn text-xs px-2 py-1 rounded-full border ${
                    context === 'Personal' ? 'bg-green-100 text-green-700 border-green-200' :
                    'bg-orange-100 text-orange-700 border-orange-200'
                }`;
            } else {
                btn.className = 'quick-context-btn text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200';
            }
        });
    };

    // Helper function to create and add a task
    const createAndAddTask = (taskName) => {
        const today = new Date().toISOString().slice(0, 10);
        console.log('🔍 createAndAddTask - Quick selection values:', window.quickTimeSelection, window.quickContextSelection);
        const newTask = {
            id: 'task_' + Date.now(),
            name: taskName,
            timeBracket: window.quickTimeSelection || 'Quick',
            contexts: [window.quickContextSelection || 'Personal'],
            projectId: 'inbox',
            tags: [],
            isRecurring: false,
            isDivisible: false,
            timeSpent: 0,
            dailyPlanDate: today,
            isActive: true,
            isPriority: false
        };
        
        tasks.push(newTask);
        saveDataToFirestore();
        renderTasksAndProjects();
        renderTodayProject();
        
        // Clear the input and reset the display
        const input = document.getElementById('dailyPlannerInput');
        const todayList = document.getElementById('dailyPlannerTodayList');
        const quickOptions = document.getElementById('quickSelectionOptions');
        input.value = '';
        todayList.innerHTML = '';
        quickOptions.classList.add('hidden');
    };

    const createSampleTasks = () => {
        const isActive = true; // Default all sample tasks to active
        const sampleTasks = [
            {
                id: 'task_1',
                name: 'Meditate',
                timeBracket: 'Quick',
                energy: 'Low 🧠',
                contexts: ['Personal'],
                projectId: 'personal',
                tags: ['mindfulness', 'wellness'],
                isRecurring: false,
                isDivisible: false,
                timeSpent: 0,
                isActive: isActive,
                isPriority: false
            },
            {
                id: 'task_2',
                name: 'Log EUC patients',
                timeBracket: 'Quick',
                energy: 'Low 🧠',
                contexts: ['Work'],
                projectId: 'work',
                tags: ['admin', 'documentation'],
                isRecurring: true,
                isDivisible: false,
                timeSpent: 0,
                isActive: isActive,
                isPriority: true
            },
            {
                id: 'task_3',
                name: 'Read journal article',
                totalTimeBracket: 'Standard',
                sessionTimeBracket: 'Quick',
                energy: 'Low 🧠',
                contexts: ['Work'],
                projectId: 'learning',
                tags: ['learning', 'research'],
                isRecurring: false,
                isDivisible: true,
                timeSpent: 0,
                isActive: isActive,
                isPriority: false
            },
            {
                id: 'task_4',
                name: 'Fix TP holder',
                timeBracket: 'Quick',
                energy: 'Medium 💪',
                contexts: ['Personal'],
                projectId: 'personal',
                tags: ['home', 'maintenance'],
                isRecurring: false,
                isDivisible: false,
                timeSpent: 0,
                isActive: isActive,
                isPriority: false
            },
            {
                id: 'task_5',
                name: 'Review email backlog',
                timeBracket: 'Quick',
                energy: 'Low 🧠',
                contexts: ['Work'],
                projectId: 'inbox',
                tags: ['admin', 'communication'],
                isRecurring: false,
                isDivisible: false,
                timeSpent: 0,
                isActive: isActive,
                isPriority: false
            },
            {
                id: 'task_6',
                name: 'Learn new programming concept',
                totalTimeBracket: 'Standard',
                sessionTimeBracket: 'Quick',
                energy: 'High 🔥',
                contexts: ['Work'],
                projectId: 'learning',
                tags: ['programming', 'skill-building'],
                isRecurring: false,
                isDivisible: true,
                timeSpent: 45,
                isActive: isActive,
                isPriority: true
            },
            {
                id: 'task_7',
                name: 'Read industry article',
                timeBracket: 'Quick',
                energy: 'Low 🧠',
                contexts: ['Work'],
                projectId: 'learning',
                tags: ['research', 'industry'],
                isRecurring: false,
                isDivisible: false,
                timeSpent: 15,
                isActive: isActive,
                isPriority: false
            },
            {
                id: 'task_8',
                name: 'Plan weekend activities',
                timeBracket: 'Quick',
                energy: 'Medium 💪',
                contexts: ['Personal'],
                projectId: 'personal',
                tags: ['planning', 'leisure'],
                isRecurring: false,
                isDivisible: false,
                timeSpent: 0,
                isActive: false,
                isPriority: false
            }
        ];
        
        // Ensure sample projects exist
        if (!projects.find(p => p.id === 'work')) {
            projects.push({ id: 'work', name: 'Work Projects' });
        }
        if (!projects.find(p => p.id === 'personal')) {
            projects.push({ id: 'personal', name: 'Personal' });
        }
        if (!projects.find(p => p.id === 'learning')) {
            projects.push({ id: 'learning', name: 'Learning' });
        }
        
        tasks = sampleTasks;
        
        // Create sample worklogs to showcase Weekly Insights
        const today = new Date().toISOString().split('T')[0];
        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        const twoDaysAgo = new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        worklogs = [
            {
                id: 'worklog_1',
                taskId: 'task_6',
                userId: 'guest',
                sessionType: 'focus',
                startTime: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                endTime: new Date(Date.now() - 1.5 * 60 * 60 * 1000).toISOString(),
                duration: 30 * 60, // 30 minutes
                pausedTime: 0,
                pauseCount: 0,
                status: 'completed',
                notes: 'Focused on React hooks',
                energy: 'High 🔥',
                context: 'Work',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            },
            {
                id: 'worklog_2',
                taskId: 'task_7',
                userId: 'guest',
                sessionType: 'quick',
                startTime: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
                endTime: new Date(Date.now() - 45 * 60 * 1000).toISOString(),
                duration: 15 * 60, // 15 minutes
                pausedTime: 0,
                pauseCount: 0,
                status: 'completed',
                notes: 'Read about AI trends',
                energy: 'Low 🧠',
                context: 'Work',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            },
            {
                id: 'worklog_3',
                taskId: 'task_2',
                userId: 'guest',
                sessionType: 'quick',
                startTime: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
                endTime: new Date(Date.now() - 20 * 60 * 1000).toISOString(),
                duration: 10 * 60, // 10 minutes
                pausedTime: 0,
                pauseCount: 0,
                status: 'completed',
                notes: 'Updated patient records',
                energy: 'Low 🧠',
                context: 'Work',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            }
        ];
        
        console.log('Created sample tasks:', tasks);
        console.log('Created sample worklogs:', worklogs);
        console.log('Current projects:', projects);
        saveDataToFirestore();
        renderAll();
    };

    const loadDataFromFirestore = (userId) => {
        const userDocRef = window.doc(db, 'users', userId);
        
        if (unsubscribeFromData) {
            unsubscribeFromData();
        }

        unsubscribeFromData = window.onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                projects = data.projects || [{ id: 'inbox', name: 'Inbox' }];
                
                // Ensure Inbox project exists
                if (!projects.find(p => p.id === 'inbox')) {
                    projects.unshift({ id: 'inbox', name: 'Inbox' });
                    console.log('Added missing Inbox project');
                    // Save the updated projects list to Firestore
                    saveDataToFirestore();
                }
                
                tasks = data.tasks || [];
                completedTasks = data.completedTasks || [];
                worklogs = data.worklogs || [];
                console.log('Loaded tasks from Firestore:', tasks.length, tasks);
                console.log('Loaded completed tasks from Firestore:', completedTasks.length, completedTasks);
                console.log('Loaded worklogs from Firestore:', worklogs.length, worklogs);
                
                // Debug: Check if tasks are empty objects
                if (tasks.length > 0) {
                    console.log('First task structure:', tasks[0]);
                    console.log('Task keys:', Object.keys(tasks[0]));
                }
                
                // If no tasks exist, create some sample tasks
                if (tasks.length === 0) {
                    console.log('No tasks found, creating sample tasks...');
                    createSampleTasks();
                }
                streakData = data.streakData || { currentStreak: 0, lastCompletedDate: null };
                console.log('Loaded collapsedProjects from Firestore:', data.collapsedProjects);
                // Load the actual collapsed projects state from Firestore
                collapsedProjects = new Set(data.collapsedProjects || []);
                console.log('Final collapsedProjects Set:', Array.from(collapsedProjects));
                // Force task review section to be collapsed by default for existing users
                taskReviewCollapsed = true;
            } else {
                console.log("Document does not exist. Initializing data for new user.");
                projects = [{ id: 'inbox', name: 'Inbox' }];
                tasks = [];
                completedTasks = [];
                streakData = { currentStreak: 0, lastCompletedDate: null };
                collapsedProjects = new Set();
                taskReviewCollapsed = true;
                saveDataToFirestore();
            }
            renderAll();
            
            // Check for and restore any saved focus session
            const savedSession = loadFocusSessionFromStorage();
            if (savedSession) {
                console.log('🔄 Attempting to restore focus session...');
                const restored = restoreFocusSession(savedSession);
                if (!restored) {
                    console.log('❌ Failed to restore focus session, clearing localStorage');
                }
            }
        }, (error) => {
            console.error("Error listening to user data:", error);
        });
    };

    const handleAuthStateChange = (user) => {
      console.log('🔐 Auth state changed:', user ? 'User logged in' : 'User logged out');
      console.log('🔐 User object:', user);
      console.log('🔐 Current user before:', currentUser);
        if (user) {
            console.log('✅ User authenticated, showing main app');
            currentUser = user;
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            mainApp.classList.add('flex');
            
            // Show sidebar on desktop after login
            console.log('🖥️ Screen width:', window.innerWidth);
            console.log('🖥️ Sidebar element:', sidebar);
            console.log('🖥️ Sidebar classes before:', sidebar.className);
            
            // Force sidebar to be visible on desktop
            if (sidebar) {
                sidebar.classList.remove('hidden');
                sidebar.style.display = 'flex';
                sidebar.style.visibility = 'visible';
                sidebar.style.position = 'relative';
                sidebar.style.width = '33.333333%';
                sidebar.style.maxWidth = '24rem';
                console.log('🖥️ Sidebar classes after:', sidebar.className);
                console.log('🖥️ Sidebar style display:', sidebar.style.display);
                console.log('🖥️ Sidebar computed style:', window.getComputedStyle(sidebar).display);
            } else {
                console.error('❌ Sidebar element not found!');
            }
            
            // Hide guest mode notice for authenticated users
            document.getElementById('guestModeNotice').classList.add('hidden');
            const displayName = user.displayName || user.email.split('@')[0];
            const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=3b82f6&color=ffffff&size=32`;
            
            document.getElementById('userDisplay').innerHTML = `
                <div class="flex items-center">
                    <img src="${photoURL}" alt="User Photo" class="w-8 h-8 rounded-full mr-3">
                <div class="flex-grow">
                        <div class="font-semibold text-sm">${displayName}</div>
                    <div class="text-xs text-slate-500">${user.email}</div>
                </div>
                    <button id="logoutBtn" class="text-slate-400 hover:text-red-500 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors" title="Sign out">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>
                </button>
                </div>
            `;
            document.getElementById('logoutBtn').onclick = handleLogout;
            loadDataFromFirestore(user.uid);
            triggerDailyPlanner(); // Add this line
            applySmartDefaults();
            
            // Ensure the app is rendered after login
            console.log('🎨 Rendering app after login...');
            renderAll();
        } else {
            console.log('❌ No user authenticated, showing login screen');
            currentUser = null;
            if (unsubscribeFromData) {
              unsubscribeFromData();
            }
            // Show login screen for unauthenticated users
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            mainApp.classList.remove('flex');
        }
    };

    // --- INITIALIZE APP ---
    console.log('🚀 Starting app initialization...');
    
    // Wait for DOM to be ready
    const initializeApp = () => {
        console.log('🔧 DOM ready, initializing app...');
    try {
      renderFilterButtons();
      console.log('✅ renderFilterButtons completed');
    } catch (error) {
      console.error('❌ renderFilterButtons failed:', error);
    }
    
    try {
      initializeEventListeners();
      console.log('✅ initializeEventListeners completed');
    } catch (error) {
      console.error('❌ initializeEventListeners failed:', error);
    }
    
    try {
              window.onAuthStateChanged(auth, handleAuthStateChange);
      console.log('✅ onAuthStateChanged completed');
    } catch (error) {
      console.error('❌ onAuthStateChanged failed:', error);
    }
    
    console.log('🎉 App initialization completed!');
    }
    
    // Initialize immediately if DOM is already ready, otherwise wait
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
    
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registered successfully');
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
  </script>

  <!-- Settings Modal -->
  <div id="settingsModalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-[80] p-4" inert aria-hidden="true">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md relative max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-slate-900">⚙️ Settings</h2>
          <button id="closeSettingsBtn" class="text-slate-400 hover:text-slate-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>

        <!-- Theme Settings -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-slate-800 mb-3">Theme</h3>
          <div class="space-y-2">
            <label class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="theme" value="light" class="mr-3 text-blue-600 focus:ring-blue-500">
              <div class="flex items-center">
                <div class="w-4 h-4 bg-white border border-slate-300 rounded mr-2"></div>
                <span class="text-slate-700">Light</span>
              </div>
            </label>
            <label class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="theme" value="dark" class="mr-3 text-blue-600 focus:ring-blue-500">
              <div class="flex items-center">
                <div class="w-4 h-4 bg-slate-800 border border-slate-300 rounded mr-2"></div>
                <span class="text-slate-700">Dark</span>
              </div>
            </label>
            <label class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="theme" value="system" class="mr-3 text-blue-600 focus:ring-blue-500">
              <div class="flex items-center">
                <div class="w-4 h-4 bg-gradient-to-r from-white to-slate-800 border border-slate-300 rounded mr-2"></div>
                <span class="text-slate-700">System</span>
              </div>
            </label>
          </div>
        </div>

        <!-- Font Size Settings -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-slate-800 mb-3">Font Size</h3>
          <div class="space-y-2">
            <label class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="fontSize" value="small" class="mr-3 text-blue-600 focus:ring-blue-500">
              <span class="text-slate-700 text-sm">Small</span>
            </label>
            <label class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="fontSize" value="medium" class="mr-3 text-blue-600 focus:ring-blue-500">
              <span class="text-slate-700">Medium</span>
            </label>
            <label class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="fontSize" value="large" class="mr-3 text-blue-600 focus:ring-blue-500">
              <span class="text-slate-700 text-lg">Large</span>
            </label>
            <label class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="fontSize" value="extra-large" class="mr-3 text-blue-600 focus:ring-blue-500">
              <span class="text-slate-700 text-xl">Extra Large</span>
            </label>
          </div>
        </div>

        <!-- Accessibility Settings -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-slate-800 mb-3">Accessibility</h3>
          <label class="flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 cursor-pointer">
            <input type="checkbox" id="reducedMotion" class="mr-3 text-blue-600 focus:ring-blue-500 rounded">
            <span class="text-slate-700">Reduce motion</span>
          </label>
        </div>

        <!-- Quick Actions -->
        <div class="flex gap-3">
          <button id="resetSettingsBtn" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors font-medium text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Reset
          </button>
          <button id="saveSettingsBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors font-medium text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Save
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Daily Planner Modal -->
  <div id="dailyPlannerModalOverlay" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden z-[75] p-2" inert aria-hidden="true">
      <div class="bg-white p-4 rounded-lg shadow-lg w-full max-w-xl max-h-[85vh] flex flex-col relative">
          <!-- Header - Compact -->
          <div class="text-center mb-3">
              <h2 class="text-lg font-bold text-slate-900">🌟 Plan Your Day</h2>
              <p class="text-xs text-slate-500">Set your focus for today</p>
          </div>


          <!-- Close Button - Top Right -->
          <button id="closeDailyPlannerBtn" class="absolute top-2 right-2 text-slate-400 hover:text-slate-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>

          <div class="flex-grow overflow-y-auto space-y-4">
              <div id="dailyPlannerRolloverSection" class="hidden">
                  <h3 class="font-semibold text-slate-800 mb-2 text-xs">Review Yesterday's Unfinished Tasks</h3>
                  <div id="dailyPlannerRolloverList" class="space-y-1">
                      </div>
              </div>

              <div>
                  <h3 class="font-semibold text-slate-800 mb-2 text-xs">What do you want to accomplish today?</h3>
                  <div class="relative">
                      <input id="dailyPlannerInput" type="text" placeholder="Search tasks or type to create a new one..." class="w-full border border-slate-300 p-2 rounded-md text-sm placeholder:text-slate-400 focus:ring-1 focus:ring-blue-400 focus:border-blue-400 outline-none" />
                      </div>
                  
                  <!-- Quick Selection Options (hidden by default) -->
                  <div id="quickSelectionOptions" class="hidden mt-2 p-2 bg-slate-50 rounded-md border border-slate-200">
                      <div class="text-xs text-slate-600 mb-2">Quick settings for new task:</div>
                      <div class="space-y-2">
                          <div class="flex items-center gap-2">
                              <span class="text-xs text-slate-500 w-12">Time:</span>
                              <button onclick="selectQuickTime('Quick')" class="quick-time-btn text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700 border border-blue-200">
                                  Quick
                              </button>
                              <button onclick="selectQuickTime('Standard')" class="quick-time-btn text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200">
                                  Standard
                              </button>
                              <button onclick="selectQuickTime('Long')" class="quick-time-btn text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200">
                                  Long
                              </button>
                          </div>
                          <div class="flex items-center gap-2">
                              <span class="text-xs text-slate-500 w-12">Context:</span>
                              <button onclick="selectQuickContext('Personal')" class="quick-context-btn text-xs px-2 py-1 rounded-full bg-green-100 text-green-700 border border-green-200">
                                  Personal
                              </button>
                              <button onclick="selectQuickContext('Work')" class="quick-context-btn text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200">
                                  Work
                              </button>
                          </div>
                      </div>
                  </div>
                  
                  <div id="dailyPlannerTodayList" class="mt-2 space-y-1">
                      </div>
              </div>
          </div>

          <div class="flex items-center justify-between pt-2 border-t border-slate-200 mt-2">
              <div class="flex items-center">
                  <input type="checkbox" id="dailyPlannerToggle" class="h-3 w-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-1">
                  <label for="dailyPlannerToggle" class="text-xs text-slate-600">Show this automatically every morning</label>
              </div>
              <button id="finishDailyPlanBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-md transition-colors font-medium text-xs focus:outline-none focus:ring-1 focus:ring-offset-1 focus:ring-blue-500">
                  Done
              </button>
          </div>
      </div>
  </div>
</body>
</html>
