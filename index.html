<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Select + Do</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Simple fade-in animation for the suggested task card */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans overflow-x-hidden">
  <!-- Main Application Wrapper -->
  <div id="mainApp" class="flex flex-col md:flex-row md:h-screen">
    <!-- Sidebar -->
    <div class="w-full md:w-1/3 md:max-w-sm p-4 bg-white shadow-md flex flex-col shrink-0">
      <h1 class="text-2xl font-bold mb-4 text-blue-600">Select + Do</h1>
      <button id="addTaskBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded mb-4 transition-colors">
        + Add New Task
      </button>
      <div class="flex space-x-2 mb-4">
        <button id="exportBtn" class="flex-1 border border-gray-300 hover:bg-gray-100 py-2 rounded transition-colors">Export</button>
        <button id="importBtn" class="flex-1 border border-gray-300 hover:bg-gray-100 py-2 rounded transition-colors">Import</button>
      </div>
       <div class="mb-4">
        <input id="quickAddTaskInput" type="text" placeholder="Quick Add: task :15 #tag @ctx" class="w-full border p-2 rounded text-sm" />
       </div>
      <h2 class="font-semibold border-b pb-2 mb-2">My Tasks</h2>
      <div id="taskList" class="space-y-2 overflow-y-auto flex-grow">
        <!-- Tasks will be rendered here -->
      </div>
      <h2 class="font-semibold border-b pb-2 mb-2 mt-4">Completed Today</h2>
      <div id="completedTaskList" class="space-y-2 overflow-y-auto max-h-[50vh] md:max-h-full">
        <!-- Completed tasks will be rendered here -->
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-4 md:p-6 md:overflow-y-auto">
      <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
        <h2 class="font-semibold mb-2">1. How much time do you have?</h2>
        <div id="timeFilters" class="flex flex-wrap gap-2 mb-4"></div>

        <h2 class="font-semibold mb-2">2. Choose a context</h2>
        <div id="contextFilters" class="flex flex-wrap gap-2 mb-4"></div>
        
        <h2 class="font-semibold mb-2">3. What's your energy level?</h2>
        <div id="energyFilters" class="flex flex-wrap gap-2 mb-4"></div>

        <div class="flex flex-wrap gap-2 border-t pt-4 mt-4">
          <button id="suggestTaskBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors">Suggest a Task</button>
          <button id="surpriseMeBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors">Surprise Me!</button>
          <button id="clearFiltersBtn" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded transition-colors">Clear Filters</button>
        </div>
      </div>
      <div id="filteredTaskList" class="space-y-4">
          <!-- Suggested task will appear here -->
      </div>
    </div>
  </div>

  <!-- Modal for Adding/Editing Tasks -->
  <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
      <h2 id="modalTitle" class="text-lg font-bold mb-4">Add New Task</h2>
      <input id="taskName" type="text" placeholder="Task Name (e.g., 'Draft project proposal')" class="w-full mb-4 border p-2 rounded"/>
      
      <label class="block mb-1 font-medium">Time Required (minutes)</label>
      <div id="modalTimeButtons" class="flex flex-wrap gap-2 mb-4"></div>
      
      <label class="block mb-1 font-medium">Context</label>
      <div id="modalContextButtons" class="flex flex-wrap gap-2 mb-4"></div>

      <label class="block mb-1 font-medium">Energy Level</label>
      <div id="modalEnergyButtons" class="flex flex-wrap gap-2 mb-4"></div>
      
      <label class="block mb-1 font-medium">Tags (optional)</label>
      <input id="taskTags" type="text" placeholder="Type a tag and hit Enter" class="w-full mb-2 border p-2 rounded"/>
      <div id="tagPreview" class="flex flex-wrap gap-2 mb-4 min-h-[28px]"></div>
      
      <div class="flex justify-end space-x-2">
        <button id="cancelTaskBtn" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded transition-colors">Cancel</button>
        <button id="saveTaskBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors">Save Task</button>
      </div>
    </div>
  </div>

  <!-- Focus Mode Overlay -->
  <div id="focusOverlay" class="fixed inset-0 bg-white z-[100] flex flex-col justify-center items-center text-center hidden p-4">
    <h1 id="focusTaskName" class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-800 mb-8"></h1>
    <div id="focusTimerDisplay" class="text-6xl sm:text-7xl lg:text-9xl font-mono font-bold text-blue-600 mb-12"></div>
    <div class="flex space-x-4">
        <button id="focusPauseBtn" class="w-28 sm:w-32 bg-gray-500 hover:bg-gray-600 text-white text-lg py-2 px-4 sm:py-3 sm:px-6 rounded-lg transition-colors">Pause</button>
        <button id="focusStopBtn" class="w-28 sm:w-32 bg-red-500 hover:bg-red-600 text-white text-lg py-2 px-4 sm:py-3 sm:px-6 rounded-lg transition-colors">Stop</button>
    </div>
    <button id="focusCompleteBtn" class="hidden mt-8 bg-green-500 hover:bg-green-600 text-white text-lg py-3 px-8 rounded-lg transition-colors">Mark as Complete & Exit</button>
  </div>
  
  <input type="file" id="importFile" class="hidden" accept=".json">

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- STATE MANAGEMENT ---
      let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
      let completedTasks = JSON.parse(localStorage.getItem('completedTasks') || '[]');
      let modalTagList = [];
      let modalSelectedTime = null;
      let modalSelectedContexts = [];
      let modalSelectedEnergy = null;
      let editingTaskId = null;

      let selectedTimeFilter = null;
      let selectedContextFilter = null;
      let selectedEnergyFilter = null;
      
      // Timer State
      let timerInterval = null;
      let remainingSeconds = 0;
      let isPaused = false;
      let currentFocusTaskId = null;
      const originalTitle = document.title;


      // --- DOM ELEMENTS ---
      const taskList = document.getElementById('taskList');
      const completedTaskList = document.getElementById('completedTaskList');
      const filteredList = document.getElementById('filteredTaskList');
      const modalOverlay = document.getElementById('modalOverlay');
      const focusOverlay = document.getElementById('focusOverlay');
      const focusTaskName = document.getElementById('focusTaskName');
      const focusTimerDisplay = document.getElementById('focusTimerDisplay');
      const focusPauseBtn = document.getElementById('focusPauseBtn');
      const focusStopBtn = document.getElementById('focusStopBtn');
      const focusCompleteBtn = document.getElementById('focusCompleteBtn');

      // --- CORE FUNCTIONS ---
      const saveTasksToLocalStorage = () => localStorage.setItem('tasks', JSON.stringify(tasks));
      const saveCompletedTasksToLocalStorage = () => localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
      
      const renderTasks = () => {
        taskList.innerHTML = '';
        if (tasks.length === 0) {
          taskList.innerHTML = `<div class="text-center text-gray-500 p-4 bg-gray-50 rounded mt-4">No tasks yet. Add one to get started!</div>`;
          return;
        }
        tasks.forEach(task => {
          const div = document.createElement('div');
          div.className = 'bg-white border rounded p-3 shadow-sm flex flex-col';
          div.innerHTML = `
            <div class="flex-grow">
              <div class="font-semibold">${task.name}</div>
              <div class="text-sm text-gray-500 mb-2">${task.time} min â€¢ ${task.contexts.join(', ')} â€¢ ${task.energy}</div>
              <div class="flex flex-wrap gap-1">${task.tags.map(tag => `<span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full">${tag}</span>`).join('')}</div>
            </div>
            <div class="flex justify-end space-x-2 mt-3 text-sm">
              <button class="text-blue-500 hover:underline" onclick="window.app.editTask('${task.id}')">Edit</button>
              <button class="text-red-500 hover:underline" onclick="window.app.deleteTask('${task.id}')">Delete</button>
            </div>
          `;
          taskList.appendChild(div);
        });
      };
      
      const renderCompletedTasks = () => {
        const today = new Date().toISOString().slice(0, 10);
        const tasksCompletedToday = completedTasks.filter(task => task.completedAt && task.completedAt.slice(0, 10) === today);

        completedTaskList.innerHTML = '';
        if (tasksCompletedToday.length === 0) {
            completedTaskList.innerHTML = `<div class="text-center text-gray-500 p-4 bg-gray-50 rounded mt-2 text-sm">No tasks completed yet today. You can do it!</div>`;
            return;
        }
        
        tasksCompletedToday.forEach(task => {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 p-2 bg-green-50 rounded';
            div.innerHTML = `
                <span class="text-green-500">âœ”</span>
                <span class="text-gray-500 line-through">${task.name}</span>
            `;
            completedTaskList.appendChild(div);
        });
      };

      // --- MODAL LOGIC ---
      const resetModal = () => {
        document.getElementById('taskName').value = '';
        document.getElementById('taskTags').value = '';
        modalTagList = [];
        modalSelectedTime = null;
        modalSelectedContexts = [];
        modalSelectedEnergy = null;
        editingTaskId = null;
        renderTagPreview();
        document.querySelectorAll('.modal-time-btn, .modal-context-btn, .modal-energy-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
      };
      const openModal = (mode = 'add') => {
        document.getElementById('modalTitle').textContent = mode === 'add' ? 'Add New Task' : 'Edit Task';
        modalOverlay.classList.remove('hidden');
      };
      const closeModal = () => {
        modalOverlay.classList.add('hidden');
        resetModal();
      };
      const renderTagPreview = () => {
        const tagDiv = document.getElementById('tagPreview');
        tagDiv.innerHTML = modalTagList.map((tag, i) => `
          <span class="bg-gray-200 text-sm px-2 py-1 rounded-full flex items-center">
            ${tag}
            <button class="ml-2 text-red-500 font-bold" onclick="window.app.removeTag(${i})">&times;</button>
          </span>
        `).join('');
      };
      const saveTask = () => {
        const name = document.getElementById('taskName').value.trim();
        if (!name || !modalSelectedTime || modalSelectedContexts.length === 0 || !modalSelectedEnergy) {
          alert('Please provide a task name, time, context, and energy level.');
          return;
        }
        if (editingTaskId) {
          const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
          if (taskIndex > -1) tasks[taskIndex] = { ...tasks[taskIndex], name, time: modalSelectedTime, contexts: [...modalSelectedContexts], energy: modalSelectedEnergy, tags: [...modalTagList] };
        } else {
          tasks.push({ id: `task_${Date.now()}`, name, time: modalSelectedTime, contexts: [...modalSelectedContexts], energy: modalSelectedEnergy, tags: [...modalTagList] });
        }
        saveTasksToLocalStorage();
        renderTasks();
        closeModal();
      };
      
      // --- FOCUS & TIMER LOGIC ---
      const updateTimerDisplay = () => {
          const minutes = Math.floor(remainingSeconds / 60).toString().padStart(2, '0');
          const seconds = (remainingSeconds % 60).toString().padStart(2, '0');
          const timeString = `${minutes}:${seconds}`;
          focusTimerDisplay.textContent = timeString;
          document.title = `${timeString} - ${focusTaskName.textContent}`;
      };

      const tick = () => {
          if (isPaused) return;
          remainingSeconds--;
          updateTimerDisplay();
          if (remainingSeconds <= 0) {
              clearInterval(timerInterval);
              document.title = "Time's up!";
              focusTimerDisplay.textContent = "Done!";
              focusPauseBtn.classList.add('hidden');
              focusStopBtn.classList.add('hidden');
              focusCompleteBtn.classList.remove('hidden');
          }
      };
      
      const startTimer = () => {
          clearInterval(timerInterval);
          timerInterval = setInterval(tick, 1000);
      };

      const stopFocusSession = (confirmFirst = true) => {
        if (confirmFirst && !confirm("Are you sure you want to stop? The task won't be marked as complete.")) return;
        
        clearInterval(timerInterval);
        focusOverlay.classList.add('hidden');
        document.title = originalTitle;
        currentFocusTaskId = null;
        isPaused = false;
        timerInterval = null;
      };

      window.app = {
          deleteTask: (taskId) => {
            if (confirm('Are you sure you want to delete this task?')) {
              tasks = tasks.filter(task => task.id !== taskId);
              saveTasksToLocalStorage();
              renderTasks();
            }
          },
          editTask: (taskId) => {
              resetModal();
              const task = tasks.find(t => t.id === taskId);
              if (!task) return;
              editingTaskId = taskId;
              document.getElementById('taskName').value = task.name;
              modalTagList = [...task.tags];
              modalSelectedTime = task.time;
              modalSelectedContexts = [...task.contexts];
              modalSelectedEnergy = task.energy;
              renderTagPreview();
              document.querySelectorAll('.modal-time-btn').forEach(btn => { if (parseInt(btn.dataset.time) === task.time) btn.classList.add('bg-blue-600', 'text-white'); });
              document.querySelectorAll('.modal-context-btn').forEach(btn => { if (task.contexts.includes(btn.dataset.context)) btn.classList.add('bg-blue-600', 'text-white'); });
              document.querySelectorAll('.modal-energy-btn').forEach(btn => { if (btn.dataset.energy === task.energy) btn.classList.add('bg-blue-600', 'text-white'); });
              openModal('edit');
          },
          removeTag: (index) => {
            modalTagList.splice(index, 1);
            renderTagPreview();
          },
          markTaskDone: (taskId) => {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                const completedTask = { ...tasks[taskIndex], completedAt: new Date().toISOString() };
                completedTasks.push(completedTask);
                tasks.splice(taskIndex, 1);
                
                saveTasksToLocalStorage();
                saveCompletedTasksToLocalStorage();
                renderTasks();
                renderCompletedTasks();

                const positiveMessages = [
                    "Great job! Task completed. âœ¨",
                    "Awesome work! You're on a roll. ðŸ”¥",
                    "That's one step closer to your goals. ðŸš€",
                    "Productivity unlocked! ðŸŒŸ",
                    "You're building an amazing habit. ðŸ’ª"
                ];
                const message = positiveMessages[Math.floor(Math.random() * positiveMessages.length)];
                filteredList.innerHTML = `<div class="text-center text-green-600 p-4 bg-green-50 rounded shadow-sm">${message}</div>`;
                setTimeout(() => { if(filteredList.firstChild) filteredList.innerHTML = ''; }, 4000);
            }
            if (!focusOverlay.classList.contains('hidden')) {
                stopFocusSession(false);
            }
          },
          startFocusSession: (taskId) => {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            currentFocusTaskId = taskId;
            remainingSeconds = task.time * 60;
            focusTaskName.textContent = task.name;
            updateTimerDisplay();
            focusPauseBtn.textContent = 'Pause';
            focusPauseBtn.classList.remove('hidden');
            focusStopBtn.classList.remove('hidden');
            focusCompleteBtn.classList.add('hidden');
            focusOverlay.classList.remove('hidden');
            startTimer();
          }
      };


      // --- FILTERING AND SUGGESTION LOGIC ---
      const applyFiltersAndSuggest = (mode = 'suggest') => {
        let potentialTasks;
        if (mode === 'suggest') {
          potentialTasks = tasks.filter(task => {
            const timeMatches = () => {
              if (!selectedTimeFilter) return true;
              let tolerance = 5;
              if (selectedTimeFilter >= 30) tolerance = 10;
              return task.time <= selectedTimeFilter + tolerance;
            };
            const contextMatches = !selectedContextFilter || task.contexts.includes(selectedContextFilter);
            const energyMatches = !selectedEnergyFilter || task.energy === selectedEnergyFilter;
            return timeMatches() && contextMatches && energyMatches;
          });
        } else {
            potentialTasks = tasks;
        }
        
        filteredList.innerHTML = '';
        let taskToSuggest = potentialTasks.length > 0 ? potentialTasks[Math.floor(Math.random() * potentialTasks.length)] : null;

        if (taskToSuggest) {
          const div = document.createElement('div');
          div.className = 'bg-white border-2 border-blue-500 rounded-lg p-4 shadow-lg animate-fade-in';
          div.innerHTML = `
            <h3 class="text-xl font-bold mb-2">${taskToSuggest.name}</h3>
            <p class="text-gray-600 mb-3">Time: ${taskToSuggest.time} min | Context: ${taskToSuggest.contexts.join(', ')} | Energy: ${taskToSuggest.energy}</p>
            <div class="flex flex-wrap gap-1 mb-4">${taskToSuggest.tags.map(tag => `<span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full">${tag}</span>`).join('')}</div>
            <button onclick="window.app.startFocusSession('${taskToSuggest.id}')" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded transition-colors">Start Focus Session</button>
          `;
          filteredList.appendChild(div);
        } else {
          filteredList.innerHTML = `<div class="text-center text-gray-500 p-4 bg-gray-50 rounded shadow-sm">No tasks match your criteria. Try clearing the filters!</div>`;
        }
      };
      
      // --- NEW: SMART DEFAULTS & QUICK ADD ---
      const applySmartDefaults = () => {
        const now = new Date();
        const hour = now.getHours(); // 0-23
        const day = now.getDay(); // 0 (Sun) - 6 (Sat)
        
        let defaultContext = null;
        if (day >= 1 && day <= 5) { // Weekday
            if (hour >= 9 && hour < 17) defaultContext = 'Workday';
            else if (hour >=17 && hour < 22) defaultContext = 'Evening';
        } else { // Weekend
            defaultContext = 'Weekend';
        }

        if (defaultContext) {
            const contextButton = document.querySelector(`.context-filter[data-context="${defaultContext}"]`);
            if (contextButton) {
                selectedContextFilter = defaultContext;
                contextButton.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            }
        }
      };

      const handleQuickAdd = (e) => {
        if (e.key !== 'Enter' || !e.target.value.trim()) return;

        let input = e.target.value;
        
        // Parsing logic
        const timeRegex = /:(\d+)/;
        const tagRegex = /#(\w+)/g;
        const contextRegex = /@(\w+)/;

        const timeMatch = input.match(timeRegex);
        const tagsMatch = [...input.matchAll(tagRegex)];
        const contextMatch = input.match(contextRegex);
        
        // Clean the name by removing matched parts
        let name = input.replace(timeRegex, '').replace(tagRegex, '').replace(contextRegex, '').trim();

        if (!name) return; // Must have a name

        resetModal();

        document.getElementById('taskName').value = name;
        
        if (timeMatch) {
            modalSelectedTime = parseInt(timeMatch[1]);
            document.querySelector(`.modal-time-btn[data-time="${modalSelectedTime}"]`)?.classList.add('bg-blue-600', 'text-white');
        }
        if (tagsMatch.length > 0) {
            modalTagList = tagsMatch.map(match => match[1]);
            renderTagPreview();
        }
        if (contextMatch) {
            const context = contextMatch[1].charAt(0).toUpperCase() + contextMatch[1].slice(1);
            modalSelectedContexts = [context];
            document.querySelector(`.modal-context-btn[data-context="${context}"]`)?.classList.add('bg-blue-600', 'text-white');
        }

        e.target.value = '';
        openModal('add');
      };


      // --- DYNAMIC ELEMENT RENDERING & EVENT LISTENERS ---
      const renderFilterButtons = () => {
        const timeOptions = [5, 10, 15, 20, 25, 30, 45, 60];
        const contextOptions = ['Workday', 'Evening', 'Weekend', 'Commute', 'Home'];
        const energyOptions = ['Low ðŸ§ ', 'Medium ðŸ’ª', 'High ðŸ”¥'];

        const createButtons = (opts, containerId, className, dataAttr) => {
            const container = document.getElementById(containerId);
            container.innerHTML = opts.map(opt => `<button data-${dataAttr}="${opt}" class="${className} border border-gray-300 hover:border-blue-500 hover:bg-blue-100 px-3 py-1 rounded-full transition-colors">${dataAttr === 'time' ? `${opt} min` : opt}</button>`).join('');
        };
        createButtons(timeOptions, 'timeFilters', 'time-filter', 'time');
        createButtons(contextOptions, 'contextFilters', 'context-filter', 'context');
        createButtons(energyOptions, 'energyFilters', 'energy-filter', 'energy');

        createButtons(timeOptions, 'modalTimeButtons', 'modal-time-btn border border-gray-300 px-3 py-1 rounded-full', 'time');
        createButtons(contextOptions, 'modalContextButtons', 'modal-context-btn border border-gray-300 px-3 py-1 rounded-full', 'context');
        createButtons(energyOptions, 'modalEnergyButtons', 'modal-energy-btn border border-gray-300 px-3 py-1 rounded-full', 'energy');
      };
      
      const initializeEventListeners = () => {
        document.getElementById('addTaskBtn').onclick = () => openModal('add');
        document.getElementById('suggestTaskBtn').onclick = () => applyFiltersAndSuggest('suggest');
        document.getElementById('surpriseMeBtn').onclick = () => applyFiltersAndSuggest('surprise');
        document.getElementById('clearFiltersBtn').onclick = () => {
          selectedTimeFilter = null; selectedContextFilter = null; selectedEnergyFilter = null;
          document.querySelectorAll('.time-filter, .context-filter, .energy-filter').forEach(b => b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600'));
          filteredList.innerHTML = '';
        };
        document.getElementById('cancelTaskBtn').onclick = closeModal;
        document.getElementById('saveTaskBtn').onclick = saveTask;
        document.getElementById('taskTags').addEventListener('keypress', e => {
          if (e.key === 'Enter' && e.target.value.trim()) {
            e.preventDefault();
            if (!modalTagList.includes(e.target.value.trim())) modalTagList.push(e.target.value.trim());
            e.target.value = '';
            renderTagPreview();
          }
        });

        document.getElementById('quickAddTaskInput').addEventListener('keypress', handleQuickAdd);
        
        document.getElementById('timeFilters').addEventListener('click', e => {
            if (e.target.matches('.time-filter')) {
                document.querySelectorAll('.time-filter').forEach(b => b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600'));
                e.target.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                selectedTimeFilter = parseInt(e.target.dataset.time);
            }
        });
        document.getElementById('contextFilters').addEventListener('click', e => {
            if (e.target.matches('.context-filter')) {
                document.querySelectorAll('.context-filter').forEach(b => b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600'));
                e.target.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                selectedContextFilter = e.target.dataset.context;
            }
        });
        document.getElementById('energyFilters').addEventListener('click', e => {
            if (e.target.matches('.energy-filter')) {
                document.querySelectorAll('.energy-filter').forEach(b => b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600'));
                e.target.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                selectedEnergyFilter = e.target.dataset.energy;
            }
        });

        document.getElementById('modalTimeButtons').addEventListener('click', e => {
            if (e.target.matches('.modal-time-btn')) {
                modalSelectedTime = parseInt(e.target.dataset.time);
                document.querySelectorAll('.modal-time-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
                e.target.classList.add('bg-blue-600', 'text-white');
            }
        });
        document.getElementById('modalContextButtons').addEventListener('click', e => {
            if (e.target.matches('.modal-context-btn')) {
                const ctx = e.target.dataset.context;
                if (modalSelectedContexts.includes(ctx)) {
                    modalSelectedContexts = modalSelectedContexts.filter(c => c !== ctx);
                    e.target.classList.remove('bg-blue-600', 'text-white');
                } else {
                    modalSelectedContexts.push(ctx);
                    e.target.classList.add('bg-blue-600', 'text-white');
                }
            }
        });
        document.getElementById('modalEnergyButtons').addEventListener('click', e => {
            if (e.target.matches('.modal-energy-btn')) {
                modalSelectedEnergy = e.target.dataset.energy;
                document.querySelectorAll('.modal-energy-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
                e.target.classList.add('bg-blue-600', 'text-white');
            }
        });

        focusPauseBtn.onclick = () => {
          isPaused = !isPaused;
          focusPauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
        };
        focusStopBtn.onclick = () => stopFocusSession();
        focusCompleteBtn.onclick = () => window.app.markTaskDone(currentFocusTaskId);

        document.getElementById('exportBtn').onclick = () => {
            if (tasks.length === 0) return alert("No tasks to export!");
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tasks, null, 2));
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", "select_do_tasks.json");
            anchor.click();
        };
        document.getElementById('importBtn').onclick = () => document.getElementById('importFile').click();
        document.getElementById('importFile').onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = re => {
                try {
                    const imported = JSON.parse(re.target.result);
                    if (Array.isArray(imported)) {
                        tasks = imported; saveTasksToLocalStorage(); renderTasks(); alert('Tasks imported!');
                    } else throw new Error();
                } catch { alert('Import failed. Invalid file.'); }
            };
            reader.readAsText(file);
            e.target.value = null;
        };
      };

      // --- INITIALIZE APP ---
      renderFilterButtons();
      initializeEventListeners();
      renderTasks();
      renderCompletedTasks();
      applySmartDefaults();
    });
  </script>
</body>
</html>

