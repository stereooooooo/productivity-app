<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Select + Do</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <style>
    :root { font-family: 'Inter', sans-serif; }
    @supports (font-variation-settings: normal) {
      :root { font-family: 'Inter var', sans-serif; }
    }
    /* Simple fade-in animation for the suggested task card */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans overflow-x-hidden">

  <!-- Login Screen -->
  <div id="loginScreen" class="flex h-screen w-screen items-center justify-center">
    <div class="text-center p-8 bg-white rounded-xl shadow-md border border-slate-200">
        <img src="selectdologo.png" alt="Select + Do Logo" class="w-48 h-auto mb-6 mx-auto">
        <h1 class="text-2xl font-bold text-slate-800 mb-2">Welcome to Select + Do</h1>
        <p class="text-slate-500 mb-8">Sign in to continue to your personalized dashboard.</p>
        <button id="loginBtn" class="w-full flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg transition-colors text-base font-semibold">
            <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
            Sign in with Google
        </button>
    </div>
  </div>

  <!-- Main Application Wrapper -->
  <div id="mainApp" class="hidden flex-col md:flex-row md:h-screen">
    <!-- Sidebar -->
    <div class="w-full md:w-1/3 md:max-w-sm p-4 sm:p-6 bg-white border-r border-slate-200 flex flex-col shrink-0">
      <div class="flex justify-between items-center mb-6">
        <img src="selectdologo.png" alt="Select + Do Logo" class="w-36 h-auto">
        <div id="streakDisplay" class="flex items-center bg-slate-100 rounded-lg px-3 py-1.5">
            <!-- Streak content will be generated by JS -->
        </div>
      </div>
      <button id="addTaskBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg mb-4 transition-colors text-base font-semibold">
        + Add New Task
      </button>
      <div class="flex space-x-2 mb-4">
        <button id="exportBtn" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 rounded-lg transition-colors text-sm">Export</button>
        <button id="importBtn" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-2 rounded-lg transition-colors text-sm">Import</button>
      </div>
       <div class="mb-4">
        <input id="quickAddTaskInput" type="text" placeholder="Quick Add: task :15 #tag @ctx ^proj" class="w-full border border-slate-200 p-2 rounded-lg text-sm placeholder:text-slate-400" />
       </div>
      
      <div id="projectsContainer" class="space-y-4 overflow-y-auto flex-grow -mx-2 px-2">
        <!-- Projects and tasks will be rendered here -->
      </div>

       <div class="mt-4 pt-2 border-t border-slate-100">
         <input id="newProjectInput" type="text" placeholder="+ New Project" class="w-full border border-slate-200 p-2 rounded-lg text-sm placeholder:text-slate-400" />
       </div>

      <h2 class="font-semibold text-slate-900 border-b border-slate-100 pb-2 mb-2 mt-4">Completed Today</h2>
      <div id="completedTaskList" class="space-y-1 overflow-y-auto max-h-[50vh] md:max-h-full -mx-2 px-2">
        <!-- Completed tasks will be rendered here -->
      </div>
       <div id="userDisplay" class="mt-auto pt-4 border-t border-slate-100 flex items-center">
            <!-- User info and logout button will be here -->
       </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-4 md:p-8 md:overflow-y-auto max-w-4xl">
      <div class="mb-6 bg-white p-5 rounded-xl border border-slate-200">
        <h2 class="font-semibold text-slate-900 mb-3 text-lg">Find a task</h2>
        <div class="space-y-4">
            <div>
                <h3 class="font-medium text-slate-600 mb-2">1. How much time do you have?</h3>
                <div id="timeFilters" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
                <h3 class="font-medium text-slate-600 mb-2">2. Choose a context</h3>
                <div id="contextFilters" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
                <h3 class="font-medium text-slate-600 mb-2">3. What's your energy level?</h3>
                <div id="energyFilters" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <div class="flex flex-wrap gap-2 border-t border-slate-100 pt-4 mt-6">
          <button id="suggestTaskBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-lg transition-colors font-semibold">Suggest Tasks</button>
          <button id="surpriseMeBtn" class="bg-slate-700 hover:bg-slate-800 text-white px-5 py-2 rounded-lg transition-colors font-semibold">Surprise Me!</button>
          <button id="clearFiltersBtn" class="bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-lg transition-colors text-sm font-medium">Clear Filters</button>
        </div>
      </div>
      <div id="filteredTaskList" class="space-y-4">
          <!-- Suggested task will appear here -->
      </div>
    </div>
  </div>

  <!-- Modal for Adding/Editing Tasks -->
  <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50 p-4">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
      <h2 id="modalTitle" class="text-lg font-bold mb-4 text-slate-900">Add New Task</h2>
      <input id="taskName" type="text" placeholder="Task Name (e.g., 'Draft project proposal')" class="w-full mb-4 border border-slate-300 p-2 rounded-lg"/>
      
      <label class="block mb-2 font-medium text-slate-700">Project</label>
      <select id="projectSelect" class="w-full mb-4 border border-slate-300 p-2 rounded-lg bg-white"></select>

      <label class="block mb-2 font-medium text-slate-700">Time Required (minutes)</label>
      <div id="modalTimeButtons" class="flex flex-wrap gap-2 mb-4"></div>
      
      <label class="block mb-2 font-medium text-slate-700">Context</label>
      <div id="modalContextButtons" class="flex flex-wrap gap-2 mb-4"></div>

      <label class="block mb-2 font-medium text-slate-700">Energy Level</label>
      <div id="modalEnergyButtons" class="flex flex-wrap gap-2 mb-4"></div>
      
      <label class="block mb-2 font-medium text-slate-700">Tags (optional)</label>
      <input id="taskTags" type="text" placeholder="Type a tag and hit Enter" class="w-full mb-2 border border-slate-300 p-2 rounded-lg"/>
      <div id="tagPreview" class="flex flex-wrap gap-2 mb-4 min-h-[28px]"></div>
      
      <div class="flex justify-end space-x-2">
        <button id="cancelTaskBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors font-semibold">Cancel</button>
        <button id="saveTaskBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors font-semibold">Save Task</button>
      </div>
    </div>
  </div>

  <!-- Focus Mode Overlay -->
  <div id="focusOverlay" class="fixed inset-0 bg-white z-[100] flex flex-col justify-center items-center text-center hidden p-4">
    <h1 id="focusTaskName" class="text-3xl sm:text-4xl lg:text-5xl font-bold text-slate-800 mb-8"></h1>
    <div id="focusTimerDisplay" class="text-6xl sm:text-7xl lg:text-9xl font-mono font-bold text-blue-500 mb-12"></div>
    <div class="flex space-x-4">
        <button id="focusPauseBtn" class="w-32 sm:w-36 flex items-center justify-center bg-slate-100 hover:bg-slate-200 text-slate-700 text-lg font-semibold py-2 px-4 sm:py-3 sm:px-6 rounded-lg transition-colors">
            <svg id="pauseIcon" class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg>
            <svg id="playIcon" class="w-6 h-6 mr-2 hidden" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.647c1.295.748 1.295 2.538 0 3.286L8.029 20.99c-1.25.72-2.779-.217-2.779-1.643V5.653z" /></svg>
            <span id="focusPauseText">Pause</span>
        </button>
        <button id="focusStopBtn" class="w-32 sm:w-36 flex items-center justify-center bg-red-50 hover:bg-red-100 text-red-600 text-lg font-semibold py-2 px-4 sm:py-3 sm:px-6 rounded-lg transition-colors">
            <svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" /></svg>
            <span>Stop</span>
        </button>
    </div>
    <button id="focusCompleteBtn" class="hidden mt-8 bg-green-500 hover:bg-green-600 text-white text-lg font-semibold py-3 px-8 rounded-lg transition-colors flex items-center justify-center">
        <svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
        <span>Mark as Complete</span>
    </button>
  </div>
  
  <input type="file" id="importFile" class="hidden" accept=".json">

  <script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
    const firebaseConfig = {
      apiKey: "AIzaSyBOo5JsKHQ2ypvHuHpIiRR8sNFJutfMZVU",
      authDomain: "select-do.firebaseapp.com",
      projectId: "select-do",
      storageBucket: "select-do.firebasestorage.app",
      messagingSenderId: "800573168205",
      appId: "1:800573168205:web:40b27a550f9ba2e2b55a04"
    };

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    document.addEventListener('DOMContentLoaded', () => {
      // --- STATE MANAGEMENT ---
      let projects = [];
      let tasks = [];
      let completedTasks = [];
      let streakData = { currentStreak: 0, lastCompletedDate: null };

      let modalTagList = [];
      let modalSelectedTime = null;
      let modalSelectedContexts = [];
      let modalSelectedEnergy = null;
      let editingTaskId = null;

      let selectedTimeFilter = null;
      let selectedContextFilters = [];
      let selectedEnergyFilter = null;
      
      const energyLevels = ['Low 🧠', 'Medium 💪', 'High 🔥'];

      let timerInterval = null;
      let remainingSeconds = 0;
      let isPaused = false;
      let currentFocusTaskId = null;
      const originalTitle = document.title;
      
      let currentUser = null;
      let unsubscribeFromData = null; // To detach Firestore listener on logout


      // --- DOM ELEMENTS ---
      const loginScreen = document.getElementById('loginScreen');
      const mainApp = document.getElementById('mainApp');
      const projectsContainer = document.getElementById('projectsContainer');
      const completedTaskList = document.getElementById('completedTaskList');
      const filteredList = document.getElementById('filteredTaskList');
      const modalOverlay = document.getElementById('modalOverlay');
      const focusOverlay = document.getElementById('focusOverlay');
      const focusTaskName = document.getElementById('focusTaskName');
      const focusTimerDisplay = document.getElementById('focusTimerDisplay');
      const focusPauseBtn = document.getElementById('focusPauseBtn');
      const focusStopBtn = document.getElementById('focusStopBtn');
      const focusCompleteBtn = document.getElementById('focusCompleteBtn');

      // --- DATA HANDLING ---
      const saveDataToFirestore = async () => {
        if (!currentUser) return;
        const userDocRef = doc(db, 'users', currentUser.uid);
        try {
            await setDoc(userDocRef, { projects, tasks, completedTasks, streakData });
        } catch (error) {
            console.error("Error saving data: ", error);
        }
      };

      const loadDataFromFirestore = (userId) => {
        const userDocRef = doc(db, 'users', userId);
        unsubscribeFromData = onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                projects = data.projects || [{ id: "inbox", name: "Inbox" }];
                tasks = data.tasks || [];
                completedTasks = data.completedTasks || [];
                streakData = data.streakData || { currentStreak: 0, lastCompletedDate: null };
            } else {
                // First time user, create default data
                projects = [{ id: "inbox", name: "Inbox" }];
                tasks = [];
                completedTasks = [];
                streakData = { currentStreak: 0, lastCompletedDate: null };
                saveDataToFirestore(); // Save initial state
            }
            // Re-render the entire app with the new data
            renderAll();
        });
      };
      
      // A central function to re-render all dynamic parts of the UI
      const renderAll = () => {
        renderTasksAndProjects();
        renderCompletedTasks();
        initializeStreak();
      };
      
      // --- AUTHENTICATION ---
      const handleGoogleLogin = () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch(error => {
            console.error("Login failed: ", error);
        });
      };

      const handleLogout = () => {
        signOut(auth);
      };

      onAuthStateChanged(auth, user => {
        if (user) {
            // User is signed in
            currentUser = user;
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            mainApp.classList.add('flex');
            
            // Display user info
            document.getElementById('userDisplay').innerHTML = `
                <img src="${user.photoURL}" alt="User Photo" class="w-8 h-8 rounded-full mr-3">
                <div class="flex-grow">
                    <div class="font-semibold text-sm">${user.displayName}</div>
                    <div class="text-xs text-slate-500">${user.email}</div>
                </div>
                <button id="logoutBtn" class="ml-2 text-slate-400 hover:text-red-500">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>
                </button>
            `;
            document.getElementById('logoutBtn').onclick = handleLogout;
            loadDataFromFirestore(user.uid);

        } else {
            // User is signed out
            currentUser = null;
            if (unsubscribeFromData) unsubscribeFromData(); // Detach listener
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            mainApp.classList.remove('flex');
        }
      });
      
      const renderTasksAndProjects = () => {
        projectsContainer.innerHTML = '';
        projects.forEach(project => {
            const projectTasks = tasks.filter(task => task.projectId === project.id);
            if (project.id !== 'inbox' && projectTasks.length === 0) return;
            const projectDiv = document.createElement('div');
            projectDiv.className = 'project-group';
            const projectHeader = document.createElement('h3');
            projectHeader.className = 'font-semibold text-slate-900 mb-1';
            projectHeader.textContent = project.name;
            projectDiv.appendChild(projectHeader);
            if (projectTasks.length > 0) {
                projectTasks.forEach(task => {
                    const taskDiv = document.createElement('div');
                    taskDiv.className = 'group flex items-center p-2 rounded-lg hover:bg-slate-50';
                    taskDiv.innerHTML = `
                        <svg class="w-6 h-6 text-slate-300 mr-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <div class="flex-grow">
                          <div class="font-medium text-slate-800">${task.name}</div>
                          <div class="text-sm text-slate-500">${task.time} min • ${task.energy}</div>
                        </div>
                        <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                          <button data-task-id="${task.id}" class="edit-btn text-slate-400 hover:text-blue-500">
                            <svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                          </button>
                          <button data-task-id="${task.id}" class="delete-btn text-slate-400 hover:text-red-500">
                            <svg class="w-5 h-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                          </button>
                        </div>
                    `;
                    projectDiv.appendChild(taskDiv);
                });
            } else if (project.id === 'inbox') {
                const emptyStateDiv = document.createElement('div');
                emptyStateDiv.className = 'text-center text-slate-400 p-3 text-sm rounded-lg bg-slate-50';
                emptyStateDiv.textContent = 'All clear!';
                projectDiv.appendChild(emptyStateDiv);
            }
            projectsContainer.appendChild(projectDiv);
        });
      };
      
      const renderCompletedTasks = () => {
        const today = new Date().toISOString().slice(0, 10);
        const tasksCompletedToday = completedTasks.filter(task => task.completedAt && task.completedAt.slice(0, 10) === today);

        completedTaskList.innerHTML = '';
        if (tasksCompletedToday.length === 0) {
            completedTaskList.innerHTML = `<div class="text-center text-slate-500 p-4 bg-slate-50 rounded-lg mt-2 text-sm">No tasks completed yet today. You can do it!</div>`;
            return;
        }
        
        tasksCompletedToday.forEach(task => {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-3 p-2 text-slate-400';
            div.innerHTML = `
                <svg class="w-5 h-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg>
                <span class="line-through">${task.name}</span>
            `;
            completedTaskList.appendChild(div);
        });
      };

      const renderStreak = () => {
        const streakDisplay = document.getElementById('streakDisplay');
        const flameColor = streakData.currentStreak > 0 ? 'text-orange-500' : 'text-slate-400';
        streakDisplay.innerHTML = `
            <svg class="${flameColor} w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.369-2.23 8.287 8.287 0 003.369-2.23z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z" /></svg>
            <div class="ml-2 text-left">
                <span class="font-bold text-lg leading-none text-slate-700">${streakData.currentStreak}</span>
                <div class="text-xs leading-none text-slate-500">Day Streak</div>
            </div>
        `;
      };

       const populateProjectDropdown = () => {
        const projectSelect = document.getElementById('projectSelect');
        projectSelect.innerHTML = '';
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelect.appendChild(option);
        });
      };

      const resetModal = () => {
        document.getElementById('taskName').value = '';
        document.getElementById('taskTags').value = '';
        modalTagList = [];
        modalSelectedTime = null;
        modalSelectedContexts = [];
        modalSelectedEnergy = null;
        editingTaskId = null;
        document.getElementById('projectSelect').value = 'inbox';
        renderTagPreview();
        document.querySelectorAll('.modal-time-btn, .modal-context-btn, .modal-energy-btn').forEach(b => {b.classList.remove('bg-blue-500','text-white','border-blue-500');b.classList.add('bg-white','text-slate-700')});
      };
      const openModal = (mode = 'add') => {
        populateProjectDropdown();
        document.getElementById('modalTitle').textContent = mode === 'add' ? 'Add New Task' : 'Edit Task';
        modalOverlay.classList.remove('hidden');
      };
      const closeModal = () => {
        modalOverlay.classList.add('hidden');
        resetModal();
      };
      const renderTagPreview = () => {
        const tagDiv = document.getElementById('tagPreview');
        tagDiv.innerHTML = modalTagList.map((tag, i) => `
          <span class="bg-slate-200 text-slate-700 text-sm font-medium px-2 py-1 rounded-md flex items-center">
            ${tag}
            <button data-tag-index="${i}" class="remove-tag-btn ml-2 text-slate-400 hover:text-red-500 font-bold">&times;</button>
          </span>
        `).join('');
      };
      const saveTask = () => {
        const name = document.getElementById('taskName').value.trim();
        const projectId = document.getElementById('projectSelect').value;
        if (!name || !modalSelectedTime || modalSelectedContexts.length === 0 || !modalSelectedEnergy) {
          alert('Please provide a task name, time, context, and energy level.');
          return;
        }

        if (!editingTaskId) {
            const isDuplicate = tasks.some(task => task.name.toLowerCase() === name.toLowerCase());
            if (isDuplicate) {
                alert('A task with this name already exists. Please choose a different name.');
                return;
            }
        }

        if (editingTaskId) {
          const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
          if (taskIndex > -1) tasks[taskIndex] = { ...tasks[taskIndex], name, time: modalSelectedTime, contexts: [...modalSelectedContexts], energy: modalSelectedEnergy, tags: [...modalTagList], projectId };
        } else {
          tasks.push({ id: `task_${Date.now()}`, name, time: modalSelectedTime, contexts: [...modalSelectedContexts], energy: modalSelectedEnergy, tags: [...modalTagList], projectId });
        }
        saveDataToFirestore();
        closeModal();
      };
      
      const updateStreak = () => {
        const today = new Date();
        const todayStr = today.toISOString().slice(0, 10);
        if (streakData.lastCompletedDate === todayStr) return;
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().slice(0, 10);
        if (streakData.lastCompletedDate === yesterdayStr) {
            streakData.currentStreak++;
        } else {
            streakData.currentStreak = 1;
        }
        streakData.lastCompletedDate = todayStr;
        saveDataToFirestore();
      };

    const deleteTask = (taskId) => {
        if (confirm('Are you sure you want to delete this task?')) {
            tasks = tasks.filter(task => task.id !== taskId);
            saveDataToFirestore();
        }
    };
    const editTask = (taskId) => {
        resetModal();
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        editingTaskId = taskId;
        populateProjectDropdown();
        document.getElementById('projectSelect').value = task.projectId || 'inbox';
        document.getElementById('taskName').value = task.name;
        modalTagList = [...task.tags];
        modalSelectedTime = task.time;
        modalSelectedContexts = [...task.contexts];
        modalSelectedEnergy = task.energy;
        renderTagPreview();
        document.querySelectorAll('.modal-time-btn').forEach(btn => { if (parseInt(btn.dataset.time) === task.time) { btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); btn.classList.remove('bg-white','text-slate-700'); } });
        document.querySelectorAll('.modal-context-btn').forEach(btn => { if (task.contexts.includes(btn.dataset.context)) { btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); btn.classList.remove('bg-white','text-slate-700'); }});
        document.querySelectorAll('.modal-energy-btn').forEach(btn => { if (btn.dataset.energy === task.energy) { btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); btn.classList.remove('bg-white','text-slate-700'); }});
        openModal('edit');
    };
    const removeTag = (index) => {
        modalTagList.splice(index, 1);
        renderTagPreview();
    };
    const markTaskDone = (taskId) => {
        const taskIndex = tasks.findIndex(t => t.id === taskId);
        if (taskIndex > -1) {
            const completedTask = { ...tasks[taskIndex], completedAt: new Date().toISOString() };
            completedTasks.push(completedTask);
            tasks.splice(taskIndex, 1);
            updateStreak();
            saveDataToFirestore();
            
            const positiveMessages = ["Great job! ✨", "Awesome work! 🔥", "That's one step closer. 🚀", "Productivity unlocked! 🌟", "Amazing habit. 💪"];
            const message = positiveMessages[Math.floor(Math.random() * positiveMessages.length)];
            filteredList.innerHTML = `<div class="text-center text-green-600 p-4 bg-green-50 rounded-lg border border-green-200 shadow-sm">${message}</div>`;
            setTimeout(() => { if(filteredList.firstChild && filteredList.firstChild.textContent.includes(message)) filteredList.innerHTML = ''; }, 4000);
        }
        if (!focusOverlay.classList.contains('hidden')) {
            stopFocusSession(false);
        }
    };
    const startFocusSession = (taskId) => {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        currentFocusTaskId = taskId;
        remainingSeconds = task.time * 60;
        focusTaskName.textContent = task.name;
        updateTimerDisplay();
        
        document.getElementById('focusPauseText').textContent = 'Pause';
        document.getElementById('pauseIcon').classList.remove('hidden');
        document.getElementById('playIcon').classList.add('hidden');

        focusPauseBtn.classList.remove('hidden');
        focusStopBtn.classList.remove('hidden');
        focusCompleteBtn.classList.add('hidden');
        focusOverlay.classList.remove('hidden');
        startTimer();
    };
      
      const renderSuggestedTask = (task, isSurprise = false) => {
          const div = document.createElement('div');
          const baseClasses = 'bg-white border rounded-xl p-4 animate-fade-in flex items-center justify-between';
          div.className = isSurprise
              ? `${baseClasses} border-2 border-blue-500 shadow-lg`
              : `${baseClasses} border-slate-200`;
          
          div.innerHTML = `
              <div class="flex-grow">
                <h3 class="font-bold text-slate-900">${task.name}</h3>
                <p class="text-sm text-slate-500">Time: ${task.time} min | Energy: ${task.energy}</p>
                 <div class="flex flex-wrap gap-2 mt-2 ${task.tags.length === 0 ? 'hidden' : ''}">
                    ${task.tags.map(tag => `<span class="text-xs bg-slate-100 text-slate-600 font-medium px-2 py-1 rounded-md">${tag}</span>`).join('')}
                </div>
              </div>
              <button data-task-id="${task.id}" class="start-btn ml-4 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition-colors font-semibold shrink-0">Start</button>
          `;
          filteredList.appendChild(div);
      };

      const applyFiltersAndSuggest = (mode = 'suggest') => {
        filteredList.innerHTML = '';
        
        if (mode === 'surprise') {
            if (tasks.length === 0) {
                filteredList.innerHTML = `<div class="text-center text-slate-500 p-4 bg-white rounded-xl border border-slate-200">Add some tasks to be surprised!</div>`;
                return;
            }
            const taskToSuggest = tasks[Math.floor(Math.random() * tasks.length)];
            renderSuggestedTask(taskToSuggest, true);
        } else {
            const potentialTasks = tasks.filter(task => {
                const timeMatches = () => {
                  if (!selectedTimeFilter) return true;
                  let tolerance = 5;
                  if (selectedTimeFilter >= 30) tolerance = 10;
                  return task.time <= selectedTimeFilter + tolerance;
                };
                const contextMatches = selectedContextFilters.length === 0 || task.contexts.some(c => selectedContextFilters.includes(c));
                const energyMatches = () => {
                    if (!selectedEnergyFilter) return true;
                    const selectedEnergyIndex = energyLevels.indexOf(selectedEnergyFilter);
                    const taskEnergyIndex = energyLevels.indexOf(task.energy);
                    return taskEnergyIndex <= selectedEnergyIndex;
                };
                return timeMatches() && contextMatches && energyMatches();
            });

            if (potentialTasks.length > 0) {
                potentialTasks.forEach(task => renderSuggestedTask(task, false));
            } else {
                filteredList.innerHTML = `<div class="text-center text-slate-500 p-4 bg-white rounded-xl border border-slate-200">No tasks match your criteria. Try clearing the filters!</div>`;
            }
        }
      };
      
      const applySmartDefaults = () => {
        const now = new Date();
        const hour = now.getHours();
        const day = now.getDay();
        
        let defaultContext = null;
        if (day >= 1 && day <= 5) {
            if (hour >= 9 && hour < 17) defaultContext = 'Workday';
            else if (hour >=17 && hour < 22) defaultContext = 'Evening';
        } else {
            defaultContext = 'Weekend';
        }

        if (defaultContext) {
            const contextButton = document.querySelector(`.context-filter[data-context="${defaultContext}"]`);
            if (contextButton) {
                selectedContextFilters = [defaultContext];
                contextButton.classList.remove('bg-white', 'text-slate-700');
                contextButton.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
        }
      };

      const handleQuickAdd = (e) => {
        if (e.key !== 'Enter' || !e.target.value.trim()) return;

        let input = e.target.value;
        const timeRegex = /:(\d+)/;
        const tagRegex = /#(\w+)/g;
        const contextRegex = /@(\w+)/g;
        const projectRegex = /\^([\w\s]+)/;

        const timeMatch = input.match(timeRegex);
        const tagsMatch = [...input.matchAll(tagRegex)];
        const contextMatch = [...input.matchAll(contextRegex)];
        const projectMatch = input.match(projectRegex);
        
        let name = input.replace(timeRegex, '').replace(tagRegex, '').replace(contextRegex, '').replace(projectRegex, '').trim();

        if (!name) return;
        resetModal();
        populateProjectDropdown();
        document.getElementById('taskName').value = name;
        
        if (projectMatch) {
            const projectName = projectMatch[1].trim();
            let project = projects.find(p => p.name.toLowerCase() === projectName.toLowerCase());
            if (project) {
                document.getElementById('projectSelect').value = project.id;
            }
        }

        if (timeMatch) {
            modalSelectedTime = parseInt(timeMatch[1]);
            const btn = document.querySelector(`.modal-time-btn[data-time="${modalSelectedTime}"]`);
            if(btn) { btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); btn.classList.remove('bg-white', 'text-slate-700'); }
        }
        if (tagsMatch.length > 0) {
            modalTagList = tagsMatch.map(match => match[1]);
            renderTagPreview();
        }
        if (contextMatch.length > 0) {
            modalSelectedContexts = contextMatch.map(match => match[1].charAt(0).toUpperCase() + match[1].slice(1));
            modalSelectedContexts.forEach(context => {
                const btn = document.querySelector(`.modal-context-btn[data-context="${context}"]`);
                if(btn) { btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); btn.classList.remove('bg-white', 'text-slate-700'); }
            });
        }

        e.target.value = '';
        openModal('add');
      };
      
      const handleAddProject = (e) => {
        if (e.key !== 'Enter' || !e.target.value.trim()) return;
        const projectName = e.target.value.trim();
        if (projectName && !projects.find(p => p.name.toLowerCase() === projectName.toLowerCase())) {
            projects.push({ id: `proj_${Date.now()}`, name: projectName });
            saveDataToFirestore();
        }
        e.target.value = '';
      };
      
      const initializeStreak = () => {
        const today = new Date();
        const todayStr = today.toISOString().slice(0, 10);
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().slice(0, 10);

        if (streakData.lastCompletedDate && streakData.lastCompletedDate !== todayStr && streakData.lastCompletedDate !== yesterdayStr) {
            streakData.currentStreak = 0;
            streakData.lastCompletedDate = null;
            saveDataToFirestore();
        }
        renderStreak();
      };

      const renderFilterButtons = () => {
        const timeOptions = [5, 10, 15, 20, 25, 30, 45, 60];
        const contextOptions = ['Workday', 'Evening', 'Weekend', 'Home'];
        const energyOptions = ['Low 🧠', 'Medium 💪', 'High 🔥'];

        const createButtons = (opts, containerId, className, dataAttr) => {
            const container = document.getElementById(containerId);
            container.innerHTML = opts.map(opt => `<button data-${dataAttr}="${opt}" class="${className} bg-white border border-slate-200 text-slate-700 hover:bg-slate-100 px-3 py-1.5 rounded-lg transition-colors text-sm font-medium">${dataAttr === 'time' ? `${opt} min` : opt}</button>`).join('');
        };
        createButtons(timeOptions, 'timeFilters', 'time-filter', 'time');
        createButtons(contextOptions, 'contextFilters', 'context-filter', 'context');
        createButtons(energyOptions, 'energyFilters', 'energy-filter', 'energy');
        createButtons(timeOptions, 'modalTimeButtons', 'modal-time-btn', 'time');
        createButtons(contextOptions, 'modalContextButtons', 'modal-context-btn', 'context');
        createButtons(energyOptions, 'modalEnergyButtons', 'modal-energy-btn', 'energy');
      };
      
      const initializeEventListeners = () => {
        document.getElementById('loginBtn').onclick = handleGoogleLogin;
        document.getElementById('addTaskBtn').onclick = () => openModal('add');
        document.getElementById('suggestTaskBtn').onclick = () => applyFiltersAndSuggest('suggest');
        document.getElementById('surpriseMeBtn').onclick = () => applyFiltersAndSuggest('surprise');
        document.getElementById('clearFiltersBtn').onclick = () => {
          selectedTimeFilter = null; selectedContextFilters = []; selectedEnergyFilter = null;
          document.querySelectorAll('.time-filter, .context-filter, .energy-filter').forEach(b => {b.classList.remove('bg-blue-500','text-white','border-blue-500');b.classList.add('bg-white','text-slate-700')});
          filteredList.innerHTML = '';
        };
        document.getElementById('cancelTaskBtn').onclick = closeModal;
        document.getElementById('saveTaskBtn').onclick = saveTask;
        document.getElementById('taskTags').addEventListener('keypress', e => {
          if (e.key === 'Enter' && e.target.value.trim()) {
            e.preventDefault();
            if (!modalTagList.includes(e.target.value.trim())) modalTagList.push(e.target.value.trim());
            e.target.value = '';
            renderTagPreview();
          }
        });

        document.getElementById('quickAddTaskInput').addEventListener('keypress', handleQuickAdd);
        document.getElementById('newProjectInput').addEventListener('keypress', handleAddProject);
        
        const handleFilterClick = (containerId, selector, stateVarSetter) => {
            document.getElementById(containerId).addEventListener('click', e => {
                if (e.target.matches(selector)) {
                    document.querySelectorAll(selector).forEach(b => {
                        if (b !== e.target) {
                           b.classList.remove('bg-blue-500','text-white','border-blue-500');
                           b.classList.add('bg-white','text-slate-700');
                        }
                    });
                     e.target.classList.toggle('bg-blue-500');
                     e.target.classList.toggle('text-white');
                     e.target.classList.toggle('border-blue-500');
                     e.target.classList.toggle('bg-white');
                     e.target.classList.toggle('text-slate-700');
                    stateVarSetter(e.target);
                }
            });
        };
        handleFilterClick('timeFilters', '.time-filter', (el) => selectedTimeFilter = selectedTimeFilter === parseInt(el.dataset.time) ? null : parseInt(el.dataset.time));
        handleFilterClick('energyFilters', '.energy-filter', (el) => selectedEnergyFilter = selectedEnergyFilter === el.dataset.energy ? null : el.dataset.energy);
        
        document.getElementById('contextFilters').addEventListener('click', e => {
            if (e.target.matches('.context-filter')) {
                const context = e.target.dataset.context;
                const index = selectedContextFilters.indexOf(context);
                e.target.classList.toggle('bg-blue-500');
                e.target.classList.toggle('text-white');
                e.target.classList.toggle('border-blue-500');
                e.target.classList.toggle('bg-white');
                e.target.classList.toggle('text-slate-700');

                if (index > -1) {
                    selectedContextFilters.splice(index, 1);
                } else {
                    selectedContextFilters.push(context);
                }
            }
        });

        const handleModalButtonClick = (containerId, selector, stateVarSetter, isMultiSelect = false) => {
            document.getElementById(containerId).addEventListener('click', e => {
                if (e.target.matches(selector)) {
                    const value = selector.includes('time') ? parseInt(e.target.dataset.time) : e.target.dataset.context || e.target.dataset.energy;
                    
                    if (isMultiSelect) {
                        const stateArray = stateVarSetter();
                        const index = stateArray.indexOf(value);
                        if (index > -1) {
                            stateArray.splice(index, 1);
                            e.target.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                            e.target.classList.add('bg-white','text-slate-700');
                        } else {
                            stateArray.push(value);
                            e.target.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                            e.target.classList.remove('bg-white','text-slate-700');
                        }
                    } else {
                        stateVarSetter(value);
                        document.querySelectorAll(selector).forEach(b => {b.classList.remove('bg-blue-500','text-white','border-blue-500');b.classList.add('bg-white','text-slate-700')});
                        e.target.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                        e.target.classList.remove('bg-white','text-slate-700');
                    }
                }
            });
        };
        handleModalButtonClick('modalTimeButtons', '.modal-time-btn', (val) => modalSelectedTime = val);
        handleModalButtonClick('modalEnergyButtons', '.modal-energy-btn', (val) => modalSelectedEnergy = val);
        handleModalButtonClick('modalContextButtons', '.modal-context-btn', () => modalSelectedContexts, true);

        focusPauseBtn.onclick = () => {
          isPaused = !isPaused;
          document.getElementById('focusPauseText').textContent = isPaused ? 'Resume' : 'Pause';
          document.getElementById('pauseIcon').classList.toggle('hidden');
          document.getElementById('playIcon').classList.toggle('hidden');
        };
        focusStopBtn.onclick = () => stopFocusSession();
        focusCompleteBtn.onclick = () => markTaskDone(currentFocusTaskId);

        document.getElementById('exportBtn').onclick = () => {
            if (tasks.length === 0 && projects.length <= 1) return alert("No data to export!");
            const dataToExport = { projects, tasks, completedTasks, streakData };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport, null, 2));
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", "select_do_data.json");
            anchor.click();
        };
        document.getElementById('importBtn').onclick = () => document.getElementById('importFile').click();
        document.getElementById('importFile').onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = re => {
                try {
                    const data = JSON.parse(re.target.result);
                    if (Array.isArray(data.tasks) && Array.isArray(data.projects)) {
                        projects = data.projects;
                        tasks = data.tasks;
                        completedTasks = data.completedTasks || [];
                        streakData = data.streakData || { currentStreak: 0, lastCompletedDate: null };
                        saveDataToFirestore();
                        alert('Data imported!');
                    } else throw new Error();
                } catch { alert('Import failed. Invalid file.'); }
            };
            reader.readAsText(file);
            e.target.value = null;
        };

        // Event Delegation for dynamic buttons
        projectsContainer.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-btn');
            const deleteButton = e.target.closest('.delete-btn');
            if (editButton) {
                editTask(editButton.dataset.taskId);
            }
            if (deleteButton) {
                deleteTask(deleteButton.dataset.taskId);
            }
        });
        
        filteredList.addEventListener('click', (e) => {
            const startButton = e.target.closest('.start-btn');
            if (startButton) {
                startFocusSession(startButton.dataset.taskId);
            }
        });

        document.getElementById('tagPreview').addEventListener('click', (e) => {
             const removeButton = e.target.closest('.remove-tag-btn');
            if (removeButton) {
                removeTag(parseInt(removeButton.dataset.tagIndex));
            }
        });

      };

      // --- INITIALIZE APP ---
      renderFilterButtons();
      initializeEventListeners();
      // Initial renders will be triggered by onAuthStateChanged -> loadDataFromFirestore
    });
  </script>
</body>
</html>

